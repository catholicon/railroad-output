<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Understanding the node state model</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../security/overview.html" title="Security">Security</a></li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>The Node State Model</a>
  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  --><h1>Understanding the node state model</h1>
<p>This article describes the <i>node state model</i> that is the core design abstraction inside the <tt>oak-core</tt> component. Understanding the node state model is essential to working with Oak internals and to building custom Oak extensions.</p>
<div class="section">
<h2><a name="Background"></a>Background</h2>
<p>Oak organizes all content in a large tree hierarchy that consists of nodes and properties. Each snapshot or revision of this content tree is immutable, and changes to the tree are expressed as a sequence of new revisions. The NodeStore of an Oak repository is responsible for managing the content tree and its revisions.</p>
<p>The node state model as expressed in the NodeState interface in oak-core is designed for these purposes. It provides a unified low-level abstraction for managing all tree content and lays the foundation for the higher-level Oak API that&#x2019;s visible to clients.</p></div>
<div class="section">
<h2><a name="The_state_of_a_node"></a>The state of a node</h2>
<p>A <i>node</i> in Oak is an unordered collection of named properties and child nodes. As the content tree evolves through a sequence of revisions, a node in it will go through a series of different states. A <i>node state</i> then is an <i>immutable</i> snapshot of a specific state of a node and the subtree beneath it.</p>
<p>As an example, the following diagram shows two revisions of a content tree, the first revision consists of five nodes, and in the second revision a sixth node is added in one of the subtrees. Note how unmodified subtrees can be shared across revisions, while only the modified nodes and their ancestors up to the root (shown in yellow) need to be updated to reflect the change. This way both revisions remain readable at all times without the implementation having to make a separate copy of the entire repository for each revision.</p>
<p><img src="nodestate-r1.png?raw=true" alt="two revisions of a content tree" /></p>
<p>To avoid making a special case of the root node and therefore to make it easy to write algorithms that can recursively process each subtree as a standalone content tree, a node state is <i>unnamed</i> and does not contain information about it&#x2019;s location within a larger content tree. Instead each property and child node state is uniquely named within a parent node state. An algorithm that needs to know the path of a node can construct it from the encountered names as it descends the tree structure.</p>
<p>Since node states are immutable, they are also easy to keep <i>thread-safe</i>. Implementations that use mutable data structures like caches or otherwise aren&#x2019;t thread-safe by default, are expected to use other mechanisms like synchronization to ensure thread-safety.</p></div>
<div class="section">
<h2><a name="The_NodeState_interface"></a>The NodeState interface</h2>
<p>The above design principles are reflected in the <tt>NodeState</tt> interface in the <tt>org.apache.jackrabbit.oak.spi.state</tt> package of <tt>oak-core</tt>. The interface consists of three sets of methods:</p>

<ul>
  
<li>Methods for accessing properties</li>
  
<li>Methods for accessing child nodes</li>
  
<li>The <tt>exists</tt> method for checking whether the node exists or is accessible</li>
  
<li>The <tt>builder</tt> method for building modified states</li>
  
<li>The <tt>compareAgainstBaseState</tt> method for comparing states</li>
</ul>
<p>You can request a property or a child node by name, get the number of properties or child nodes, or iterate through all of them. Even though properties and child nodes are accessed through separate methods, they share the same namespace so a given name can either refer to a property or a child node, but not to both at the same time.</p>
<p>Iteration order of properties and child nodes is <i>unspecified but stable</i>, so that re-iterating through the items of a <i>specific NodeState instance</i> will return the items in the same order as before, but the specific ordering is not defined nor does it necessarily remain the same across different instances.</p>
<p>The last three methods, <tt>exists</tt>, <tt>builder</tt> and <tt>compareAgainstBaseState</tt>, are covered in the next sections. See also the <tt>NodeState</tt> javadocs for more details about this interface and all its methods.</p></div>
<div class="section">
<h2><a name="Existence_and_iterability_of_node_states"></a>Existence and iterability of node states</h2>
<p>The <tt>exists</tt> method makes it possible to always traverse any path regardless of whether the named content exists or not. The <tt>getChildNode</tt> method returns a child <tt>NodeState</tt> instance for any given name, and the caller is expected to use the <tt>exists</tt> method to check whether the named node actually does exist. The purpose of this feature is to allow paths like <tt>/foo/bar</tt> to be traversed even if the current user only has read access to the <tt>bar</tt> node but not its parent <tt>foo</tt>. As a consequence it&#x2019;s even possible to access content like a fictional <tt>/bar</tt> subtree that doesn&#x2019;t exist at all. A piece of code for accessing such content could look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">NodeState root = ...;

NodeState foo = root.getChildNode(&quot;foo&quot;);
assert !foo.exists();
NodeState bar = foo.getChildNode(&quot;bar&quot;);
assert bar.exists();

NodeState baz = root.getChildNode(&quot;baz&quot;);
assert !baz.exists();
</pre></div></div>
<p>The following diagram illustrates such a content tree, both as the raw content that simply exists and as an access controlled view of that tree:</p>
<p><img src="nodestate-r2.png?raw=true" alt="content tree with and without access control" /></p>
<p>If a node is missing, i.e. its <tt>exists</tt> method returns <tt>false</tt> and thus it either does not exist at all or is read-protected, one can&#x2019;t list any of its properties or child nodes. And on the other hand, a non-readable node or property will only show up when listing the child nodes or properties of its parent. In other words, a node or a property is <i>iterable</i> only if both it and its parent are readable. For example, attempts to list properties or child nodes of the node <tt>foo</tt> will show up empty:</p>

<div class="source">
<div class="source"><pre class="prettyprint">assert !foo.getProperties().iterator().hasNext();
assert !foo.getChildNodeEntries().iterator().hasNext();
</pre></div></div>
<p>Note that without some external knowledge about the accessibility of a child node like <tt>bar</tt> there&#x2019;s no way for a piece of code to distinguish between the existing but non-readable node <tt>foo</tt> and the non-existing node <tt>baz</tt>.</p></div>
<div class="section">
<h2><a name="Building_new_node_states"></a>Building new node states</h2>
<p>Since node states are immutable, a separate builder interface, <tt>NodeBuilder</tt>, is used to construct new, modified node states. Calling the <tt>builder</tt> method on a node state returns such a builder for modifying that node and the subtree below it.</p>
<p>A node builder can be thought of as a <i>mutable</i> version of a node state. In addition to property and child node access methods like the ones that are already present in the <tt>NodeState</tt> interface, the <tt>NodeBuilder</tt> interface contains the following key methods:</p>

<ul>
  
<li>The <tt>setProperty</tt> and <tt>removeProperty</tt> methods for modifying properties</li>
  
<li>The <tt>getChildNode</tt> method for accessing or modifying an existing subtree</li>
  
<li>The <tt>setChildNode</tt> and <tt>removeChildNode</tt> methods for adding, replacing or removing a subtree</li>
  
<li>The <tt>exists</tt> method for checking whether the node represented by a builder exists or is accessible</li>
  
<li>The <tt>getNodeState</tt> method for getting a frozen snapshot of the modified content tree</li>
</ul>
<p>All the builders acquired from the same root builder instance are linked so that changes made through one instance automatically become visible in the other builders. For example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">NodeBuilder rootBuilder = root.builder();
NodeBuilder fooBuilder = rootBuilder.getChildNode(&quot;foo&quot;);
NodeBuilder barBuilder = fooBuilder.getChildNode(&quot;bar&quot;);

assert !barBuilder.getBoolean(&quot;x&quot;);
fooBuilder.getNodeChild(&quot;bar&quot;).setProperty(&quot;x&quot;, Boolean.TRUE);
assert barBuilder.getBoolean(&quot;x&quot;);

assert barBuilder.exists();
fooBuilder.removeChildNode(&quot;bar&quot;);
assert !barBuilder.exists();
</pre></div></div>
<p>The <tt>getNodeState</tt> method returns a frozen, immutable snapshot of the current state of the builder. Providing such a snapshot can be somewhat expensive especially if there are many changes in the builder, so the method should generally only be used as the last step after all intended changes have been made. Meanwhile the accessors in the <tt>NodeBuilder</tt> interface can be used to provide efficient read access to the current state of the tree being modified.</p>
<p>The node states constructed by a builder often retain an internal reference to the base state used by the builder. This allows common node state comparisons to perform really well as described in the next section.</p></div>
<div class="section">
<h2><a name="Comparing_node_states"></a>Comparing node states</h2>
<p>As a node evolves through a sequence of states, it&#x2019;s often important to be able to tell what has changed between two states of the node. This functionality is available through the <tt>compareAgainstBaseState</tt> method. The method takes two arguments:</p>

<ul>
  
<li>A <i>base state</i> for the comparison. The comparison will report all changes necessary for moving from the given base state to the node state on which the comparison method is invoked.</li>
  
<li>A <tt>NodeStateDiff</tt> instance to which all detected changes are reported. The diff interface contains callback methods for reporting added, modified or removed properties or child nodes.</li>
</ul>
<p>The comparison method can actually be used to compare any two nodes, but the implementations of the method are typically heavily optimized for the case when the given base state actually is an earlier version of the same node. In practice this is by far the most common scenario for node state comparisons, and can typically be executed in <tt>O(d)</tt> time where <tt>d</tt> is the number of changes between the two states. The fallback strategy for comparing two completely unrelated node states can be much more expensive.</p>
<p>An important detail of the <tt>NodeStateDiff</tt> mechanism is the <tt>childNodeChanged</tt> method that will get called if there can be <i>any</i> changes in the subtree starting at the named child node. The comparison method should thus be able to efficiently detect differences at any depth below the given nodes. On the other hand the <tt>childNodeChanged</tt> method is called only for the direct child node, and the diff implementation should explicitly recurse down the tree if it wants to know what exactly did change under that subtree. The code for such recursion typically looks something like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">public void childNodeChanged(
        String name, NodeState before, NodeState after) {
    after.compareAgainstBaseState(before, ...);
}
</pre></div></div>
<p>Note that for performance reasons it&#x2019;s possible for the <tt>childNodeChanged</tt> method to be called in some cases even if there actually are no changes within that subtree. The only hard guarantee is that if that method is <i>not</i> called for a subtree, then that subtree definitely has not changed, but in most common cases the <tt>compareAgainstBaseState</tt> implementation can detect such cases and thus avoid extra <tt>childNodeChanged</tt> calls. However it&#x2019;s important that diff handlers are prepared to deal with such events.</p></div>
<div class="section">
<h2><a name="The_commit_hook_mechanism"></a>The commit hook mechanism</h2>
<p>A repository typically has various constraints to control what kind of content is allowed. It often also wants to annotate content changes with additional modifications like adding auto-created content or updating in-content indices. The <i>commit hook mechanism</i> is designed for these purposes. An Oak instance has a list of commit hooks that it applies to all commits. A commit hook is in full control of what to do with the commit: it can reject the commit, pass it through as-is, or modify it in any way.</p>
<p>All commit hooks implement the <tt>CommitHook</tt> interface that contains just a single <tt>processCommit</tt> method:</p>

<div class="source">
<div class="source"><pre class="prettyprint">NodeState processCommit(NodeState before, NodeState after)
    throws CommitFailedException;
</pre></div></div>
<p>The <tt>before</tt> state is the original revision on which the content changes being committed are based, and the <tt>after</tt> state contains all those changes. A <tt>after.compareAgainstBaseState(before, ...)</tt> call can be used to find out the exact set of changes being committed.</p>
<p>If, based on the content diff or some other inspection of the commit, a hook decides to reject the commit for example due to a constraint violation, it can do so by throwing a <tt>CommitFailedException</tt> with an appropriate error code as outlined in <a class="externalLink" href="http://wiki.apache.org/jackrabbit/OakErrorCodes">http://wiki.apache.org/jackrabbit/OakErrorCodes</a>.</p>
<p>If the commit is acceptable, the hook can return the after state as-is or it can make some additional modifications and return the resulting node state. The returned state is then passed as the after state to the next hook until all the hooks have had a chance to process the commit. The resulting final node state is then persisted as a new revision and made available to other Oak clients.</p></div>
<div class="section">
<h2><a name="Commit_editors"></a><a name="commit-editors"></a> Commit editors</h2>
<p>In practice most commit hooks are interested in the content diff as returned by the <tt>compareAgainstBaseState</tt> call mentioned above. This call can be somewhat expensive especially for large commits, so it&#x2019;s not a good idea for multiple commit hooks to each do a separate diff. A more efficient approach is to do the diff just once and have multiple hooks process it in parallel. The <i>commit editor mechanism</i> is used for this purpose. An editor is essentially a commit hook optimized for processing content diffs.</p>
<p>Instead of a list of separate hooks, the editors are all handled by a single <tt>EditorHook</tt> instance. This hook handles the details of performing the content diff and notifying all available editors about the detected content changes. The editors are provided by a list of <tt>EditorProvider</tt> instances that implement the following method:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Editor getRootEditor(
    NodeState before, NodeState after, NodeBuilder builder)
    throws CommitFailedException;
</pre></div></div>
<p>Instead of comparing the given before and after states directly, the provider is expected to return an <tt>Editor</tt> instance to be used for the comparison. The before and after states are passed to this method so that the provider can collect generic information like node type definitions that is needed to construct the returned editor.</p>
<p>The given <tt>NodeBuilder</tt> instance can be used by the returned editor to make modifications based on the detected content changes. The builder is based on the after state, but it is shared by multiple editors so during the diff processing it might no longer exactly match the after state. Editors within a single editor hook should generally not attempt to make conflicting changes.</p>
<p>The <tt>Editor</tt> interface is much like the <tt>NodeStateDiff</tt> interface described earlier. The main differences are that all the editor methods are allowed to throw <tt>CommitFailedExceptions</tt> and that the child node modification methods all return a further <tt>Editor</tt> instance.</p>
<p>The idea is that each editor <i>instance</i> is normally used for observing the changes to just a single node. When there are changes to a subtree below that node, the relevant child node modification method is expected to return a new editor instance for observing changes in that subtree. The editor hook keeps track of these returned &#x201c;sub-editors&#x201d; and recursively notifies them of changes in the relevant subtrees.</p>
<p>If an editor is not interested in changes inside a particular subtree it can return <tt>null</tt> to notify the editor hook that there&#x2019;s no need to recurse down that subtree. And if the effect of an editor isn&#x2019;t tied to the location of the changes within the content tree, it can just return itself. A good example is a name validator that simply checks the validity of all names regardless of where they&#x2019;re stored. If the location is relevant, for example when you need to keep track of the path of the changed node, you can store that information as internal state of the returned editor instance.</p></div>
<div class="section">
<h2><a name="Commit_validators"></a>Commit validators</h2>
<p>As mentioned, a common use for commit hooks is to verify that all content changes preserve the applicable constraints. For example the repository may want to enforce the integrity of reference properties, the constraints defined in node types, or simply the well-formedness of the names used. Such validation is typically based on the content diff of a commit, so the editor mechanism is a natural match. Additionally, since validation doesn&#x2019;t imply any further content modifications, the editor mechanism can be further restricted for this particular case.</p>
<p>The abstract <tt>ValidatorProvider</tt> class and the related <tt>Validator</tt> interface are based on the respective editor interfaces. The main difference is that the validator provider drops the <tt>NodeBuilder</tt> argument to make it impossible for any validators to even accidentally modify the commit being processed. Thus, even though there&#x2019;s no performance benefit to using the <tt>Validator</tt> interface instead of <tt>Editor</tt>, it&#x2019;s a good idea to do so whenever possible to make the intention of your code clearer.</p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
