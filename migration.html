<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Repository migration</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="./"  title="Oak logo"><img src="oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="license.html" title="License">License</a></li>
            <li><a href="downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="security/overview.html" title="Security">Security</a></li>
            <li><a href="features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="migration.html" title="Migration">Migration</a></li>
            <li><a href="differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="participating.html" title="Participating">Participating</a></li>
            <li><a href="developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Migration</a>
  </li>
    <li><a href="differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at
 
 http://www.apache.org/licenses/LICENSE-2.0
 
 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 --><h1>Repository migration</h1>
<p>Oak offers a few tools which can be used to migrate the old, Jackrabbit 2 repository and also to copy content between Oak instances. <tt>oak-upgrade</tt> is a Swiss army knife for copying content between virtually any repositories. On the other hand, the <tt>SplitBlobStore</tt> allows to copy the binaries gradually, from one blob store to another, without having a long repository downtime.</p>
<div class="section">
<h2><a name="Offline_migration_using_oak-upgrade"></a>Offline migration using oak-upgrade</h2>
<p><img src="img/migration-general.png" alt="oak-upgrade chart" /></p>
<p>The <tt>oak-upgrade</tt> module allows to do an upgrade from the classic Jackrabbit 2.0 repository to the Oak node store and also to sidegrade from one nodestore type to another. Besides from that it has a number of features that can be useful in everyday system maintenance:</p>

<ul>
  
<li>copying only a selcted subtree from one repository to another,</li>
  
<li>precise control over version histories migration,</li>
  
<li>migrating binaries from one blobstore to another.</li>
</ul>
<div class="section">
<h3><a name="Sidegrade"></a>Sidegrade</h3>
<p><tt>oak-upgrade</tt> module creates an executable jar file. It can be invoked like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar [options] source destination
</pre></div></div>
<p>The <tt>source</tt> and <tt>destination</tt> are the node store paths/URIs. Following node stores are supported:</p>

<ul>
  
<li><tt>SegmentNodeStore</tt> - use a path to the <tt>repository</tt> directory,</li>
  
<li>old <tt>SegmentNodeStore</tt> (Oak &lt; 1.6) - use the <tt>segment-old:</tt> prefix and the path to the <tt>repository</tt> directory,</li>
  
<li><tt>DocumentNodeStore</tt> with MongoDB - <tt>mongodb://host:port/database</tt>,</li>
  
<li><tt>DocumentNodeStore</tt> with a RDB - <tt>jdbc:...</tt>. It requires passing user and password with separate parameters.</li>
</ul>
<p>Following parameters should be used for the JDBC node store:</p>

<ul>
  
<li>Source database: <tt>--src-password=... --src-user=...</tt></li>
  
<li>Desination database: <tt>--user=... --password=...</tt></li>
</ul>
<p>Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    path/to/the/repository \
    mongodb://localhost:27017/oak

java -jar oak-upgrade-*.jar \
    --user=sa --password=sa \
    mongodb://localhost:27017/oak \
    jdbc:h2:path/to/repo
</pre></div></div></div>
<div class="section">
<h3><a name="Upgrade"></a>Upgrade</h3>
<p>In order to upgrade Jackrabbit 2 repository to the new node store, pass the path to the <tt>repository</tt> directory as the <tt>source</tt> parameter. Optionally, you may also pass the path to the <tt>repository.xml</tt> file as a separate parameter. Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    path/to/the/jr2/repository \
    path/to/repository.xml \
    path/to/the/new/repository

java -jar oak-upgrade-*.jar \
    path/to/the/jr2/repository \
    mongodb://localhost:27017/oak
</pre></div></div></div>
<div class="section">
<h3><a name="Migrating_blob_store"></a>Migrating blob store</h3>
<p>By default, the <tt>oak-upgrade</tt> only copies the binary references, so you need to reuse the same blob/data store in the new repository. However, it&#x2019;s also possible to migrate binaries as well using the <tt>--copy-binaries</tt> parameter. Following migration paths are possible for the binaries. The <i>internal</i> means that the binaries are stored inside the segment or document node store:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">From &#x2193; To &#x2192; </th>
      
<th align="center">Internal </th>
      
<th align="center">FileBlobStore </th>
      
<th align="center">FileDataStore </th>
      
<th align="center">S3 </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">Internal </td>
      
<td align="center">Yes&#xb2; </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
    </tr>
    
<tr class="a">
      
<td align="center">FileBlobStore </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes&#xb2; </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
    </tr>
    
<tr class="b">
      
<td align="center">FileDataStore </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes&#xb2; </td>
      
<td align="center">Yes (not recommended)&#xb9; </td>
    </tr>
    
<tr class="a">
      
<td align="center">S3 </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes </td>
      
<td align="center">Yes&#xb2; </td>
    </tr>
  </tbody>
</table>
<p>&#xb9; The S3DataStore will take care of this migration automatically, no need to use oak-upgrade <br /> &#xb2; The storage might be simple cloned without using oak2oak</p>
<p>Following parameters can be used to define the source and the destination blob stores:</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th align="center">Blob store type </th>
      
<th align="center">Source parameter </th>
      
<th align="center">Destination </th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td align="center">FileBlobStore </td>
      
<td align="center"><tt>--src-fileblobstore=...</tt> </td>
      
<td align="center"><tt>--fileblobstore=...</tt> </td>
    </tr>
    
<tr class="a">
      
<td align="center">FileDataStore </td>
      
<td align="center"><tt>--src-datastore=...</tt> </td>
      
<td align="center"><tt>--datastore=...</tt> </td>
    </tr>
    
<tr class="b">
      
<td align="center">S3 </td>
      
<td align="center"><tt>--src-s3config=... --src-s3datastore=...</tt> </td>
      
<td align="center"><tt>--s3config=... --s3datastore=...</tt> </td>
    </tr>
  </tbody>
</table>
<p>Use the <tt>--copy-binaries</tt> parameter to instruct the <tt>oak-upgrade</tt> to copy binaries.</p>
<p>Example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    --copy-binaries \
    --src-datastore=/old/repository/datastore \
    --fileblobstore=/new/repository/datastore \
    /old/repository \
    /new/repository
</pre></div></div>
<div class="section">
<h4><a name="S3_configuration"></a>S3 configuration</h4>
<p>Using S3DataStore as a source or destination for binaries requires passing two arguments: <tt>s3datastore</tt> and <tt>s3config</tt>. The first one should point to the datastore directory (eg. <tt>crx-quickstart/repository/datastore</tt>). The second should be used to define the <tt>org.apache.jackrabbit.oak.plugins.blob.datastore.S3DataStore.cfg</tt> configuration file path. File should have following format:</p>

<div class="source">
<div class="source"><pre class="prettyprint">accessKey=...
secretKey=...
s3Bucket=...
s3Region=eu-west-1
s3EndPoint=s3-eu-west-1.amazonaws.com

connectionTimeout=120000
socketTimeout=120000
maxConnections=40
writeThreads=30
maxErrorRetry=10
</pre></div></div>
<p>For the region and endpoints please visit the <a class="externalLink" href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">Amazon documentation</a>.</p>
<p>Alternativly the <tt>*.config</tt> file format, described on the <a class="externalLink" href="https://sling.apache.org/documentation/bundles/configuration-installer-factory.html#configuration-files">Apache Sling website</a>, can be used as it may be convenient for re-using existing OSGi configuration files. </p></div></div>
<div class="section">
<h3><a name="Migrating_a_subtree"></a>Migrating a subtree</h3>
<p><img src="img/migration-paths.png" alt="&ndash;include-paths chart" /></p>
<p>It&#x2019;s possible to define a list of content subtrees to include or exclude during the migration. By default, the whole repository gets copied. In order to copy only a subtree, use the <tt>--include-paths</tt>. For example, the following command will copy only the <tt>/content/site</tt> and <tt>/content/other_site</tt> subtrees:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    --include-paths=/content/site,/content/other_site \
    /old/repository \
    /new/repository
</pre></div></div>
<p>You may also exclude specific paths from being copied. Following command will copy the whole content without the <tt>/content/redundant_site</tt>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    --exclude-paths=/content/redundant_site \
    /old/repository \
    /new/repository
</pre></div></div>
<p>By default, the source repository replaces the destination repository (if there&#x2019;s one). For instance, in the first example if the <tt>/content/site</tt> node already exists in the destination repository, it&#x2019;ll be removed and replaced by the source node. It&#x2019;s also possible to merge content from the source repository with <tt>--merge-paths</tt>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-upgrade-*.jar \
    --include-paths=/content/site \
    --merge-paths=/content/site \
    /old/repository \
    /new/repository
</pre></div></div>
<p>Please notice that in the last example it&#x2019;s necessary to narrow the migration scope using <tt>--include-paths</tt> parameter.</p></div>
<div class="section">
<h3><a name="Version_history_copying"></a>Version history copying</h3>
<p><img src="img/migration-version.png" alt="Version copy chart" /></p>
<p>By default, the whole version storage is migrated. This includes referenced version histories (their versionable node still exists in the repository) and orphaned ones (their versionable node no longer exists). <tt>oak-upgrade</tt> allows to skip the orphaned version histories to make the migration faster and the destination repository smaller. It&#x2019;s also possible to define a maximum age for the version histories (both referenced and orphaned) to be copied.</p>
<p>There are two parameters: <tt>--copy-orphaned-versions</tt> and <tt>--copy-versions</tt>. Both accepts boolean values or a <tt>YYYY-MM-DD</tt> date. Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint"># only copy referenced versions
java -jar oak-upgrade-*.jar \
    --copy-orphaned-versions=false \
    /old/repository /new/repository

# don't copy any versions at all
java -jar oak-upgrade-*.jar \
    --copy-versions=false \
    /old/repository /new/repository

# copy referenced versions created after 2010
# and orphaned version created after 2011
java -jar oak-upgrade-*.jar \
    --copy-versions=2010-01-01 \
    --copy-orphaned-versions=2011-01-01 \
    /old/repository /new/repository
</pre></div></div></div>
<div class="section">
<h3><a name="Incremental_migration"></a>Incremental migration</h3>
<p>If an existing repository is passed as the destination, then only a diff between source and destination will be migrated. It allows to migrate the content in a few iterations. For instance, following case is possible:</p>

<ol style="list-style-type: decimal">
  
<li>migrate a large repository a week before go-live</li>
  
<li>run the migration again every night (only the recent changes are copied)</li>
  
<li>run the migration one final time before go-live</li>
</ol></div>
<div class="section">
<h3><a name="Interrupting_the_migration"></a>Interrupting the migration</h3>
<p>The migration might be stop at any time using <tt>^C</tt>. Resume the migration running the same command which was used to start it.</p></div>
<div class="section">
<h3><a name="Custom_initializers_and_commit_hooks"></a>Custom initializers and commit hooks</h3>
<p>It&#x2019;s possible to inject custom logic into the upgrade process, by implementing <a class="externalLink" href="https://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/spi/lifecycle/RepositoryInitializer.html"><tt>RepositoryInitializer</tt></a> or <a class="externalLink" href="https://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/spi/commit/CommitHook.html"><tt>CommitHook</tt></a>.</p>
<p>In order to do that, create a new Maven project, with appropriate implementation. Then create following file:</p>

<div class="source">
<div class="source"><pre class="prettyprint">src/main/resources/META-INF/services/org.apache.jackrabbit.oak.spi.commit.CommitHook
</pre></div></div>
<p>The file should contain just one line - the name of the class with the <tt>CoomitHook</tt> implementation. Build the project and attach the JAR to the oak-upgrade class path:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -cp my-commit-hook.jar:oak-upgrade-*.jar org.apache.jackrabbit.oak.upgrade.cli.OakUpgrade [normal oak-upgrade parameters]
</pre></div></div>
<p>A custom <tt>RepositoryInitializer</tt> can be injected in a similar way.</p></div>
<div class="section">
<h3><a name="Other_parameters"></a>Other parameters</h3>
<p>The full list of supported parameters can be displayed using <tt>--help</tt> switch.</p></div>
<div class="section">
<h3><a name="Checkpoints_migration"></a>Checkpoints migration</h3>
<p>When migrating an old SegmentMK repository (pre-Oak 1.6) to the new SegmentMK (Oak &gt;= 1.6), the checkpoints are migrated as well. This allows to avoid reindexing when the Oak is being run for the first time on the new repository. However, the checkpoints won&#x2019;t be migrated in following cases:</p>

<ul>
  
<li>custom include-, exclude- or merge- paths are specified or</li>
  
<li>the binaries are copied by references, no source datastore is specified and two different checkpoints contains different binary under the same path.</li>
</ul>
<p>In the second case oak-upgrade emits following warning and breaks:</p>

<div class="source">
<div class="source"><pre class="prettyprint">Checkpoints won't be copied, because no external datastore has been specified. This will result in the full repository reindexing on the first start. Use --skip-checkpoints to force the migration or see https://jackrabbit.apache.org/oak/docs/migration.html#Checkpoints_migration for more info.
</pre></div></div>
<p>The easiest way to fix this issue is specifying the source datastore in the command line options (eg. <tt>--src-datastore</tt> or <tt>--src-s3datastore</tt>).</p>
<p>The warning may also be ignored, but in this case the repository will be fully reindexed on the first startup. It may be a long process, especially for the big instance. Repository won&#x2019;t be usable until the reindexing process is done. Use <tt>--skip-checkpoints</tt> option to suppress the warning. </p></div></div>
<div class="section">
<h2><a name="Online_blob_migration_with_SplitBlobStore"></a>Online blob migration with SplitBlobStore</h2>
<p>Oak offers one more way to migrate blob store, without turning off the instance (a few restarts might be required, but the migration process is done during normal repository operation).</p>
<p>There is a <tt>SplitBlobStore</tt> implementation, that takes two blob stores: the old (already existing) and the new (empty) one. After configuring Oak to use it, all write requests are proxied to the new repository. The read requests uses the old or the new repository, depending on the blob id (<tt>SplitBlobStore</tt> saves all the new blob ids).</p>
<p>Besides from the new blob store implementation, there is a process (controlled by JMX) which migrates binaries between stores. When all binaries are migrated, the <tt>SplitBlobStore</tt> can be disabled as well as the old store.</p>
<div class="section">
<div class="section">
<h4><a name="Requirements"></a>Requirements</h4>

<ul>
  
<li>An OSGi-based Oak installation (eg. Sling or AEM).</li>
</ul></div>
<div class="section">
<h4><a name="Enabling_SplitBlobStore_-_external_blob_store_case"></a>Enabling SplitBlobStore - external blob store case</h4>
<p>These steps should be followed for migration from <tt>FileBlobStore</tt>, <tt>FileDataStore</tt> or <tt>S3DataStore</tt>.</p>

<ol style="list-style-type: decimal">
  
<li>Add <tt>split.blobstore=old</tt> OSGi property to the source blob store.</li>
  
<li>Configure the destination blob store and add <tt>split.blobstore=new</tt> property to its OSGi configuration.</li>
  
<li>
<p>Create a configuration for the <tt>org.apache.jackrabbit.oak.spi.blob.osgi.SplitBlobStoreService</tt>.</p>
  
<div class="source">
<div class="source"><pre class="prettyprint">split.old.blobstore.type=INTERNAL
# optional:
repository.home=crx-quickstart/repository
</pre></div></div>
  
<ul>
    
<li>The directory is used to save the <tt>migrated_blobs.txt</tt> file.</li>
  </ul></li>
  
<li>Restart the instance</li>
</ol></div>
<div class="section">
<h4><a name="Enabling_SplitBlobStore_-_internal_blob_store_case"></a>Enabling SplitBlobStore - internal blob store case</h4>
<p>These steps should be followed for migration from <tt>MongoBlobStore</tt> or for blobs embedded in the <tt>SegmentNodeStore</tt>.</p>

<ol style="list-style-type: decimal">
  
<li>Configure the destination blob store and add <tt>split.blobstore=new</tt> property to its OSGi configuration.</li>
  
<li>
<p>Create a configuration for the <tt>org.apache.jackrabbit.oak.spi.blob.osgi.SplitBlobStoreService</tt>.</p>
  
<div class="source">
<div class="source"><pre class="prettyprint"># use DOCUMENT or SEGMENT, depending on the NodeStore type:
split.old.blobstore.type=SEGMENT
# optional:
repository.home=crx-quickstart/repository
</pre></div></div>
  
<ul>
    
<li>The directory is used to save the migrated_blobs.txt file.</li>
  </ul></li>
  
<li>Restart the instance</li>
</ol>
<p>After starting the instance, the <tt>SplitBlobStoreService</tt> will wait until blob stores with <tt>split.blobstore</tt> properties (the <tt>old</tt> and the <tt>new</tt>) are available. They will be bound and the <tt>SplitBlobStore</tt> will be registered in the OSGi. On the other hand, the <tt>NodeStoreService</tt> will ignore blob stores configured with the <tt>split.blobstore</tt> property and will wait until the <tt>SplitBlobStore</tt> is available.</p>
<p>From this point, all the new blobs will be saved in the new blob store. Binaries from the old blob store will be available to read.</p>
<p>The <tt>split.blobstore</tt> property support was added to <tt>FileBlobStore</tt>, <tt>AbstractDataStoreService</tt> (handling all Jackrabbit data stores), <tt>DocumentNodeStoreService</tt> and <tt>SegmentNodeStoreService</tt>.</p></div>
<div class="section">
<h4><a name="Migration"></a>Migration</h4>

<ol style="list-style-type: decimal">
  
<li>Find <tt>BlobMigration</tt> JMX bean in the Felix console.</li>
  
<li>Run <tt>startBlobMigration(false)</tt> operation</li>
</ol>
<p>The migration can be stopped using <tt>stopBlobMigration()</tt> and then resumed with <tt>startBlobMigration(true)</tt>. The current stats are available via the JMX as well:</p>

<ul>
  
<li>last processed path,</li>
  
<li>number of migrated nodes.</li>
</ul></div>
<div class="section">
<h4><a name="Switching_to_the_new_blob_store"></a>Switching to the new blob store</h4>
<p>When the migration is finished, it&#x2019;s possible to completely switch to the new blob store:</p>

<ol style="list-style-type: decimal">
  
<li>Remove the configuration for the old blob store.</li>
  
<li>Remove the configuration for the <tt>SplitBlobStoreService</tt></li>
  
<li>Remove the <tt>split.blobstore=new</tt> OSGi property from the new blob store, so it can be find by the <tt>NodeStoreService</tt>.</li>
  
<li>Restart the instance, so there are no JCR sessions bound to the old NodeState.</li>
</ol>
<p>Migration is now complete!</p></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
