<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Permission Evaluation in Detail</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
      <script type="text/javascript" src="../../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../../"  title="Oak logo"><img src="../../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../../license.html" title="License">License</a></li>
            <li><a href="../../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../../security/overview.html" title="Security">Security</a></li>
            <li><a href="../../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../../migration.html" title="Migration">Migration</a></li>
            <li><a href="../../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../participating.html" title="Participating">Participating</a></li>
            <li><a href="../../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
--><div class="section">
<h2><a name="Permission_Evaluation_in_Detail"></a>Permission Evaluation in Detail</h2>
<p><a name="permissionentries"></a></p>
<div class="section">
<h3><a name="Order_and_Evaluation_of_Permission_Entries"></a>Order and Evaluation of Permission Entries</h3>
<p>In order to evaluate the permissions for a given item, the <tt>PermissionProvider</tt> lazily builds an iterator of <tt>PermissionsEntry</tt> representing the rep:Permission present in the permission store that take effect for the given set of principals at the given node (or property).</p>
<p>Each <tt>PermissionsEntry</tt> stores the privileges granted/denied together with any restrictions that may be defined with the original access control entry.</p>
<p>This iterator is a concatenation between all entries associated with user principals followed by the entries associated with group principals.</p>
<p>The order of precedence is as follows:</p>

<ul>
  
<li>permissions are inherited throughout the item hierarchy</li>
  
<li>user principals always take precedence over group principals irrespective of
  
<ul>
    
<li>their order in the access control list</li>
    
<li>their position in the node hierarchy</li>
  </ul></li>
  
<li>within a given type of principal (user vs. group principal) the order of executing is
  
<ul>
    
<li>order of entries as specified originally (the index of the permission entry)</li>
    
<li>entries associated with the target tree take precedence over inherited entries</li>
  </ul></li>
</ul>
<div class="section">
<div class="section">
<h5><a name="Examples"></a>Examples</h5>
<div class="section">
<h6><a name="Simple_Inheritance"></a>Simple Inheritance</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    allow - everyone - READ permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>everyone is allowed to read the complete tree defined by /content</li>
</ul></div>
<div class="section">
<h6><a name="Simple_Inheritance_with_Restrictions"></a>Simple Inheritance with Restrictions</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    allow - everyone - READ permission
    deny - everyone - READ_PROPERTY permission - restriction rep:itemNames = ['prop1', 'prop2']
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>everyone is can read the complete tree defined by /content <i>except</i> for properties named &#x2018;prop1&#x2019; or &#x2018;prop2&#x2019; which are explicitly denied by the restricting entry.</li>
</ul></div>
<div class="section">
<h6><a name="Inheritance_with_Allow_and_Deny"></a>Inheritance with Allow and Deny</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    deny - everyone - READ permission

/content/public
    allow - everyone - READ permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>everyone cannot read items at the tree defined by /content</li>
  
<li>except for tree defined by /content/public which is accessible.</li>
</ul></div>
<div class="section">
<h6><a name="Inheritance_with_Multiple_Allows"></a>Inheritance with Multiple Allows</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    allow - everyone - READ permission

/content/public
    allow - everyone - REMOVE permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>everyonce can read item at /content and the complete subtree</li>
  
<li>in addition everyone can remove items underneath /content/public</li>
</ul></div>
<div class="section">
<h6><a name="Inheritance_with_Different_Principals"></a>Inheritance with Different Principals</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    allow - everyone - READ permission
    allow - authorGroup - REMOVE permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>a subject being member of everyone is allowed to read at /content and the complete subtree</li>
  
<li>a subject being member of authorGroup is only allowed to remove items at /content</li>
  
<li>a subject being member of both everyone <i>and</i> authorGroup  has full read-access at /content <i>and</i> can also remove items.</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">/content
    allow - everyone - READ permission

/content/private
    deny - everyone - READ permission
    allow - powerfulGroup - ALL permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>a subject being member of everyone
  
<ul>
    
<li>is allowed to read at /content and the complete subtree</li>
    
<li>except for /content/private</li>
  </ul></li>
  
<li>a subject being member of powerfulGroup
  
<ul>
    
<li>has full permission at /content/private</li>
  </ul></li>
  
<li>a subject being member of both everyone <i>and</i> powerfulGroup
  
<ul>
    
<li>has full read-access at /content</li>
    
<li>has full permission underneath /content/private</li>
  </ul></li>
</ul></div>
<div class="section">
<h6><a name="Interaction_of_User_and_Group_Principals"></a>Interaction of User and Group Principals</h6>

<div class="source">
<div class="source"><pre class="prettyprint">/home/jackrabbit
    allow - jackrabbit - ALL permission
    deny - everyone - ALL permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>a subject containing the &#x2018;jackrabbit&#x2019; user principal has full permission at /home/jackrabbit irrespective of the presense of everyone group principal in the subject.</li>
  
<li>any other subject has not access at /home/jackrabbit</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">/home/jackrabbit
    allow - jackrabbit - ALL permission

/home/jackrabbit/private
    deny - everyone - ALL permission
</pre></div></div>
<p>Result:</p>

<ul>
  
<li>a subject containing the &#x2018;jackrabbit&#x2019; user principal has full permission at the tree defined by /home/jackrabbit irrespective of the presense of everyone group principal in the subject.</li>
  
<li>any other subject is explicitly denied access to /home/jackrabbit/private</li>
</ul></div></div></div></div>
<div class="section">
<h3><a name="Some_Examples:_Step_by_Step"></a>Some Examples: Step by Step</h3>
<div class="section">
<h4><a name="Reading"></a>Reading</h4>
<div class="section">
<h5><a name="Reading_a_Node"></a>Reading a Node</h5>
<p>The following section describes what happens on <tt>Session.getNode(&quot;/foo&quot;).getProperty(&quot;jcr:title&quot;)</tt> in terms of permission evaluation:</p>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>SessionImpl.getNode()</tt> internally calls <tt>SessionDelegate.getNode()</tt>  which calls <tt>Root.getTree()</tt> which calls <tt>Tree.getTree()</tt> on the <tt>/foo</tt> tree.  This creates a bunch of linked <tt>MutableTree</tt> objects.</p></li>
  
<li>
<p>The session delegate then checks if the tree really exists, by calling <tt>Tree.exists()</tt>  which then calls <tt>NodeBuilder.exists()</tt>.</p></li>
  
<li>
<p>If the session performing the operation is an <i>admin</i> session, then the node builder from  the persistence layer is directly used. In all other cases, the original node builder  is wrapped by a <tt>SecureNodeBuilder</tt>. The <tt>SecureNodeBuilder</tt> performs permission  checks before delegating the calls to the delegated builder.</p></li>
  
<li>
<p>For non <i>admin</i> sessions the <tt>SecureNodeBuilder</tt> fetches its <i>tree permissions</i> via  <tt>getTreePermission()</tt>.</p></li>
  
<li>
<p>The <tt>TreePermission</tt> is responsible for evaluating the permissions granted or  denied for a given Oak <tt>Tree</tt> and it&#x2019;s properties. In order to test if a the  tree itself is accessible <tt>TreePermission#canRead()</tt> is called and checks the  <tt>READ_NODE</tt> permission for normal trees (as in this example) or the <tt>READ_ACCESS_CONTROL</tt>  permission on <i>AC trees</i>. The result is remembered in the <tt>ReadStatus</tt> kept  with this <tt>TreePermission</tt> instance.</p></li>
  
<li>
<p>The read status is based on the evaluation of the <i>permission entries</i> that  are effective for this tree and the set of principals associated with the  permission provider. They are retrieved internally by calling <tt>getEntryIterator()</tt>.</p></li>
  
<li>
<p>The <i>permission entries</i> are <a href="#entry_evaluation">analyzed</a> if they include the respective permission and if so,  the read status is set accordingly. Note that the sequence of the permission entries from  the iterator is already in the correct order for this kind of evaluation. This is ensured  by the way how they are stored in the <a href="default.html#permissionStore">permission store</a> and how they  are feed into the iterator (see <a href="#permissionentries">Order and Evaluation of Permission Entries</a> above).</p>
<p>The iteration also detects if the evaluated permission entries cover <i>this</i> node and all  its properties. If this is the case, subsequent calls that evaluate the property read  permissions would then not need to do the same iteration again. In order to detect this,  the iteration checks if a non-matching permission entry or privilege was skipped  and eventually sets the respective flag in the <tt>ReadStatus</tt>. This flag indicates if the  present permission entries are sufficient to tell if the session is allowed to read  <i>this</i> node and all its properties. If there are more entries present than the ones needed  for evaluating the <tt>READ_NODE</tt> permission, then it&#x2019;s ambiguous to determine if all  properties can be read.</p></li>
  
<li>
<p>Once the <tt>ReadStatus</tt> is calculated (or was calculated earlier) the <tt>canRead()</tt> method  returns <tt>ReadStatus.allowsThis()</tt> which specifies if <i>this</i> node is allowed to be read.</p></li>
</ol></div>
<div class="section">
<h5><a name="Reading_a_Property"></a>Reading a Property</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>Node.getProperty()</tt> internally calls <tt>NodeDelegate.getPropertyOrNull()</tt>  which first resolves the parent node as indicated by the relative path without  testing for it&#x2019;s existence. Then a new <tt>PropertyDelegate</tt> is created from  the parent node and the name of the property, which internal obtains the  <tt>PropertyState</tt> from the Oak <tt>Tree</tt>, which may return <tt>null</tt>.</p></li>
  
<li>
<p>The node delegate then checks if the property really exists (or is accessible  to the reading session by calling <tt>PropertyDelegate.exists()</tt> asserting if the  underlying <tt>PropertyState</tt> is not <tt>null</tt>.</p></li>
  
<li>
<p>If the session performing the operation is an <i>admin</i> session, then the property state from  the persistence layer is directly used. In all other cases, the original node builder  is wrapped by a <tt>SecureNodeBuilder</tt>. The <tt>SecureNodeBuilder</tt> performs permission  checks before delegating the calls to the delegated builder.</p></li>
  
<li>
<p>For non <i>admin</i> sessions the <tt>SecureNodeBuilder</tt> fetches its <i>tree permissions</i> via  <tt>getTreePermission()</tt>.</p></li>
  
<li>
<p>The <tt>TreePermission</tt> is responsible for evaluating the permissions granted or  denied for a given Oak <tt>Tree</tt> and it&#x2019;s properties. In order to test if the  property is accessible <tt>TreePermission#canRead(PropertyState)</tt> is called and checks the  <tt>READ_PROPERTY</tt> permission for regular properties or the <tt>READ_ACCESS_CONTROL</tt>  permission for properties defining access control related content. In case  all properties defined with the parent tree are accessible to the editing  session the result is remembered in the <tt>ReadStatus</tt> kept with this <tt>TreePermission</tt>  instance; otherwise the <i>permission entries</i> are collected and evaluated as described  <a href="#permissionentries">above</a>.</p></li>
</ol></div></div>
<div class="section">
<h4><a name="Session_Write-Operations"></a>Session Write-Operations</h4>
<div class="section">
<h5><a name="Adding_a_Node"></a>Adding a Node</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>Node.addNode(String)</tt> will internally call <tt>NodeDelegate.addChild</tt> which  in term, adds a new child to the corresponding Oak <tt>Tree</tt> and generate all  autocreated child items.</p></li>
  
<li>
<p>Once <tt>Session.save()</tt> is called all pending changes will be merged into the  <tt>NodeStore</tt> present with the editing Oak <tt>Root</tt>. This is achieved by calling  <tt>Root#commit</tt>.</p></li>
  
<li>
<p>The permission evaluation is triggered by means of a specific <tt>Validator</tt>  implementation that is passed over to the merge along with the complete set  of validators and editors that are combined into a single <tt>CommitHook</tt>.</p></li>
  
<li>
<p>The <tt>PermissionValidator</tt> will be notified about the new node being added.</p></li>
  
<li>
<p>It again obtains the <tt>TreePermission</tt> object form the <tt>PermissionProvider</tt> and  evaluates if <tt>ADD_NODE</tt> permission is being granted for the new target node.  The evaluation follows the same principals as described <a href="#permissionentries">above</a>.</p></li>
  
<li>
<p>If added the new node is granted the validation continues otherwise the <tt>commit</tt>  will fail immediately with an <tt>CommitFailedException</tt> of type <tt>ACCESS</tt>.</p></li>
</ol></div>
<div class="section">
<h5><a name="Changing_a_Property"></a>Changing a Property</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>Property.setValue</tt> will internally call <tt>PropertyDelegate.setState</tt> with  an new <tt>PropertyState</tt> created from the new value (or the new set of values).</p></li>
  
<li>
<p>Once <tt>Session.save()</tt> is called all pending changes will be merged into the  <tt>NodeStore</tt> present with the editing Oak <tt>Root</tt>. This is achieved by calling  <tt>Root#commit</tt>.</p></li>
  
<li>
<p>The permission evaluation is triggered by means of a specific <tt>Validator</tt>  implementation that is passed over to the merge along with the complete set  of validators and editors that are combined into a single <tt>CommitHook</tt>.</p></li>
  
<li>
<p>The <tt>PermissionValidator</tt> will be notified about the modified property.</p></li>
  
<li>
<p>It again obtains the <tt>TreePermission</tt> object form the <tt>PermissionProvider</tt> and  evaluates if <tt>MODIFY_PROPERTY</tt> permission is being granted.  The evaluation follows the same principals as described <a href="#permissionentries">above</a>.</p></li>
  
<li>
<p>If changing this property is allowed the validation continues otherwise the <tt>commit</tt>  will fail immediately with an <tt>CommitFailedException</tt> of type <tt>ACCESS</tt>.</p></li>
</ol></div></div>
<div class="section">
<h4><a name="Workspace_Operations"></a>Workspace Operations</h4>
<div class="section">
<h5><a name="Copying_Nodes"></a>Copying Nodes</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>Workspac.copy</tt> will internally call <tt>WorkspaceDelegate.copy</tt>.</p></li>
  
<li>
<p>After some preliminary validation the delegate will create a new <tt>WorkspaceCopy</tt>  and call it&#x2019;s <tt>perform</tt> method passing in the separate <tt>Root</tt> instance obtained  from <tt>ContentSession.getLatestRoot()</tt>; in other words the modifications made  by the copy operation will not show up as transient changes on the editing  session.</p></li>
  
<li>
<p>Upon completion of the copy operation <tt>Root.commit</tt> is called on that latest  root instance and the delegated will refresh the editing session to reflect  the changes made by the copy.</p></li>
  
<li>
<p>The permission evaluation is triggered upon committing the changes associated  with the copy by the same <tt>Validator</tt> that handles transient operations.</p></li>
  
<li>
<p>The <tt>PermissionValidator</tt> will be notified about the new items created by the  copy and checks the corresponding permissions with the <tt>TreePermission</tt> associated  with the individual new nodes. The evaluation follows the same principals  as described <a href="#permissionentries">above</a>.</p></li>
  
<li>
<p>If a permission violation is detected the <tt>commit</tt> will fail immediately with  an <tt>CommitFailedException</tt> of type <tt>ACCESS</tt>.</p></li>
</ol></div>
<div class="section">
<h5><a name="Locking_a_Node"></a>Locking a Node</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>LockManager.lock</tt> will internally call <tt>NodeDelegate.lock</tt>, which will  obtain a new <tt>Root</tt> from the editing <tt>ContentSession</tt> and perform the  required changes on that dedicated root such that the editing session is  not affected.</p></li>
  
<li>
<p>Once the lock operation is complete the delegate will call <tt>Root.commit</tt>  on the latest root instance in order to persist the changes. Finally the  lock manager will refresh the editing session to reflect the changes made.</p></li>
  
<li>
<p>The permission evaluation is triggered upon committing the changes associated  with the lock operation by the same <tt>Validator</tt> that handles transient operations.</p></li>
  
<li>
<p>The <tt>PermissionValidator</tt> will be notified about the new items created by the  lock and identify that they are associated with a lock specific operations.  Consequently it will checks for <tt>LOCK_MANAGEMENT</tt> permissions being granted  at the affected tree. The evaluation triggered by calling <tt>TreePermission.isGranted</tt>  and follows the same principals as described <a href="#permissionentries">above</a>.</p></li>
  
<li>
<p>If a permission violation is detected the <tt>commit</tt> will fail immediately with  an <tt>CommitFailedException</tt> of type <tt>ACCESS</tt>.</p></li>
</ol></div></div>
<div class="section">
<h4><a name="Repository_Operations"></a>Repository Operations</h4>
<div class="section">
<h5><a name="Registering_a_Privilege"></a>Registering a Privilege</h5>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>PrivilegeManager.registerPrivilege</tt> will obtain a new <tt>Root</tt> from the editing  <tt>ContentSession</tt> and pass it to a new <tt>PrivilegeDefinitionWriter</tt> that is  in charge of writing the repository content associated with a new privilege  definition. Finally the writer will persist the changes by calling <tt>Root.commit</tt>.</p></li>
  
<li>
<p>Validation of the new privilege definition if delegated to a dedicated  <tt>PrivilegeValidator</tt>.</p></li>
  
<li>
<p>The permission evaluation is triggered upon committing the changes associated  by the same <tt>Validator</tt> that handles transient operations.</p></li>
  
<li>
<p>The <tt>PermissionValidator</tt> will be notified about changes being made to the  dedicated tree storing privilege information and will specifically verify  that <tt>PRIVILEGE_MANAGEMENT</tt> permissions being granted at the repository level.  This is achieved by obtaining the <tt>RepositoryPermission</tt> object from the  <tt>PermissionProvider</tt> and calling <tt>RepositoryPermission.isGranted</tt>. The evaluation  follows the same principals as described <a href="#permissionentries">above</a>.</p></li>
  
<li>
<p>If a permission violation is detected the <tt>commit</tt> will fail immediately with  an <tt>CommitFailedException</tt> of type <tt>ACCESS</tt>.</p></li>
  
<li>
<p>Once the registration is successfully completed the manager will refresh the  editing session.</p></li>
</ol></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
