<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Authentication with External Login Module : Examples</title>
    <link rel="stylesheet" href="../../../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../../../css/site.css" />
    <link rel="stylesheet" href="../../../css/print.css" media="print" />
      <script type="text/javascript" src="../../../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../../../"  title="Oak logo"><img src="../../../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../../../license.html" title="License">License</a></li>
            <li><a href="../../../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../../../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../../../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../../../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../../../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../../../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../../../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../../../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../../../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../../../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../../../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../../../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../../../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../../../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../../../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../../../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../../../security/overview.html" title="Security">Security</a></li>
            <li><a href="../../../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../../../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../../../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../../../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../../../migration.html" title="Migration">Migration</a></li>
            <li><a href="../../../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../../../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../../../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../../../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../../../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../../../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../../participating.html" title="Participating">Participating</a></li>
            <li><a href="../../../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../../../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../../../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../../../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../../../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../../../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../../../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../../../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../../../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../../../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../../../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../../../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../../../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../../../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../../../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../../../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../../../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../../../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../../../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../../../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../../../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../../../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../../../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../../../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../../../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../../../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../../../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../../../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../../../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../../../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../../../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../../../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../../../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../../../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../../../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../../../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../../../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../../../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../../../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../../../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../../../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../../../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../../../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../../../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../../../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../../../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../../../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../../../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../../../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
--><div class="section">
<h2><a name="Authentication_with_External_Login_Module_:_Examples"></a>Authentication with External Login Module : Examples</h2>

<ul>
  
<li><a href="#standard">Integration with Standard Oak Authentication</a></li>
  
<li><a href="#preauth">Integration with Pre-Authentication and Login Module Chain</a></li>
</ul>
<p><a name="standard"></a></p>
<div class="section">
<h3><a name="Integration_with_Standard_Oak_Authentication"></a>Integration with Standard Oak Authentication</h3>
<div class="section">
<h4><a name="Example_JAAS_Configuration"></a>Example JAAS Configuration</h4>

<div class="source">
<div class="source"><pre class="prettyprint">  Example {
     org.apache.jackrabbit.oak.security.authentication.token.TokenLoginModule sufficient;
     org.apache.jackrabbit.oak.security.authentication.user.LoginModuleImpl sufficient;
     org.apache.jackrabbit.oak.spi.security.authentication.external.impl.ExternalLoginModule required
                     sync.handlerName=&quot;your-synchandler_name&quot;
                     idp.name=&quot;your_idp_name&quot;;
   };
</pre></div></div></div>
<div class="section">
<h4><a name="Understanding_the_Configuration"></a>Understanding the Configuration</h4>
<div class="section">
<h5><a name="The_LoginModule_Sequence"></a>The LoginModule Sequence</h5>

<ul>
  
<li>
<p>The <tt>TokenLoginModule</tt> is in charge of handling repository authentication  request with <tt>TokenCredentials</tt>:</p>
  
<ul>
    
<li><i>Login Success</i>: If token-login succeeds the <i>sufficient</i> flag makes sure authentication does not proceed down the <tt>LoginModule</tt> list. This means that it will not hit the <tt>ExternalIdentityProvider</tt> and will not re-sync an external user as long as the login token is valid.</li>
    
<li><i>Login Failure</i>: If it fails (e.g. other type of <tt>Credentials</tt>) the authentication will proceed down the <tt>LoginModule</tt> list.</li>
    
<li><i>Commit</i>: If the login failed the login module will test if the <tt>Credentials</tt> passed to the login ask for generation of a new login token. If this login succeeded it will populate the <tt>Subject</tt> with <tt>Principal</tt>s, <tt>Credentials</tt> and <tt>AuthInfo</tt>.</li>
  </ul>
<p>NOTE: In this setup the <tt>TokenLoginModule</tt> is expected to only handle subsequent authentication request after having issued a login token. The latter is achieved by providing <tt>Credentials</tt> attributes that force the <tt>TokenLoginModule</tt> to generate a new login token in the <i>commit</i> phase. The application should then use that login toke for subsequent requests.</p>
<p>See <a href="../tokenmanagement.html">Token Authentication and Token Management</a> for details and for a description of the default implementation.</p></li>
  
<li>
<p>The <tt>LoginModuleImpl</tt> is in charge of handling authentication request for  users managed and created through the repository&#x2019;s user management API;  i.e. users that are not defined by an <tt>ExternalIdentityProvider</tt>. This  includes built-in system users like the administrator, the guest-user  (aka anonymous) or <tt>SystemUsers</tt>. It also handles impersonation logins.</p>
  
<ul>
    
<li><i>Login Success</i>: If regular user authentication (or impersonation) succeeds  the <i>sufficient</i> flag makes sure authentication does not proceed  down the <tt>LoginModule</tt> list i.e. omits unnecessarily trying to  authenticate a local user against the external IDP.</li>
    
<li><i>Login Failure</i>: If the authentication fails (e.g. no local user that  could have uid/pw matching the passed <tt>Credentials</tt>), it will  continue down the <tt>LoginModule</tt> list.</li>
    
<li><i>Commit</i>: If the login succeeded the login module will populate the  <tt>Subject</tt> with <tt>Principal</tt>s, <tt>Credentials</tt> and <tt>AuthInfo</tt>.</li>
  </ul>
<p>NOTE: if no login token is generated upon first login, any subsequent  login for <i>local</i> users will end up being handled by this module or fail.</p></li>
  
<li>
<p>The <tt>ExternalLoginModule</tt> is in charge of handling authentication request for  users managed by an <tt>ExternalIdentityProvider</tt>.</p>
  
<ul>
    
<li><i>Login Success</i>: If user authentication against the IDP succeeds  the module synchronizes the external user into the repository according  to the logic defined in the configure <tt>SyncHandler</tt>. If the user  has been synced before it might be updated. If and how often a user  gets re-synced is an implementation detail of the <tt>SyncHandler</tt>.</li>
    
<li><i>Login Failure</i>: If the authentication fails (e.g. wrong IDP or invalid  <tt>Credentials</tt>), the whole login will fail because the <tt>ExternalLoginModule</tt>  is configured to be <i>required</i> and the last module in the chain.</li>
    
<li><i>Commit</i>: If the login succeeded the login module will populate the  <tt>Subject</tt> with <tt>Principal</tt>s, <tt>Credentials</tt> and <tt>AuthInfo</tt>.</li>
  </ul>
<p>NOTE: if no login token is generated upon first login, any subsequent  login for <i>external</i> users will end up being handled by this module  (including connection to the IDP) or fail.</p></li>
</ul></div>
<div class="section">
<h5><a name="Login_with_Different_Credentials"></a>Login with Different Credentials</h5>
<div class="section">
<h6><a name="GuestCredentials"></a>GuestCredentials</h6>

<ul>
  
<li><tt>TokenLoginModule</tt> will ignore</li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>GuestCredentials</tt>; success depends  on the existence of a valid guest user in the repository. If it succeeds  authentication doesn&#x2019;t move down to <tt>ExternalLoginModule</tt>.</li>
  
<li><tt>ExternalLoginModule</tt> by default doesn&#x2019;t support <tt>GuestCredentials</tt>  but may do if a suitable <tt>CredentialsSupport</tt> is configured.</li>
</ul></div>
<div class="section">
<h6><a name="SimpleCredentials"></a>SimpleCredentials</h6>

<ul>
  
<li><tt>TokenLoginModule</tt> will ignore</li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>SimpleCredentials</tt> and it  will succeed if the credentials are successfully validated against a  local repository user. It is not expected to succeed for synced  external users,which should not have their password synced. If it succeeds  authentication doesn&#x2019;t move down to <tt>ExternalLoginModule</tt>.</li>
  
<li><tt>ExternalLoginModule</tt> by default support <tt>SimpleCredentials</tt> and will  succeed if authenticating an external against the external IDP including  sync is successful. If none of the other modules succeeded the  <tt>ExternalLoginModule</tt> is required to succeed.</li>
</ul></div>
<div class="section">
<h6><a name="TokenCredentials"></a>TokenCredentials</h6>

<ul>
  
<li><tt>TokenLoginModule</tt> supports <tt>TokenCredentials</tt> and will succeed if the  credentials are valid. If it succeeds authentication doesn&#x2019;t move down  the module list. If it fails overall authentication is expected to fail  as the subsequent modules are not expected to support <tt>TokenCredentials</tt>.</li>
  
<li><tt>LoginModuleImpl</tt> does not support <tt>TokenCredentials</tt> and will fail.</li>
  
<li><tt>ExternalLoginModule</tt> is not expected to support <tt>TokenCredentials</tt> and  thus overall authentication is expected to fail if <tt>TokenLoginModule</tt>  failed.</li>
</ul></div>
<div class="section">
<h6><a name="ImpersonationCredentials"></a>ImpersonationCredentials</h6>

<ul>
  
<li><tt>TokenLoginModule</tt> will ignore</li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>ImpersonationCredentials</tt> and it  will succeed if impersonation for the target user is allowed. If it succeeds  authentication doesn&#x2019;t move down to <tt>ExternalLoginModule</tt>.</li>
  
<li><tt>ExternalLoginModule</tt> by default doesn&#x2019;t support <tt>ImpersonationCredentials</tt>  but may do if a suitable <tt>CredentialsSupport</tt> is configured.</li>
</ul></div>
<div class="section">
<h6><a name="Other_Credentials"></a>Other Credentials</h6>

<ul>
  
<li>Overall login success only if the <tt>ExternalLoginModule</tt> supports these credentials</li>
  
<li><tt>TokenLoginModule</tt> will ignore</li>
  
<li><tt>LoginModuleImpl</tt> will ignore</li>
  
<li><tt>ExternalLoginModule</tt> will only succeed if configured with a suitable  <tt>CredentialsSupport</tt> that ensures that authentication against the external  IDP is successful.</li>
</ul>
<p><a name="preauth"></a></p></div></div></div></div>
<div class="section">
<h3><a name="Integration_with_Pre-Authentication_and_Login_Module_Chain"></a>Integration with Pre-Authentication and Login Module Chain</h3>
<div class="section">
<h4><a name="Example_JAAS_Configuration"></a>Example JAAS Configuration</h4>

<div class="source">
<div class="source"><pre class="prettyprint">  Example {
     your.org.PreAuthenticationLoginModule optional;
     org.apache.jackrabbit.oak.security.authentication.user.LoginModuleImpl optional;
     org.apache.jackrabbit.oak.spi.security.authentication.external.impl.ExternalLoginModule sufficient
                     sync.handlerName=&quot;your-synchandler_name&quot;
                     idp.name=&quot;your_idp_name&quot;;
   };
</pre></div></div>
<p>See <a href="../preauthentication.html#withloginchain">Pre-Authenticated Login</a> for an example <tt>LoginModule</tt> that illustrates how the pre-authentication is being pushed to the shared stated.</p>
<p><i>Note:</i> This configuration has been slightly adjusted from the example in <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-3508">OAK-3508</a> marking the pre-auth login to be <i>optional</i>. This highlights the fact that subsequent <tt>LoginModule</tt>s are in charge of respecting the <tt>PreAuthenticatedLogin</tt> marker and properly populating the <tt>Subject</tt> in the second <i>commit</i> phase.</p>
<p>Also, in the example implementation the login never succeeds (in which case <i>sufficient</i> would actually work as well). However, if it ever succeeded the <tt>PreAuthenticatedLogin</tt> marker would be meaningless and the pre-auth module in fact would have to populate the <tt>Subject</tt> i.e. relying on details defined and handled by other <tt>LoginModule</tt>s. </p></div>
<div class="section">
<h4><a name="Understanding_the_Configuration"></a>Understanding the Configuration</h4>
<div class="section">
<h5><a name="The_LoginModule_Sequence"></a>The LoginModule Sequence</h5>

<ul>
  
<li>
<p>The custom pre-auth module is in charge of handling custom pre-auth <tt>Credentials</tt>  shared between the code performing the authentication outside of the  scope of the repository and this module.  It&#x2019;s only task is to create the <tt>PreAuthenticatedLogin</tt> marker and push  it to the shared stated to inform subsequent modules, which will always  be consulted due to the <i>optional</i> flag.</p>
  
<ul>
    
<li><i>Login Success</i>: not desired as we want subsequent modules to verify if  there is a matching identity for the <tt>PreAuthenticatedLogin</tt> and later on  populate the subject.</li>
    
<li><i>Login Failure</i>: the default passing over the responsibility the  other modules in the chain.</li>
    
<li><i>Commit</i>: Nothing to do.</li>
  </ul></li>
  
<li>
<p>The <tt>LoginModuleImpl</tt> will try to resolve the repository user associated  with the <tt>PreAuthenticatedLogin</tt> or perform regular login with the login  <tt>Credentials</tt> if no <tt>PreAuthenticatedLogin</tt> is present. </p>
  
<ul>
    
<li><i>Login Success</i>: If there exists a valid user for the given <tt>PreAuthenticatedLogin</tt>  or <tt>Credentials</tt> login will always succeed in case of a pre-auth login.  Otherwise credentials are regularly evaluated (e.g. password validation).  The authentication will continue down the chain due to the <i>optional</i> flag.</li>
    
<li><i>Login Failure</i>: If no matching user exists or if the user is not valid  (e.g. disabled). In case of regular authentication it will fail if the  <tt>Credentials</tt> cannot be validated. Then authentication it will again  continue down the <tt>LoginModule</tt> list.</li>
    
<li><i>Commit</i>: If the login succeeded the login module will populate the <tt>Subject</tt> with <tt>Principal</tt>s, <tt>Credentials</tt> and <tt>AuthInfo</tt>.</li>
  </ul></li>
  
<li>
<p>The <tt>ExternalLoginModule</tt> will try to resolve the <tt>PreAuthenticatedLogin</tt> or  alternatively the <tt>Credentials</tt> to a <tt>SyncedIdentity</tt>.</p>
  
<ul>
    
<li>If no <tt>SyncedIdentity</tt> exists the user is retrieved from external IDP  and eventually synced into the repository. In case no <tt>PreAuthenticatedLogin</tt>  is present retrieving identity additionally includes credentials validation.</li>
    
<li>If there exists a <tt>SyncedIdentity</tt> the module will validate it.  In case of <tt>PreAuthenticatedLogin</tt> it checks if the identity needs to  be synced again.</li>
    
<li><i>Login Success</i>: If there exists a valid external identity on the  IDP and it has be synced with the repository.</li>
    
<li><i>Login Failure</i>: If no matching/valid identity exists on the IDP or  if there exists a <tt>SyncedIdentity</tt> that doesn&#x2019;t belong to the IDP or  we have a <tt>PreAuthenticatedLogin</tt> marker and the <tt>SyncedIdentity</tt> doesn&#x2019;t  need a re-sync.</li>
    
<li><i>Commit</i>: If the login succeeded the login module will populate the  <tt>Subject</tt> with <tt>Principal</tt>s, <tt>Credentials</tt> and <tt>AuthInfo</tt>.</li>
  </ul></li>
</ul></div>
<div class="section">
<h5><a name="Login_with_Different_Credentials"></a>Login with Different Credentials</h5>
<div class="section">
<h6><a name="Custom_Pre-Auth_Credentials"></a>Custom Pre-Auth Credentials</h6>

<ul>
  
<li>Custom pre-auth module will push <tt>PreAuthenticatedLogin</tt> on the shared state</li>
  
<li>Overall login suceeds if any of the subsequent modules is able to deal  with the <tt>PreAuthenticatedLogin</tt>.</li>
</ul></div>
<div class="section">
<h6><a name="GuestCredentials"></a>GuestCredentials</h6>

<ul>
  
<li>Custom pre-auth module will ignore</li>
  
<li>Overall login success if the subsequent modules allow for login with <tt>GuestCredentials</tt></li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>GuestCredentials</tt>; success depends  on the existence of a valid guest user in the repository.</li>
  
<li><tt>ExternalLoginModule</tt> by default doesn&#x2019;t support <tt>GuestCredentials</tt>  but may do if a suitable <tt>CredentialsSupport</tt> is configured.</li>
</ul></div>
<div class="section">
<h6><a name="SimpleCredentials"></a>SimpleCredentials</h6>

<ul>
  
<li>Custom pre-auth module will ignore</li>
  
<li>Overall login success if the subsequent modules allow for login with <tt>SimpleCredentials</tt></li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>SimpleCredentials</tt> and it  will succeed if the credentials are successfully validated against a  local repository user.</li>
  
<li><tt>ExternalLoginModule</tt> by default support <tt>SimpleCredentials</tt> and will  succeed if authentication against the external IDP including sync is successful.</li>
</ul></div>
<div class="section">
<h6><a name="ImpersonationCredentials"></a>ImpersonationCredentials</h6>

<ul>
  
<li>Custom pre-auth module will ignore</li>
  
<li>Overall login success if the subsequent modules allow for login with <tt>ImpersonationCredentials</tt></li>
  
<li><tt>LoginModuleImpl</tt> by default supports <tt>ImpersonationCredentials</tt> and it  will succeed if impersonation for the target user is allowed.</li>
  
<li><tt>ExternalLoginModule</tt> by default doesn&#x2019;t support <tt>ImpersonationCredentials</tt>  but may do if a suitable <tt>CredentialsSupport</tt> is configured.</li>
</ul></div>
<div class="section">
<h6><a name="Other_Credentials"></a>Other Credentials</h6>

<ul>
  
<li>Overall login success only if the <tt>ExternalLoginModule</tt> supports these credentials</li>
  
<li>Custom pre-auth module will ignore</li>
  
<li><tt>LoginModuleImpl</tt> will ignore</li>
  
<li><tt>ExternalLoginModule</tt> will only succeed if configured with a suitable  <tt>CredentialsSupport</tt> that ensures that authentication against the external  IDP is successful.</li>
</ul></div></div>
<div class="section">
<h5><a name="FAQ"></a>FAQ</h5>
<div class="section">
<h6><a name="Why_are_the_custom_PreAuthCredentials_not_public"></a>Why are the custom &#x2018;PreAuthCredentials&#x2019; not public?</h6>
<p>The custom <tt>Credentials</tt> shared between the code performing the authentication (outside of the repository) and the custom <i>PreAuthenticationLoginModule</i> implementation must neither be public nor shared with other implementations in order to prevent un-authenticated login.</p></div>
<div class="section">
<h6><a name="Why_is_the_LoginModuleImpl_not_flagged_SUFFICIENT"></a>Why is the &#x2018;LoginModuleImpl&#x2019; not flagged SUFFICIENT?</h6>
<p>If <tt>LoginModuleImpl</tt> was defined to be <i>sufficient</i> external identities would never be synced again if the <tt>PreAuthenticatedLogin</tt> marker is present in the shared state.</p></div>
<div class="section">
<h6><a name="Why_is_the_ExternalLoginModule_not_flagged_REQUIRED"></a>Why is the &#x2018;ExternalLoginModule&#x2019; not flagged REQUIRED?</h6>
<p>If <tt>ExternalLoginModule</tt> was required to succeed, login for <i>local</i> users was no longer possible. It also would mean that pre-authenticated login for a <tt>SyncedIdentity</tt> that doesn&#x2019;t needs a re-sync would not longer be possible and would ultimately fail the repository authentication.</p>
<!-- references --></div></div></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
