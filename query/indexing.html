<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Indexing</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../security/overview.html" title="Security">Security</a></li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Indexing</a>
  </li>
    <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  --><h1>Indexing</h1>

<ul>
  
<li><a href="#indexing">Indexing</a>
  
<ul>
    
<li><a href="#overview">Overview</a>
    
<ul>
      
<li><a href="#new-1.6">New in 1.6</a></li>
    </ul></li>
    
<li><a href="#indexing-flow">Indexing Flow</a>
    
<ul>
      
<li><a href="#index-defnitions">Index Definitions</a>
      
<ul>
        
<li><a href="#oak-index-nodes">Index Definition Location</a></li>
      </ul></li>
      
<li><a href="#sync-indexing">Synchronous Indexing</a></li>
      
<li><a href="#async-indexing">Asynchronous Indexing</a>
      
<ul>
        
<li><a href="#checkpoint">Checkpoint</a></li>
        
<li><a href="#indexing-lane">Indexing Lane</a></li>
        
<li><a href="#cluster">Clustered Setup</a>
        
<ul>
          
<li><a href="#async-index-lease">Indexing Lease</a></li>
        </ul></li>
        
<li><a href="#async-index-lag">Indexing Lag</a></li>
        
<li><a href="#async-index-setup">Setup</a></li>
        
<li><a href="#async-index-mbean">Async Indexing MBean</a></li>
        
<li><a href="#corrupt-index-handling">Isolating Corrupt Indexes</a></li>
      </ul></li>
      
<li><a href="#nrt-indexing">Near Real Time Indexing</a>
      
<ul>
        
<li><a href="#nrt-indexing-usage">Usage</a>
        
<ul>
          
<li><a href="#nrt-indexing-mode-nrt">NRT Indexing Mode - nrt</a></li>
          
<li><a href="#nrt-indexing-mode-sync">NRT Indexing Mode - sync</a></li>
        </ul></li>
        
<li><a href="#nrt-indexing-cluster-setup">Cluster Setup</a></li>
        
<li><a href="#nrt-indexing-config">Configuration</a></li>
      </ul></li>
    </ul></li>
    
<li><a href="#reindexing">Reindexing</a>
    
<ul>
      
<li><a href="#reduce-reindexing-times">Reducing reindexing times</a></li>
      
<li><a href="#abort-reindex">How to Abort Reindexing</a></li>
    </ul></li>
  </ul></li>
</ul>
<div class="section">
<h2><a name="Overview"></a><a name="overview"></a> Overview</h2>
<p>For queries to perform well, Oak supports indexing of content that is stored in the repository. Indexing works by comparing different versions of the node data (technically, &#x201c;diff&#x201d; between the base <tt>NodeState</tt> and the modified <tt>NodeState</tt>). The indexing mode defines how comparing is performed, and when the index content gets updated:</p>

<ol style="list-style-type: decimal">
  
<li>Synchronous Indexing</li>
  
<li>Asynchronous Indexing</li>
  
<li>Near Real Time (NRT) Indexing</li>
</ol>
<p>Indexing uses <a href="../architecture/nodestate.html#commit-editors">Commit Editors</a>. Some of the editors are of type <tt>IndexEditor</tt>, which are responsible for updating index content based on changes in main content. Currently, Oak has following in built editors:</p>

<ol style="list-style-type: decimal">
  
<li>PropertyIndexEditor</li>
  
<li>ReferenceEditor</li>
  
<li>LuceneIndexEditor</li>
  
<li>SolrIndexEditor</li>
</ol>
<div class="section">
<h3><a name="New_in_1.6"></a><a name="new-1.6"></a> New in 1.6</h3>

<ul>
  
<li><a href="#nrt-indexing">Near Real Time (NRT) Indexing</a></li>
  
<li><a href="#async-index-setup">Multiple Async indexers setup via OSGi config</a></li>
  
<li><a href="#corrupt-index-handling">Isolating Corrupt Indexes</a></li>
</ul></div></div>
<div class="section">
<h2><a name="Indexing_Flow"></a><a name="indexing-flow"></a> Indexing Flow</h2>
<p>The <tt>IndexEditor</tt> is invoked as part of a commit (<tt>Session.save()</tt>), or as part of the asynchronous &#x201c;diff&#x201d; process. For both cases, at some stage &#x201c;diff&#x201d; is performed between the <i>before</i> and the <i>after</i> state, and passed to <tt>IndexUpdate</tt>, which is responsible for invoking the <tt>IndexEditor</tt> based on the <i>discovered</i> index definitions.</p>
<div class="section">
<h3><a name="Index_Definitions"></a><a name="index-defnitions"></a> Index Definitions</h3>
<p>Index definitions are nodes of type <tt>oak:QueryIndexDefinition</tt>, which are stored under a special node named <tt>oak:index</tt>. As part of diff traversal, at each level, <tt>IndexUpdate</tt> looks for <tt>oak:index</tt> nodes. Below is the canonical index definition structure:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/indexName
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - type (string) mandatory
  - async (string) multiple
  - reindex (boolean)
</pre></div></div>
<p>The index definitions nodes have the following properties:</p>

<ol style="list-style-type: decimal">
  
<li><tt>type</tt> - It determines the <i>type</i> of index. <tt>IndexUpdate</tt> looks for an <tt>IndexEditor</tt> of the given type from the registered <tt>IndexEditorProvider</tt>. For an out-of-the-box Oak setup, it can have one of the following values:
  
<ul>
    
<li><tt>reference</tt> - Configured with the out-of-the-box setup</li>
    
<li><tt>counter</tt> - Configured with the out-of-the-box setup</li>
    
<li><tt>property</tt></li>
    
<li><tt>lucene</tt></li>
    
<li><tt>solr</tt></li>
  </ul></li>
  
<li><tt>async</tt> - This determines if the index is to be updated synchronously or asynchronously. It can have following values:
  
<ul>
    
<li><tt>sync</tt> - The default value. It indicates that index is meant to be updated as part of each commit.</li>
    
<li><tt>nrt</tt> - Indicates that index is a <a href="#nrt-indexing">near real time</a> index.</li>
    
<li><tt>async</tt> - Indicates that index is to be updated asynchronously.  In such a case, this value is used to determine  the <a href="#indexing-lane">indexing lane</a></li>
    
<li>Any other value which ends in <tt>async</tt>.</li>
  </ul></li>
  
<li><tt>reindex</tt> - If set to <tt>true</tt>, reindexing is performed for that index. After reindexing is done, the property value is set to <tt>false</tt>. See <a href="#reindexing">reindexing</a> for more details.</li>
</ol>
<p>Based on the above two properties, the <tt>IndexUpdate</tt> creates an <tt>IndexEditor</tt> instances as it traverses the &#x201c;diff&#x201d;, and registers them with itself, passing on the callbacks for changes.</p>
<div class="section">
<h4><a name="Index_Definition_Location"></a><a name="oak-index-nodes"></a> Index Definition Location</h4>
<p>Indexing logic supports placing <tt>oak:index</tt> nodes at any path. Depending on the location, such indexes only index content which are present under those paths. So, for example if &#x2018;oak:index&#x2019; is present at <i>&#x2018;/content/oak:index&#x2019;</i>, then indexes defined under that node only index repository data present under <i>&#x2018;/content&#x2019;</i>.</p>
<p>Depending on the type of the index, one can create these index definitions under the root path (&#x2018;/&#x2019;), or non-root paths. Currently only <tt>lucene</tt> indexes support creating index definitions at non-root paths. <tt>property</tt> indexes can only be created under the root path, that is, under &#x2018;/&#x2019;.</p></div></div>
<div class="section">
<h3><a name="Synchronous_Indexing"></a><a name="sync-indexing"></a> Synchronous Indexing</h3>
<p>Under synchronous indexing, the index content gets updates as part of the commit itself. Changes to both the main content, as well as the index content, are done atomically in a single commit. </p>
<p>This mode is currently supported by <tt>property</tt> and <tt>reference</tt> indexes.</p></div>
<div class="section">
<h3><a name="Asynchronous_Indexing"></a><a name="async-indexing"></a> Asynchronous Indexing</h3>
<p>Asynchronous indexing (also called async indexing) is performed using periodic scheduled jobs. As part of the setup, Oak schedules certain periodic jobs which perform diff of the repository content, and update the index content based on that. </p>
<p>Each periodic <tt>AsyncIndexUpdate</tt> job is assigned to an <a href="#indexing-lane">indexing lane</a>, and is scheduled to run at a certain interval. At time of execution, the job performs its work:</p>

<ol style="list-style-type: decimal">
  
<li>Look for the last indexed state via stored checkpoint data.  If such a checkpoint exists, then read the <tt>NodeState</tt> for that checkpoint.  If no such state exists, or no such checkpoint is present,  then it treats it as initial indexing, in which case the base state is empty.  This state is considered the <tt>before</tt> state.</li>
  
<li>Check if there has been any change in repository from the <tt>before</tt> state.  If no change is detected then current indexing cycle is considered completed and  <tt>IndexStatsMBean#done</tt> time is set to current time. <tt>LastIndexedTime</tt> is not updated</li>
  
<li>Create a checkpoint for <i>current</i> state and refer to this as <tt>after</tt> state.</li>
  
<li>Create an <tt>IndexUpdate</tt> instance bound to the current <i>indexing lane</i>,  and trigger a diff between the <tt>before</tt> and the <tt>after</tt> state.</li>
  
<li><tt>IndexUpdate</tt> will then pick up index definitions that are bound to the current indexing lane,  will create <tt>IndexEditor</tt> instances for them,  and pass them the diff callbacks.</li>
  
<li>The diff traverses in a depth-first manner,  and at the end of diff, the <tt>IndexEditor</tt> will do final changes for the current indexing run.  Depending on the index implementation, the index data can be either stored in the NodeStore itself  (for indexes of type <tt>lucene</tt>, <tt>property</tt>, and so on), or in any remote store (for type <tt>solr</tt>).</li>
  
<li><tt>AsyncIndexUpdate</tt> will then update the last indexed checkpoint to the current checkpoint  and do a commit.</li>
</ol>
<p>Such async indexes are <i>eventually consistent</i> with the repository state, and lag behind the latest repository state by some time. However, the index content is eventually consistent, and never ends up in wrong state with respect to repository state.</p>
<div class="section">
<h4><a name="Checkpoint"></a><a name="checkpoint"></a> Checkpoint</h4>
<p>A checkpoint is a mechanism, whereby a client of the <tt>NodeStore</tt> can request Oak to ensure that the repository state (snapshot) at that time can be preserved, and not removed by the revision garbage collection process. Later, that state can be retrieved from the NodeStore by passing the checkpoint. You can think of a checkpoint as a tag in a git repository, or as a named revision. </p>
<p>Async indexing makes use of checkpoint support to access older repository state. </p></div>
<div class="section">
<h4><a name="Indexing_Lane"></a><a name="indexing-lane"></a> Indexing Lane</h4>
<p>The term &#x201c;indexing lane&#x201d; refers to a set of indexes which are to be updated by a given async indexer. Each index definition meant for async indexing defines an <tt>async</tt> property, whose value is the name of the indexing lane. For example, consider following two index definitions:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/userIndex
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - async = &quot;async&quot;

/oak:index/assetIndex
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - async = &quot;fulltext-async&quot;
</pre></div></div>
<p>Here, <i>userIndex</i> is bound to the &#x201c;async&#x201d; indexing lane, while <i>assetIndex</i> is bound to the &#x201c;fulltext-async&#x201d; lane. Oak <a href="#async-index-setup">setup</a> configures two <tt>AsyncIndexUpdate</tt> jobs: one for &#x201c;async&#x201d;, and one for &#x201c;fulltext-async&#x201d;. When the job for &#x201c;async&#x201d; is run, it only processes index definition where the <tt>async</tt> value is <tt>async</tt>, while when the job for &#x201c;fulltext-async&#x201d; is run, it only pick up index definitions where the <tt>async</tt> value is <tt>fulltext-async</tt>.</p>
<p>These jobs can be scheduled to run at different intervals, and also on different cluster nodes. Each job keeps its own bookkeeping of checkpoint state, and can be <a href="#async-index-mbean">paused and resumed</a> separately.</p>
<p>Prior to Oak 1.4, there was only one indexing lane: <tt>async</tt>. In Oak 1.4, support was added to create two lanes: <tt>async</tt> and <tt>fulltext-async</tt>. With 1.6, it is possible to <a href="#async-index-setup">create multiple lanes</a>. </p></div>
<div class="section">
<h4><a name="Clustered_Setup"></a><a name="cluster"></a> Clustered Setup</h4>
<p>In a clustered setup, one needs to ensure in the host application that the async indexing jobs for all lanes are run as singleton in the cluster. If <tt>AsyncIndexUpdate</tt> for the same lane is executed concurrently on different cluster nodes, it leads to race conditions, where an old checkpoint gets lost, leading to reindexing.</p>
<p>See also <a href="../clustering.html#scheduled-jobs">clustering</a> for more details on how the host application should schedule such indexing jobs.</p>
<div class="section">
<h5><a name="Indexing_Lease"></a><a name="async-index-lease"></a> Indexing Lease</h5>
<p><tt>AsyncIndexUpdate</tt> has an in-built &#x201c;lease&#x201d; logic to ensure that even if the jobs gets scheduled to run on different cluster nodes, only one of them runs. This is done by keeping a lease property, which gets periodically updated as indexing progresses. </p>
<p>An <tt>AsyncIndexUpdate</tt> run skips indexing if the current lease has not expired. If the last update of the lease was done too long ago (default: more than 15 minutes), it is assumed that cluster node that is supposed to index is not available, and some other node will take over.</p>
<p>The lease logic can delay the start of indexing if the system is not stopped cleanly. As of Oak 1.6, this does not affect non-clustered setups like those based on SegmentNodeStore, but only <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-5159">affects DocumentNodeStore</a> based setups.</p></div></div>
<div class="section">
<h4><a name="Indexing_Lag"></a><a name="async-index-lag"></a> Indexing Lag</h4>
<p>Async indexing jobs are by default configured to run at an interval of 5 seconds. Depending on the system load and diff size of content to be indexed, the indexing may start lagging by a longer time interval. Due to this, the indexing results can lag behind the repository state, and may become stale, that means new content added will only show up in query results after a longer time.</p>
<p>The <tt>IndexStats</tt> MBean keeps a time series and metrics stats for the indexing frequency. This can be used to track the indexing state.</p>
<p><a href="#nrt-indexing">NRT Indexing</a> introduced in Oak 1.6 helps in such situations, and can keep the results more up to date.</p></div>
<div class="section">
<h4><a name="Setup"></a><a name="async-index-setup"></a> Setup</h4>
<p><tt>@since Oak 1.6</tt></p>
<p>Async indexers can be configure via the OSGi config for <tt>org.apache.jackrabbit.oak.plugins.index.AsyncIndexerService</tt>.</p>
<p><img src="async-index-config.png" alt="Async Indexing Config" /></p>
<p>Different lanes can be configured by adding more rows of <i>Async Indexer Configs</i>. Prior to 1.6, the indexers were created programatically while constructing Oak.</p></div>
<div class="section">
<h4><a name="Async_Indexing_MBean"></a><a name="async-index-mbean"></a> Async Indexing MBean</h4>
<p>For each configured async indexer in the setup, the indexer exposes a <tt>IndexStatsMBean</tt>, which provides various stats around the current indexing state:</p>

<div class="source">
<div class="source"><pre class="prettyprint">org.apache.jackrabbit.oak: async (IndexStats)
org.apache.jackrabbit.oak: fulltext-async (IndexStats)
</pre></div></div>
<p>It provide the following details:</p>

<ul>
  
<li>FailingIndexStats - Stats around indexes which are <a href="#corrupt-index-handling">failing and marked as corrupt</a>.</li>
  
<li>LastIndexedTime - Time up to which the repository state has been indexed.</li>
  
<li>Status - running, done, failing etc.</li>
  
<li>Failing - boolean flag indicating that indexing has been failing due to some issue.  This can be monitored for detecting if indexer is healthy or not.</li>
  
<li>ExecutionCount - Time series data around the number of runs for various time intervals.</li>
</ul>
<p>Further it provides the following operations:</p>

<ul>
  
<li>pause - Pauses the indexer.</li>
  
<li>abortAndPause - Aborts any running indexing cycle and pauses the indexer.  Invoke &#x2018;resume&#x2019; once you are ready to resume indexing again.</li>
  
<li>resume - Resume indexing.</li>
</ul></div>
<div class="section">
<h4><a name="Isolating_Corrupt_Indexes"></a><a name="corrupt-index-handling"></a> Isolating Corrupt Indexes</h4>
<p><tt>Since 1.6</tt></p>
<p>The <tt>AsyncIndexerService</tt> marks any index which fails to update for 30 minutes (configurable) as <tt>corrupt</tt>, and ignore such indexes from further indexing. </p>
<p>When any index is marked as corrupt, the following log entry is made:</p>

<div class="source">
<div class="source"><pre class="prettyprint">2016-11-22 12:52:35,484 INFO  NA [async-index-update-fulltext-async] o.a.j.o.p.i.AsyncIndexUpdate - 
Marking [/oak:index/lucene] as corrupt. The index is failing since Tue Nov 22 12:51:25 IST 2016, 
1 indexing cycles, failed 7 times, skipped 0 time 
</pre></div></div>
<p>Post this, when any new content gets indexed and any such corrupt index is skipped, the following warn entry is made:</p>

<div class="source">
<div class="source"><pre class="prettyprint">2016-11-22 12:52:35,485 WARN  NA [async-index-update-fulltext-async] o.a.j.o.p.index.IndexUpdate - 
Ignoring corrupt index [/oak:index/lucene] which has been marked as corrupt since 
[2016-11-22T12:51:25.492+05:30]. This index MUST be reindexed for indexing to work properly 
</pre></div></div>
<p>This info is also seen in the MBean</p>
<p><img src="corrupt-index-mbean.png" alt="Corrupt Index stats in IndexStatsMBean" /></p>
<p>Later, once the index is reindexed, the following log entry is made</p>

<div class="source">
<div class="source"><pre class="prettyprint">2016-11-22 12:56:25,486 INFO  NA [async-index-update-fulltext-async] o.a.j.o.p.index.IndexUpdate - 
Removing corrupt flag from index [/oak:index/lucene] which has been marked as corrupt since 
[corrupt = 2016-11-22T12:51:25.492+05:30] 
</pre></div></div>
<p>This feature can be disabled by setting <tt>failingIndexTimeoutSeconds</tt> to 0 in the <tt>AsyncIndexService</tt> config. See also <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-4939">OAK-4939</a> for more details.</p></div></div>
<div class="section">
<h3><a name="Near_Real_Time_Indexing"></a><a name="nrt-indexing"></a> Near Real Time Indexing</h3>
<p><tt>@since Oak 1.6</tt></p>
<p><i>This mode is only supported for <tt>lucene</tt> indexes</i></p>
<p>Lucene indexes perform well for evaluating complex queries, and have the benefit of being evaluated locally with copy-on-read support. However, they are <tt>async</tt>, and depending on system load can lag behind the repository state. For cases where such lag (which can be in the order of minutes) is not acceptable, one must use <tt>property</tt> indexes. To avoid that, Oak 1.6 has <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-4412">added support for near real time indexing</a></p>
<p><img src="index-nrt.png" alt="NRT Index Flow" /></p>
<p>In this mode, the indexing happen in two modes, and a query will consult multiple indexes. The diagram above shows the indexing flow with time. In the above flow:</p>

<ul>
  
<li>T1, T3 and T5 - Time instances at which checkpoints are created.</li>
  
<li>T2 and T4 - Time instance when async indexer runs completed and indexes were updated.</li>
  
<li>Persisted Index:
  
<ul>
    
<li>v2 - Index version v2, which has repository state indexed up to T1.</li>
    
<li>v3 - Index version v2, which has repository state indexed up to T3.</li>
  </ul></li>
  
<li>Local Index:
  
<ul>
    
<li>NRT1 - Local index, which has repository state indexed between T2 and T4.</li>
    
<li>NRT2 - Local index, which has repository state indexed between T4 and T6.</li>
  </ul></li>
</ul>
<p>As the repository state changes with time, the Async indexer will run and index the changes between the last known checkpoint and current state when that run started. So when async run 1 completed, the persisted index has the repository state indexed up to T3.</p>
<p>Now without NRT index support, if any query is performed between T2 and T4, it can only see index results for the repository state at T1, as that is the state where the persisted indexes have data for. Any change after that cannot be seen until the next async indexing cycle is complete (at T4). </p>
<p>With NRT indexing support, indexing will happen at two places:</p>

<ul>
  
<li>Persisted Index - This is the index which is updated via the async indexer run.  This flow remains the same, it will be periodically updated by the indexer run.</li>
  
<li>Local Index - In addition to persisted index, each cluster node will also maintain a local index.  This index only keeps data between two async indexer runs.  Post each run, the previous index is discarded, and a new index is built  (actually, the previous index is retained for one cycle).</li>
</ul>
<p>Any query making use of such an index will automatically make use of both the persisted and the local indexes. With this, new content added in the repository after the last async index run will also show up quickly.</p>
<div class="section">
<h4><a name="Usage"></a><a name="nrt-indexing-usage"></a> Usage</h4>
<p>NRT (Near real time) indexing can be enabled for an index by configuring the <tt>async</tt> property:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/assetIndex
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - async = ['fulltext-async', 'nrt']
</pre></div></div>
<p>Here, <tt>async</tt> has been set to a multi-valued property, with the</p>

<ul>
  
<li>Indexing lane - For example <tt>async</tt> or <tt>fulltext-async</tt>,</li>
  
<li>NRT Indexing Mode - <tt>nrt</tt> or <tt>sync</tt>.</li>
</ul>
<div class="section">
<h5><a name="NRT_Indexing_Mode_-_nrt"></a><a name="nrt-indexing-mode-nrt"></a> NRT Indexing Mode - nrt</h5>
<p>In this mode, the local index is updated asynchronously on that cluster nodes post each commit, and the index reader is refreshed each second. So, any change done should show up on that cluster node within 1 to 2 seconds.</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/userIndex
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - async = ['async', 'nrt']
</pre></div></div></div>
<div class="section">
<h5><a name="NRT_Indexing_Mode_-_sync"></a><a name="nrt-indexing-mode-sync"></a> NRT Indexing Mode - sync</h5>
<p>In this mode, the local index is updated synchronously on that cluster nodes post each commit, and the index reader is refreshed immediately. This mode indexes more slowly compared to the &#x201c;nrt&#x201d; mode.</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/userIndex
  - jcr:primaryType = &quot;oak:QueryIndexDefinition&quot;
  - async = ['async', 'sync']
</pre></div></div>
<p>For a single node setup (for example with the <tt>SegmentNodeStore</tt>), this mode effectively makes async lucene index perform same as synchronous property indexes. However, the &#x2018;nrt&#x2019; mode performs better, so using that is preferable.</p></div></div>
<div class="section">
<h4><a name="Cluster_Setup"></a><a name="nrt-indexing-cluster-setup"></a> Cluster Setup</h4>
<p>In cluster setup, each cluster node maintains its own local index for changes happening in that cluster node. In addition to that, it also indexes changes from other cluster nodes by relying on <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-4808">Oak observation for external changes</a>. This depends on how frequently external changes are delivered. Due to this, even with NRT indexing changes from other cluster nodes will take some more time to be reflected in query results compared to local changes.</p></div>
<div class="section">
<h4><a name="Configuration"></a><a name="nrt-indexing-config"></a> Configuration</h4>
<p>NRT indexing expose a few configuration options as part of the <a href="lucene.html#osgi-config">LuceneIndexProviderService</a>:</p>

<ul>
  
<li><tt>enableHybridIndexing</tt> - Boolean property, defaults to <tt>true</tt>.  Can be set to <tt>false</tt> to disable the NRT indexing feature completely.</li>
  
<li><tt>hybridQueueSize</tt> - The size of the in-memory queue used  to hold Lucene documents for indexing in the <tt>nrt</tt> mode.  The default size is 10000.</li>
</ul></div></div></div>
<div class="section">
<h2><a name="Reindexing"></a><a name="reindexing"></a> Reindexing</h2>
<p>Reindexing rarely solves problems. Specially, it does not typically make queries return the expected result. For such cases, it is <i>not</i> recommended to reindex, also because reindex can be very slow (sometimes multiple days), and use a lot of temporary disk space. Note that removing checkpoints, and removing the hidden <tt>:async</tt> node will cause a full reindex, so doing this is not recommended either. If queries don&#x2019;t return the right data, then possibly the index is <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-5159">not yet up-to-date</a>, or the query is incorrect, or included/excluded path settings are wrong (for Lucene indexes). Instead of reindexing, it is suggested to first check the log file, modify the query so it uses a different index or traversal, and run the query again.</p>
<p>Reindexing of existing indexes is required in the following scenarios:</p>

<ul>
  
<li>A: In case a <i>property</i> index configuration was changed,  such that the index is used for queries, but doesn&#x2019;t contain some of the nodes.  Nodes that existed <i>before</i> the index configuration was changed, are not indexed.  A workaround is to change (&#x2018;touch&#x2019;) the affected nodes.</li>
  
<li>B: Prior to Oak 1.6, in case a <i>Lucene</i> index definition was changed (same as A).  In Oak 1.6 and newer, queries will use the old index definition  until the index is <a href="lucene.html#stored-index-definition">reindexed</a>.</li>
  
<li>C: Prior to Oak 1.2.15 / 1.4.2, in case the query engine picks a very slow index  for some queries because the counter index (<tt>/oak:index/counter</tt>)  <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-4065">got out of sync after adding and removing lots of nodes many times</a>.  For this case, it is recommended to verify the contents of the counter index first,  and upgrade Oak before reindexing.  To view the content, use the NodeCounter JMX bean and  run <tt>getEstimatedChildNodeCounts</tt> with p1 = <tt>/</tt> and p2 = <tt>2</tt>.  If there is a problem, then the estimated node count of root node typically is very low,  more than 10 times lower than the sum of its children.  Only the <tt>counter</tt> index needs to be reindexed in this case.  The workaround (to avoid reindexing) is to manually tweak index configurations  using manually set <tt>entryCount</tt> of the index that should be used to a low value  (as high as possible so that the index is still needed), for example to 100 or 1000.</li>
  
<li>D: In case a binary of a Lucene index (a Lucene index file) is missing,  for example because the binary is not available in the datastore.  This can happen in case the datastore is misconfigured  such that garbage collection removed a binary that is still required.  In such cases, other binaries might be missing as well;  it is best to traverse all nodes of the repository to ensure this is not the case.</li>
  
<li>E: In case a binary of a Lucene index (a Lucene index file) is corrupt.  If the index is corrupt, an <tt>AsyncIndexUpdate</tt> run will fail  with an exception saying a Lucene index file is corrupt.  In such a case, first verify that the following procedure doesn&#x2019;t resolve  the issue: stop Oak, remove the local copy of the Lucene index (directory <tt>index</tt>),  and restart. If the index is still corrupt after this, then reindexing is needed.  In such cases, please file an Oak issue.</li>
  
<li>F: Prior to Oak 1.2.24 / 1.4.13 / 1.6.1,  when using the document store (MongoDB or RDBMK)  in combination with a large transaction (a commit that changed or added many thousand nodes),  and if one of the parent nodes had more than 100 child nodes,  then indexes (all types) <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-5557">did not see those changes in some cases</a>.</li>
  
<li>G: Prior to Oak 1.4.7, when repository sidegrade was used to do <i>partial</i> migrations,  that is migrating data without migrating related indexes.  In this case, the property indexes need to be either fully rebuilt,  or (as an alternative) copy or migrate the content again using a newer version of Oak.  See also <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-4684">OAK-4684</a>.</li>
  
<li>H: If a binary is missing after reindexing.  This can happen in the following case:  When reindexing or creating a new index takes multiple days,  and during that time, after one day or later, datastore garbage collection was run concurrently.  Some binaries created during by reindexing can get missing because  datastore garbage collection removes unreferenced binaries older than one day.  Indexing or reindexing using oak-run is not affected by this.</li>
  
<li>I: Prior to Oak 1.0.27 / 1.2.11,  if an index file gets larger than 2 GB, then possibly the index can not be opened  (exception &#x201c;Invalid seek request&#x201d;), and subsequently the index might get corrupt.  See also <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-3911">OAK-3911</a>.</li>
</ul>
<p>New indexes are built automatically once the index definition is stored. To reindex an <i>existing</i> index (when needed), set the <tt>reindex</tt> property to <tt>true</tt> in the respective index definition:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/userIndex
  - reindex = true
</pre></div></div>
<p>Once changes are saved, the index is reindexed. For asynchronous indexes, reindex starts with the next async indexing cycle. For synchronous indexes, the reindexing is done as part of save (or commit) itself. For a (synchronous) property index, as an alternative you can use the <tt>PropertyIndexAsyncReindexMBean</tt>; see the <a href="property-index.html#reindexing">reindeinxing property indexes</a> section for more details on that.</p>
<p>Once reindexing starts, the following log entries can be seen in the log:</p>

<div class="source">
<div class="source"><pre class="prettyprint">[async-index-update-async] o.a.j.o.p.i.IndexUpdate Reindexing will be performed for following indexes: [/oak:index/userIndex]
[async-index-update-async] o.a.j.o.p.i.IndexUpdate Reindexing Traversed #100000 /home/user/admin 
[async-index-update-async] o.a.j.o.p.i.AsyncIndexUpdate [async] Reindexing completed for indexes: [/oak:index/userIndex*(4407016)] in 30 min 
</pre></div></div>
<p>Once reindexing is complete, the <tt>reindex</tt> flag is set to <tt>false</tt> automatically.</p>
<div class="section">
<h3><a name="Reducing_Reindexing_Times"></a><a name="reduce-reindexing-times"></a> Reducing Reindexing Times</h3>
<p>If the index being reindexed has full text extraction configured then reindexing can take long time as most of the time is spent in text extraction. For such cases its recommended to use text <a href="pre-extract-text.html">pre-extraction support</a>. The text pre-extraction can be done before starting the actual reindexing. This would then ensure that during reindexing time is not spent in performing text extraction and hence the actual time taken for reindexing such an index gets reduced considerably.</p></div>
<div class="section">
<h3><a name="How_to_Abort_Reindexing"></a><a name="abort-reindex"></a> How to Abort Reindexing</h3>
<p>Building an index can be slow. It can be aborted (stopped before it is finished), for example if you detect there is an error in the index definition. Reindexing and building a new index can be aborted when using asynchronous indexes. For synchronous indexes, it can be stopped if it was started using the <tt>PropertyIndexAsyncReindexMBean</tt>. To do this, use the respective <tt>IndexStats</tt> JMX bean (for example, <tt>async</tt>, <tt>fulltext-async</tt>, or <tt>async-reindex</tt>), and call the operation <tt>abortAndPause()</tt>. Then, either set the <tt>reindex</tt> flag to <tt>false</tt> (for an existing index), remove the index definition (for a new index), or change the index type to <tt>disabled</tt>. Store the change. Finally, call the operation <tt>resume()</tt> so that regular indexing operations can continue.</p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
