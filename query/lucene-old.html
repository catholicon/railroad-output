<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Lucene Index</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../security/overview.html" title="Security">Security</a></li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  --><div class="section">
<h2><a name="Lucene_Index"></a>Lucene Index</h2>
<p><b>Following details are applicable for Oak release 1.0.8 and earlier. For current documentation refer to <a href="lucene.html">Current Lucene documentation</a></b></p>
<p>Oak supports Lucene based indexes to support both property constraint and full text constraints</p>
<div class="section">
<h3><a name="The_Lucene_Full-Text_Index"></a>The Lucene Full-Text Index</h3>
<p>The full-text index handles the &#x2018;contains&#x2019; type of queries:</p>

<div class="source">
<div class="source"><pre class="prettyprint">//*[jcr:contains(., 'text')]
</pre></div></div>
<p>If a full-text index is configured, then all queries that have a full-text condition use the full-text index, no matter if there are other conditions that are indexed, and no matter if there is a path restriction.</p>
<p>If no full-text index is configured, then queries with full-text conditions may not work as expected. (The query engine has a basic verification in place for full-text conditions, but it does not support all features that Lucene does, and it traverses all nodes if there are no indexed constraints).</p>
<p>The full-text index update is asynchronous via a background thread, see <tt>Oak#withAsyncIndexing</tt>. This means that some full-text searches will not work for a small window of time: the background thread runs every 5 seconds, plus the time is takes to run the diff and to run the text-extraction process. </p>
<p>The async update status is now reflected on the <tt>oak:index</tt> node with the help of a few properties, see <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-980">OAK-980</a></p>
<p>TODO Node aggregation <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-828">OAK-828</a></p>
<p>The index definition node for a lucene-based full-text index:</p>

<ul>
  
<li>must be of type <tt>oak:QueryIndexDefinition</tt></li>
  
<li>must have the <tt>type</tt> property set to <b><tt>lucene</tt></b></li>
  
<li>must contain the <tt>async</tt> property set to the value <tt>async</tt>, this is what sends the index update process to a background thread</li>
</ul>
<p><i>Optionally</i> you can add</p>

<ul>
  
<li>what subset of property types to be included in the index via the<br /> <tt>includePropertyTypes</tt> property</li>
  
<li>a blacklist of property names: what property to be excluded from the index  via the <tt>excludePropertyNames</tt> property</li>
  
<li>the <tt>reindex</tt> flag which when set to <tt>true</tt>, triggers a full content re-index.</li>
</ul>
<p>Example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  NodeBuilder index = root.child(&quot;oak:index&quot;);
  index.child(&quot;lucene&quot;)
    .setProperty(&quot;jcr:primaryType&quot;, &quot;oak:QueryIndexDefinition&quot;, Type.NAME)
    .setProperty(&quot;type&quot;, &quot;lucene&quot;)
    .setProperty(&quot;async&quot;, &quot;async&quot;)
    .setProperty(PropertyStates.createProperty(&quot;includePropertyTypes&quot;, ImmutableSet.of(
        PropertyType.TYPENAME_STRING, PropertyType.TYPENAME_BINARY), Type.STRINGS))
    .setProperty(PropertyStates.createProperty(&quot;excludePropertyNames&quot;, ImmutableSet.of( 
        &quot;jcr:createdBy&quot;, &quot;jcr:lastModifiedBy&quot;), Type.STRINGS))
    .setProperty(&quot;reindex&quot;, true);
}
</pre></div></div>
<p><b>Note</b> The Oak Lucene index will only index <i>Strings</i> and <i>Binaries</i> by default. If you need to add another data type, you need to add it to the<br /><i>includePropertyTypes</i> setting, and don&#x2019;t forget to set the <i>reindex</i> flag to true.</p></div>
<div class="section">
<h3><a name="Lucene_Property_Index_Since_1.0.8"></a>Lucene Property Index (Since 1.0.8)</h3>
<p>Oak uses Lucene for creating index to support queries which involve property constraint that is not full-text</p>

<div class="source">
<div class="source"><pre class="prettyprint">select * from [nt:base] where [alias] = '/admin'
</pre></div></div>
<p>To define a property index on a subtree for above query you have to add an index definition </p>

<div class="source">
<div class="source"><pre class="prettyprint">&quot;uuid&quot; : {
        &quot;jcr:primaryType&quot;: &quot;oak:QueryIndexDefinition&quot;,
        &quot;type&quot;: &quot;lucene&quot;,
        &quot;async&quot;: &quot;async&quot;,
        &quot;fulltextEnabled&quot;: false,
        &quot;includePropertyNames&quot;: [&quot;alias&quot;]
    }
</pre></div></div>
<p>The index definition node for a lucene-based full-text index:</p>

<ul>
  
<li>must be of type <tt>oak:QueryIndexDefinition</tt></li>
  
<li>must have the <tt>type</tt> property set to <b><tt>lucene</tt></b></li>
  
<li>must contain the <tt>async</tt> property set to the value <tt>async</tt>, this is what sends the index update process to a background thread</li>
  
<li>must have <tt>fulltextEnabled</tt> set to <tt>false</tt></li>
  
<li>must provide a whitelist of property names which should be indexed via <tt>includePropertyNames</tt></li>
</ul>
<p><i>Note that compared to <a href="query.html#property-index">Property Index</a> Lucene Property Index is always configured in Async mode hence it might lag behind in reflecting the current repository state while performing the query</i></p>
<p>Taking another example. </p>

<div class="source">
<div class="source"><pre class="prettyprint">select
    *
from
    [app:Asset] as a
where
    [jcr:content/jcr:lastModified] &gt; cast('2014-10-01T00:00:00.000+02:00' as date)
    and [jcr:content/metadata/format] = 'image'
order by
    jcr:content/jcr:lastModified
</pre></div></div>
<p>To enable faster execution for above query you can create following Lucene property index </p>

<div class="source">
<div class="source"><pre class="prettyprint">&quot;assetIndex&quot;:
{
  &quot;jcr:primaryType&quot;:&quot;oak:QueryIndexDefinition&quot;,
  &quot;declaringNodeTypes&quot;:&quot;app:Asset&quot;,
  &quot;includePropertyNames&quot;:[&quot;jcr:content/jcr:lastModified&quot; , 
      &quot;jcr:content/metadata/format&quot;],
  &quot;type&quot;:&quot;lucene&quot;,
  &quot;async&quot;:&quot;async&quot;,
  &quot;reindex&quot;:true,
  &quot;fulltextEnabled&quot;:false,
  &quot;orderedProps&quot;:[&quot;jcr:content/jcr:lastModified&quot;]
  &quot;properties&quot;:	{
    &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
    &quot;jcr:content&quot;: {
      &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
      &quot;jcr:lastModified&quot;:	{
        &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
        &quot;type&quot;:&quot;Date&quot;
      }
    }
  }	
}
</pre></div></div>
<p>Above index definition makes use of various features supported by property index</p>

<ul>
  
<li><tt>declaringNodeTypes</tt> - As the query involves nodes of type <tt>app:Asset</tt> index is restricted to only index nodes of type <tt>app:Asset</tt></li>
  
<li><tt>orderedProps</tt> - As the query performs sorting via <tt>order by</tt> clause index is configured with property names which are used in sorting</li>
  
<li><tt>properties</tt> - For ordering to work properly we need to tell the type of property</li>
</ul>
<p>For implementation details refer to <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-2005">OAK-2005</a>. Following sections would provide more details about supported features</p></div>
<div class="section">
<h3><a name="Index_Definition"></a>Index Definition</h3>
<p>Lucene index definition is managed via <tt>NodeStore</tt> and supports following attributes</p>

<dl>
<dt>type</dt>
<dd>Required and should always be <tt>lucene</tt></dd>
<dt>async</dt>
<dd>Required and should always be <tt>async</tt></dd>
<dt>fulltextEnabled</dt>
<dd>For Lucene based property index this should <i>always</i> be set to <tt>false</tt></dd>
<dt>declaringNodeTypes</dt>
<dd>Node type names whose properties should be indexed. If not specified then all  nodes would indexed if they have properties defined in <tt>includePropertyNames</tt>.  For smaller and efficient indexes its recommended that <tt>declaringNodeTypes</tt>  should be specified according to your query needs</dd>
<dt>includePropertyNames</dt>
<dd>List of property name which should be indexed. Property name can be  relative e.g. <tt>jcr:content/jcr:lastModified</tt></dd>
<dt>orderedProps</dt>
<dd>List of property names which would be used in the <tt>order by</tt> clause of the  query</dd>
<dt>includePropertyTypes</dt>
<dd>Used in Lucene Fulltext Index</dd>
<dd>For full text index defaults to <tt>String, Binary</tt></dd>
<dd>List of property types which should be indexed. The values can be one  specified in <a class="externalLink" href="http://www.day.com/specs/jsr170/javadocs/jcr-2.0/constant-values.html#javax.jcr.PropertyType.TYPENAME_STRING">PropertyType Names</a></dd>
<dt><a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-2201">blobSize</a></dt>
<dd>Default value 32768 (32kb)</dd>
<dd>Size in bytes used for splitting the index files when storing them in NodeStore</dd>
<dt>functionName</dt>
<dd>Name to be used to enable index usage with <a href="#native-query">native query support</a></dd>
</dl></div>
<div class="section">
<h3><a name="Property_Definition"></a>Property Definition</h3>
<p>In some cases property specific configurations are required. For example typically while performing order by in query user does not specify the property type. In such cases you need to specify the property type explicitly.</p>
<p>Property definition nodes are created as per there property name under <tt>properties</tt> node of index definition node. For relative properties you would need to create the required path structure under <tt>properties</tt> node. For e.g. for property <tt>jcr:content/metadata/format</tt> you need to create property node at path <tt>&lt;index definition node&gt;/properties/jcr:content/jcr:lastModified</tt></p>

<div class="source">
<div class="source"><pre class="prettyprint">&quot;properties&quot;:
  {
    &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
    &quot;jcr:content&quot;:
    {
      &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
      &quot;jcr:lastModified&quot;:
      {
        &quot;jcr:primaryType&quot;:&quot;oak:Unstructured&quot;,
        &quot;type&quot;:&quot;Date&quot;
      }
    }
  }	
</pre></div></div>

<dl>
<dt>type</dt>
<dd>JCR Property type. Can be one of <tt>Date</tt>, <tt>Boolean</tt>, <tt>Double</tt> or <tt>Long</tt></dd>
<dt>boost</dt>
<dd>The boost value. Defaults to 1.0</dd>
<dd>Since 1.0.9</dd>
</dl></div>
<div class="section">
<h3><a name="Ordering"></a>Ordering</h3>
<p>Lucene property index provides efficient sorting support based on Lucene DocValue fields. To configure specify the list of property names which can be used in the <tt>order by</tt> clause as part of <tt>orderedProps</tt> property.</p>
<p>If the property is of type other than string then you must specify the property definition with <tt>type</tt> details</p>
<p>Refer to <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-2196">Lucene based Sorting</a> for more details. </p>
<p><a name="osgi-config"></a></p></div>
<div class="section">
<h3><a name="LuceneIndexProvider_Configuration"></a>LuceneIndexProvider Configuration</h3>
<p>Some of the runtime aspects of the Oak Lucene support can be configured via OSGi configuration. The configuration needs to be done for PID <tt>org.apache
.jackrabbit.oak.plugins.index.lucene.LuceneIndexProviderService</tt></p>
<p><img src="lucene-osgi-config.png" alt="OSGi Configuration" /></p>

<dl>
<dt>enableCopyOnReadSupport</dt>
<dd>Enable copying of Lucene index to local file system to improve query performance. See <a href="#copy-on-read">Copy Indexes On Read</a></dd>
<dt>localIndexDir</dt>
<dd>Directory to be used for when copy index files to local file system. To be specified when <tt>enableCopyOnReadSupport</tt> is enabled</dd>
<dt>debug</dt>
<dd>Boolean value. Defaults to <tt>false</tt></dd>
<dd>If enabled then Lucene logging would be integrated with Slf4j</dd>
</dl>
<p><a name="non-root-index"></a></p></div>
<div class="section">
<h3><a name="Non_Root_Index_Definitions"></a>Non Root Index Definitions</h3>
<p>Lucene index definition can be defined at any location in repository and need not always be defined at root. For example if your query involves path restrictions like</p>

<div class="source">
<div class="source"><pre class="prettyprint">select * from [app:Asset] as a where ISDESCENDANTNODE(a, '/content/companya') and [format] = 'image'
</pre></div></div>
<p>Then you can create the required index definition say <tt>assetIndex</tt> at <tt>/content/companya/oak:index/assetIndex</tt>. In such a case that index would contain data for the subtree under <tt>/content/companya</tt></p>
<p><a name="native-query"></a></p></div>
<div class="section">
<h3><a name="Native_Query_and_Index_Selection"></a>Native Query and Index Selection</h3>
<p>Oak query engine supports native queries like</p>

<div class="source">
<div class="source"><pre class="prettyprint">//*[rep:native('lucene', 'name:(Hello OR World)')]
</pre></div></div>
<p>If multiple Lucene based indexes are enabled on the system and you need to make use of specific Lucene index like <tt>/oak:index/assetIndex</tt> then you can specify the index name via <tt>functionName</tt> attribute on index definition. </p>
<p>For example for assetIndex definition like </p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  &quot;jcr:primaryType&quot;:&quot;oak:QueryIndexDefinition&quot;,
  &quot;type&quot;:&quot;lucene&quot;,
  ...
  &quot;functionName&quot; : &quot;lucene-assetIndex&quot;,
}
</pre></div></div>
<p>Executing following query would ensure that Lucene index from <tt>assetIndex</tt> should be used</p>

<div class="source">
<div class="source"><pre class="prettyprint">//*[rep:native('lucene-assetIndex', 'name:(Hello OR World)')]
</pre></div></div></div>
<div class="section">
<h3><a name="Persisting_indexes_to_FileSystem"></a>Persisting indexes to FileSystem</h3>
<p>By default Lucene indexes are stored in the <tt>NodeStore</tt>. If required they can be stored on the file system directly</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
  &quot;jcr:primaryType&quot;:&quot;oak:QueryIndexDefinition&quot;,
  &quot;type&quot;:&quot;lucene&quot;,
  ...
  &quot;persistence&quot; : &quot;file&quot;,
  &quot;path&quot; : &quot;/path/to/store/index&quot;
}
</pre></div></div>
<p>To store the Lucene index in the file system, in the Lucene index definition node, set the property <tt>persistence</tt> to <tt>file</tt>, and set the property <tt>path</tt> to the directory where the index should be stored. Then start reindexing by setting <tt>reindex</tt> to <tt>true</tt>.</p>
<p>Note that this setup would only for those non cluster <tt>NodeStore</tt>. If the backend <tt>NodeStore</tt> supports clustering then index data would not be accessible on other cluster nodes</p>
<p><a name="copy-on-read"></a></p></div>
<div class="section">
<h3><a name="CopyOnRead"></a>CopyOnRead</h3>
<p>Lucene indexes are stored in <tt>NodeStore</tt>. Oak Lucene provides a custom directory implementation which enables Lucene to load index from <tt>NodeStore</tt>. This might cause performance degradation if the <tt>NodeStore</tt> storage is remote. For such case Oak Lucene provide a <tt>CopyOnReadDirectory</tt> which copies the index content to a local directory and enables Lucene to make use of local directory based indexes while performing queries.</p>
<p>At runtime various details related to copy on read features are exposed via <tt>CopyOnReadStats</tt> MBean. Indexes at JCR path e.g. <tt>/oak:index/assetIndex</tt> would be copied to <tt>&lt;index dir&gt;/&lt;hash of jcr path&gt;</tt>. To determine mapping between local index directory and JCR path refer to the MBean details</p>
<p><img src="lucene-copy-on-read.png" alt="CopyOnReadStats" /></p>
<p>For more details refer to <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-1724">OAK-1724</a>. This feature can be enabled via <a href="#osgi-config">Lucene Index provider service configuration</a></p></div>
<div class="section">
<h3><a name="Lucene_Index_MBeans"></a>Lucene Index MBeans</h3>
<p>Oak Lucene registers a JMX bean <tt>LuceneIndex</tt> which provide details about the index content e.g. size of index, number of documents present in index etc</p>
<p><img src="lucene-index-mbean.png" alt="Lucene Index MBean" /></p>
<p><a name="luke"></a></p></div>
<div class="section">
<h3><a name="Analyzing_created_Lucene_Index"></a>Analyzing created Lucene Index</h3>
<p><a class="externalLink" href="https://code.google.com/p/luke/">Luke</a> is a handy development and diagnostic tool, which accesses already existing Lucene indexes and allows you to display index details. In Oak Lucene index files are stored in <tt>NodeStore</tt> and hence not directly accessible. To enable analyzing the index files via Luke follow below mentioned steps</p>

<ol style="list-style-type: decimal">
  
<li>
<p>Download the Luke version which includes the matching Lucene jars used by  Oak. As of Oak 1.0.8 release the Lucene version used is 4.7.1. So download the jar from <a class="externalLink" href="https://github.com/DmitryKey/luke/releases">here</a></p>
  
<div class="source">
<div class="source"><pre class="prettyprint">$wget https://github.com/DmitryKey/luke/releases/download/4.7.0/luke-with-deps.jar
</pre></div></div></li>
  
<li>
<p>Use the <a class="externalLink" href="https://github.com/apache/jackrabbit-oak/tree/trunk/oak-run#console">Oak Console</a> to dump the Lucene index from <tt>NodeStore</tt>  to filesystem directory. Use the <tt>lc dump</tt> command</p>
  
<div class="source">
<div class="source"><pre class="prettyprint">$ java -jar oak-run-*.jar console /path/to/oak/repository
Apache Jackrabbit Oak 1.1-SNAPSHOT
Jackrabbit Oak Shell (Apache Jackrabbit Oak 1.1-SNAPSHOT, JVM: 1.7.0_55)
Type ':help' or ':h' for help.
-------------------------------------------------------------------------
/&gt; lc info /oak:index/lucene
Index size : 74.1 MB
Number of documents : 235708
Number of deleted documents : 231
/&gt; lc 
dump   info   
/&gt; lc dump /path/to/dump/index/lucene /oak:index/lucene
Copying Lucene indexes to [/path/to/dump/index/lucene]
Copied 74.1 MB in 1.209 s
/&gt; lc dump /path/to/dump/index/slingAlias /oak:index/slingAlias
Copying Lucene indexes to [/path/to/dump/index/lucene-index/slingAlias]
Copied 8.5 MB in 218.7 ms
/&gt;
</pre></div></div></li>
  
<li>
<p>Post dump open the index via Luke. Oak Lucene uses a <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-1737">custom  Codec</a>. So oak-lucene jar needs to be included in Luke classpath  for it to display the index details</p>
  
<div class="source">
<div class="source"><pre class="prettyprint">$ java -XX:MaxPermSize=512m luke-with-deps.jar:oak-lucene-1.0.8.jar org.getoptuke.Luke
</pre></div></div></li>
</ol>
<p>From the Luke UI shown you can access various details.</p></div>
<div class="section">
<h3><a name="Index_performance"></a>Index performance</h3>
<p>Following are some best practices to get good performance from Lucene based indexes</p>

<ol style="list-style-type: decimal">
  
<li>
<p>Make use on <a href="#non-root-index">non root indexes</a>. If you query always  perform search under certain paths then create index definition under those  paths only. This might be helpful in multi tenant deployment where each tenant  data is stored under specific repository path and all queries are made under  those path.</p></li>
  
<li>
<p>Index only required data. Depending on your requirement you can create  multiple Lucene indexes. For example if in majority of cases you are  querying on various properties specified under <tt>&lt;node&gt;/jcr:content/metadata</tt>  where node belong to certain specific nodeType then create single index  definition listing all such properties and restrict it that nodeType. You  can the size of index via mbean</p></li>
</ol></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
