<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; The Query Engine</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../security/overview.html" title="Security">Security</a></li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li class="active"><a href="#"><span class="none"></span>Query Engine</a>
  </li>
    <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  -->
<!--
TOC created with some help:
grep "^#.*$" src/site/markdown/query/query-engine.md | sed 's/#/    /g' | sed 's/\(#*\) \(.*\)/\1 * [\2](#\2)/g'
--><div class="section">
<h2><a name="The_Query_Engine"></a>The Query Engine</h2>

<ul>
  
<li><a href="#Overview">Overview</a>
  
<ul>
    
<li><a href="#Query_Processing">Query Processing</a>
    
<ul>
      
<li><a href="#Cost_Calculation">Cost Calculation</a></li>
    </ul></li>
    
<li><a href="#Query_Options">Query Options</a>
    
<ul>
      
<li><a href="#Query_Option_Traversal">Query Option Traversal</a></li>
      
<li><a href="#Query_Option_Index_Tag">Query Option Index Tag</a></li>
    </ul></li>
    
<li><a href="#Compatibility">Compatibility</a>
    
<ul>
      
<li><a href="#Result_Size">Result Size</a></li>
      
<li><a href="#Quoting">Quoting</a></li>
      
<li><a href="#Equality_for_Path_Constraints">Equality for Path Constraints</a></li>
    </ul></li>
    
<li><a href="#Slow_Queries_and_Read_Limits">Slow Queries and Read Limits</a></li>
    
<li><a href="#Full-Text_Queries">Full-Text Queries</a></li>
    
<li><a href="#Native_Queries">Native Queries</a></li>
    
<li><a href="#Similarity_Queries">Similarity Queries</a></li>
    
<li><a href="#Spellchecking">Spellchecking</a></li>
    
<li><a href="#Suggestions">Suggestions</a></li>
    
<li><a href="#Facets">Facets</a></li>
    
<li><a href="#XPath_to_SQL-2_Transformation">XPath to SQL-2 Transformation</a></li>
    
<li><a href="#The_Node_Type_Index">The Node Type Index</a></li>
    
<li><a href="#Temporarily_Disabling_an_Index">Temporarily Disabling an Index</a></li>
    
<li><a href="#The_Deprecated_Ordered_Index">The Deprecated Ordered Index</a></li>
    
<li><a href="#Index_Storage_and_Manual_Inspection">Index Storage and Manual Inspection</a></li>
    
<li><a href="#SQL-2_Optimisation">SQL-2 Optimisation</a></li>
    
<li><a href="#Additional_XPath_and_SQL-2_Features">Additional XPath and SQL-2 Features</a></li>
  </ul></li>
</ul></div>
<div class="section">
<h2><a name="Overview"></a>Overview</h2>
<p>Oak does not index as much content by default as does Jackrabbit 2. You need to create custom indexes when necessary, much like in traditional RDBMSs. If there is no index for a specific query, then the repository will be traversed. That is, the query will still work but probably be very slow.</p>
<p>Query Indices are defined under the <tt>oak:index</tt> node.</p>
<div class="section">
<h3><a name="Query_Processing"></a>Query Processing</h3>
<p>Internally, the query engine uses a cost based query optimizer that asks all the available query indexes for the estimated cost to process the query. It then uses the index with the lowest cost.</p>
<p>By default, the following indexes are available:</p>

<ul>
  
<li>A property index for each indexed property.</li>
  
<li>A full-text index which is based on Apache Lucene / Solr.</li>
  
<li>A node type index (which is based on an property index for the properties  jcr:primaryType and jcr:mixins).</li>
  
<li>A traversal index that iterates over a subtree.</li>
</ul>
<p>If no index can efficiently process the filter condition, the nodes in the repository are traversed at the given subtree.</p>
<p>Usually, data is read from the index and repository while traversing over the query result. There are exceptions however, where all data is read in memory when the query is executed. The most common case is when using an <tt>order by</tt> clause and the index can not provide a sorted result. There are other cases where paths of the results read so far are kept in memory, in order to not return duplicate results. This is the case when using <tt>or</tt> conditions such that two indexes are used (internally a <tt>union</tt> query is executed).</p>
<p>If you enable debug logging for the module <tt>org.apache.jackrabbit.oak.query</tt>, you may see this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">cost for nodeType is 1638354.0
cost for property is 2.0
cost for traverse is 3451100.0
</pre></div></div>
<p>This means the cost for the nodetype index <i>would</i> be about 1638354.0, the cost for the property index <i>would</i> be about 2, and the cost for traversal <i>would</i> be about 3451100.0. An index that can&#x2019;t deal with a certain condition will return the cost &#x201c;Infinity&#x201d;. It doesn&#x2019;t say traversal is actually used, it just lists the expected costs. The query engine will then pick the index with the lowest expected cost, which is (in the case above) &#x201c;property&#x201d;.</p>
<p>The expected cost for traversal is, with Oak 1.0.x, really just a guess looking at the length of the path. With Oak 1.2 and newer, the &#x201c;counter&#x201d; index is used (see mainly OAK-1907). There is an known issue with this, if you add and remove a lot of nodes in a loop, you could end up with a too-low cost, see OAK-4065.</p>
<div class="section">
<h4><a name="Cost_Calculation"></a>Cost Calculation</h4>
<p>Each query index is expected to estimate the worst-case cost to query with the given filter. The returned value is between 1 (very fast; lookup of a unique node) and the estimated number of entries to traverse, if the cursor would be fully read, and if there could in theory be one network round-trip or disk read operation per node (this method may return a lower number if the data is known to be fully in memory).</p>
<p>The returned value is supposed to be an estimate and doesn&#x2019;t have to be very accurate. Please note this method is called on each index whenever a query is run, so the method should be reasonably fast (not read any data itself, or at least not read too much data).</p>
<p>If an index implementation can not query the data, it has to return <tt>Infinity</tt> (<tt>Double.POSITIVE_INFINITY</tt>).</p></div></div>
<div class="section">
<h3><a name="Query_Options"></a>Query Options</h3>
<p>With query options, you can enforce the usage of indexes (failing the query if there is no index), and you can limit which indexes should be considered.</p>
<div class="section">
<h4><a name="Query_Option_Traversal"></a>Query Option Traversal</h4>
<p>By default, queries without index will log an info level message as follows (see OAK-4888, since Oak 1.6):</p>

<div class="source">
<div class="source"><pre class="prettyprint">Traversal query (query without index): {statement}; consider creating an index
</pre></div></div>
<p>This message is only logged if no index is available, and if the query potentially traverses many nodes. No message is logged if an index is available, but traversing is cheap.</p>
<p>By setting the JMX configuration <tt>QueryEngineSettings.failTraversal</tt> to true, queries without index throw an exception instead of just logging a message.</p>
<p>In the query itself, the syntax <tt>option(traversal {ok|fail|warn})</tt> is supported (at the very end of the statement, after <tt>order by</tt>). This is to override the default setting, for queries that traverse a well known number of nodes (for example 10 or 20 nodes). This is supported for both XPath and SQL-2, as follows: </p>

<div class="source">
<div class="source"><pre class="prettyprint">/jcr:root/oak:index/*[@type='lucene'] option(traversal ok)

select * from [nt:base] 
where ischildnode('/oak:index') 
order by name()
option(traversal ok)
</pre></div></div></div>
<div class="section">
<h4><a name="Query_Option_Index_Tag"></a>Query Option Index Tag</h4>
<p><tt>@since Oak 1.7.4 (OAK-937)</tt></p>
<p>By default, queries will use the index with the lowest expected cost (as in relational databases). But in rare cases, it is needed to specify which index(es) should be considered for a query:</p>

<ul>
  
<li>If there are multiple Lucene fulltext indexes with different aggregation rules,  and the index data overlaps.  In the query, you want to specify which aggregation rule to use.</li>
  
<li>To temporarily work around limitations of the index implementation,  for example incorrect cost estimation.</li>
</ul>
<p>Using index tags should be the exception, and should only be used temporarily. To use index tags, add <tt>tags</tt> (a multi-valued String property) to the index(es) of choice, for example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/oak:index/lucene/tags = [x, y]
</pre></div></div>
<p>Note each index can have multiple tags, and the same tag can be used in multiple indexes. The syntax to limit a query to a certain tag is: <tt>&lt;query&gt; option(index tag &lt;tagName&gt;)</tt>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/jcr:root/content//element(*, nt:file)[jcr:contains(., 'test')] option(index tag x)

select * from [nt:file] 
where ischildnode('/content')
and contains(*, 'test')
option(index tag [x])
</pre></div></div>
<p>The query will only consider the indexes that contain the specified tag (that is, possibly multiple indexes). Each query supports one tag only. The tag name may only contain the characters <tt>a-z, A-Z, 0-9, _</tt>.</p>
<p>Limitations:</p>

<ul>
  
<li>This is currently supported in indexes of type <tt>lucene</tt> compatVersion 2, and type <tt>property</tt>.</li>
  
<li>For indexes of type <tt>lucene</tt>, when adding adding or changing the property <tt>tags</tt>,  you need to also set the property <tt>refresh</tt> to <tt>true</tt> (Boolean),  so that the change is applied. No indexing is required.</li>
  
<li>Solr indexes, and the reference index, don&#x2019;t support tags yet.  That means they still might return a low cost, even if the tag does not match.</li>
  
<li>The nodetype index only partially supports this feature: if a tag is specified in the query, then the nodetype index  is not used. However, tags in the nodetype index itself are ignored currently.</li>
  
<li>There is currently no way to disable traversal that way.  So if the expected cost of traversal is very low, the query will traverse.  Note that traversal is never used for fulltext queries.</li>
</ul></div></div>
<div class="section">
<h3><a name="Compatibility"></a>Compatibility</h3>
<div class="section">
<h4><a name="Result_Size"></a>Result Size</h4>
<p>For NodeIterator.getSize(), some versions of Jackrabbit 2.x returned the estimated (raw) Lucene result set size, including nodes that are not accessible.</p>
<p>By default, Oak does not do this; it either returns the correct result size, or -1. Oak 1.2.x and newer supports a compatibility flag so that it works in a similar way as Jackrabbit 2.x, by returning an estimate (see OAK-2926). Specially, only query restrictions that are part of the used index are considered when calculating the size. Additionally, ACLs are not applied to the results, so nodes which are not visible to the current session will still be included in the count returned. As such, the count returned can be higher than the actual number of results and the accurate count can only be determined by iterating through the results.</p>
<p>This only works with the Lucene <tt>compatVersion=2</tt> right now, so even if enabled, getSize may still return -1 if the index used does not support the feature. Example code to show how this work (where <tt>test</tt> is a common word in the index):</p>

<div class="source">
<div class="source"><pre class="prettyprint">String query = &quot;//element(*, cq:Page)[jcr:contains(., 'test')]&quot;;
Query query = queryManager.createQuery(qs, &quot;xpath&quot;);
QueryResult result = query.execute();
long size = result.getRows().getSize();
</pre></div></div>
<p>This is best configured via OSGi configuration (since Oak 1.6.x), or as described in OAK-2977, since Oak 1.3.x: When using Apache Sling, add the following line to the file <tt>conf/sling.properties</tt>, and then restart the application:</p>

<div class="source">
<div class="source"><pre class="prettyprint">oak.query.fastResultSize=true
</pre></div></div></div>
<div class="section">
<h4><a name="Quoting"></a>Quoting</h4>
<p><a class="externalLink" href="https://wiki.apache.org/jackrabbit/EncodingAndEscaping">Special characters in queries need to be escaped.</a></p>
<p>However, compared to Jackrabbit 2.x, the query parser is now generally more strict about invalid syntax. The following query used to work in Jackrabbit 2.x, but not in Oak, because multiple way to quote the path are used at the same time:</p>

<div class="source">
<div class="source"><pre class="prettyprint">SELECT * FROM [nt:base] AS s 
WHERE ISDESCENDANTNODE(s, [&quot;/libs/sling/config&quot;])
</pre></div></div>
<p>Instead, the query now needs to be:</p>

<div class="source">
<div class="source"><pre class="prettyprint">SELECT * FROM [nt:base] AS s 
WHERE ISDESCENDANTNODE(s, [/libs/sling/config])
</pre></div></div></div>
<div class="section">
<h4><a name="Equality_for_Path_Constraints"></a>Equality for Path Constraints</h4>
<p>In Jackrabbit 2.x, the following condition was interpreted as a LIKE condition:</p>

<div class="source">
<div class="source"><pre class="prettyprint">SELECT * FROM nt:base WHERE jcr:path = '/abc/%'
</pre></div></div>
<p>Therefore, the query behaves exactly the same as if LIKE was used. In Oak, this is no longer the case, and such queries search for an exact path match.</p></div></div>
<div class="section">
<h3><a name="Slow_Queries_and_Read_Limits"></a>Slow Queries and Read Limits</h3>
<p>Slow queries are logged as follows:</p>

<div class="source">
<div class="source"><pre class="prettyprint">*WARN* Traversed 10000 nodes with filter Filter(query=select ...)
consider creating an index or changing the query
</pre></div></div>
<p>If this is the case, an index might need to be created, or the condition of the query might need to be changed to take advantage of an existing index.</p>
<p>Queries that traverse many nodes, or that read many nodes in memory, can be cancelled. The limits can be set at runtime (also while a slow query is running) using JMX, domain &#x201c;org.apache.jackrabbit.oak&#x201d;, type &#x201c;QueryEngineSettings&#x201d;, attribute names &#x201c;LimitInMemory&#x201d; and &#x201c;LimitReads&#x201d;. These setting are not persisted, so in the next restart, the default values (unlimited) are used. As a workaround, these limits can be changed using the system properties &#x201c;oak.queryLimitInMemory&#x201d; and &#x201c;oak.queryLimitReads&#x201d;. Queries that exceed one of the limits are cancelled with an UnsupportedOperationException saying that &#x201c;The query read more than x nodes&#x2026; To avoid running out of memory, processing was stopped.&#x201d;</p>
<p>&#x201c;LimitReads&#x201d; applies to the number of nodes read by a query. It applies whether or not an index is used. As an example, if a query has just two conditions, as in <tt>a=1 and b=2</tt>, and if there is an index on <tt>a</tt>, then all nodes with <tt>a=1</tt> need to be read while traversing the result. If more nodes are read than the set limit, then an exception is thrown. If the query also has a path condition (for example descendants of <tt>/home</tt>), and if the index supports path conditions (which is the case for all property indexes, and also for Lucene indexes if <tt>evaluatePathRestrictions</tt> is set), then only nodes in the given subtree are read.</p>
<p>&#x201c;LimitInMemory&#x201d; applies to nodes read in memory, in order to sort the result, and in order to ensure the same node is only returned once. It applies whether or not an index is used. As an example, if a query uses <tt>order by c</tt>, and if the index used for this query does not support ordering by this property, then all nodes that match the condition are read in memory first, even before the first node is returned. Property indexed can not order, and Lucene indexes can only order when enabling <tt>ordered</tt> for a property. Ensuring the same node is only returned once: this is needed for queries that contain <tt>union</tt> (it is not needed when using <tt>union all</tt>). It is also needed if a query uses <tt>or</tt> conditions on different properties. For example, if a query uses <tt>a=1 or b=2</tt>, then the conversion to <tt>union</tt> would be <tt>select ... where a=1 union select ... where b=2</tt>. The query is converted to a <tt>union</tt> so that both indexes can be used, in case there are separate indexes for <tt>a</tt> and <tt>b</tt>. For XPath queries, such conversion to <tt>union</tt> is always made, and for SQL-2 queries such a conversion is only made if the <tt>union</tt> query has a lower expected cost. When using <tt>or</tt> in combination with the same property, as in <tt>a=1 or a=2</tt>, then no conversion to <tt>union</tt> is made.</p></div>
<div class="section">
<h3><a name="Full-Text_Queries"></a>Full-Text Queries</h3>
<p>The full-text syntax supported by Jackrabbit Oak is a superset of the JCR specification.</p>
<p>By default (that is, using a Lucene index with <tt>compatVersion</tt> 2), Jackrabbit Oak uses the <a class="externalLink" href="https://lucene.apache.org/core/4_7_1/queryparser/org/apache/lucene/queryparser/classic/package-summary.html">Apache Lucene grammar for fulltext search</a>. <a class="externalLink" href="https://wiki.apache.org/jackrabbit/EncodingAndEscaping">See also how to escape queries.</a></p>
<p>For older Lucene indexes (<tt>compatVersion</tt> 1), the following syntax is supported within <tt>contains</tt> queries. This is a subset of the Apache Lucene syntax:</p>

<div class="source">
<div class="source"><pre class="prettyprint">FullTextSearch ::= Or
Or ::= And { ' OR ' And }* 
And ::= Term { ' ' Term }*
Term ::= ['-'] { SimpleTerm | PhraseTerm } [ '^' Boost ]
SimpleTerm ::= Word
PhraseTerm ::= '&quot;' Word { ' ' Word }* '&quot;'
Boost ::= &lt;number&gt;
</pre></div></div>
<p>Please note that <tt>OR</tt> needs to be written in uppercase. Characters within words can be escaped using a backslash.</p>
<p>Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint">jcr:contains(., 'jelly sandwich^4')
jcr:contains(@jcr:title, 'find this')
</pre></div></div>
<p>In the first example, the word &#x201c;sandwich&#x201d; has weight four times more than the word &#x201c;jelly.&#x201d; For details of boosting, see the Apache Lucene documentation about Score Boosting.</p>
<p>For compatibility with Jackrabbit 2.x, single quoted phrase queries are currently supported. That means the query <tt>contains(., &quot;word ''hello world'' word&quot;)</tt> is supported. New applications should not rely on this feature.</p></div>
<div class="section">
<h3><a name="Native_Queries"></a>Native Queries</h3>
<p>To take advantage of features that are available in full-text index implementations such as Apache Lucene and Apache Lucene Solr, so called <tt>native</tt> constraints are supported. Such constraints are passed directly to the full-text index. This is supported for both XPath and SQL-2. For XPath queries, the name of the function is <tt>rep:native</tt>, and for SQL-2, it is <tt>native</tt>. The first parameter is the index type (currently supported are <tt>solr</tt> and <tt>lucene</tt>). The second parameter is the native search query expression. For SQL-2, the selector name (if needed) is the first parameter, just before the language. Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint">//*[rep:native('solr', 'name:(Hello OR World)')]

select [jcr:path] from [nt:base] 
where native('solr', 'name:(Hello OR World)')

select [jcr:path] from [nt:base] as a 
where native(a, 'solr', 'name:(Hello OR World)')
</pre></div></div>
<p>This also allows to use the Solr <a class="externalLink" href="http://wiki.apache.org/solr/MoreLikeThis">MoreLikeThis</a> feature. An example query is:</p>

<div class="source">
<div class="source"><pre class="prettyprint">select [jcr:path] from [nt:base] 
where native('solr', 'mlt?q=id:UTF8TEST&amp;mlt.fl=manu,cat&amp;mlt.mindf=1&amp;mlt.mintf=1')
</pre></div></div>
<p>If no full-text implementation is available, those queries will fail.</p></div>
<div class="section">
<h3><a name="Similarity_Queries"></a>Similarity Queries</h3>
<p>Oak supports similarity queries when using the Lucene or Solr indexes. For example, the following query will return nodes that have similar content than the node /test/a:</p>

<div class="source">
<div class="source"><pre class="prettyprint">//element(*, nt:base)[rep:similar(., '/test/a')]
</pre></div></div>
<p>Compared to Jackrabbit 2.x, support for rep:similar has the following limitations: Full-text aggregation is not currently supported.</p></div>
<div class="section">
<h3><a name="Spellchecking"></a>Spellchecking</h3>
<p><tt>@since Oak 1.1.17, 1.0.13</tt></p>
<p>Oak supports spellcheck queries when using the Lucene or Solr indexes. Unlike most queries, spellcheck queries won&#x2019;t return a JCR <tt>Node</tt> as the outcome of such queries will be text terms that come from content as written into JCR <tt>properties</tt>. For example, the following query will return spellchecks for the (wrongly spelled) term <tt>helo</tt>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/jcr:root[rep:spellcheck('helo')]/(rep:spellcheck())
</pre></div></div>
<p>The result of such a query will be a JCR <tt>Row</tt> which will contain the corrected terms, as spellchecked by the used underlying index, in a special property named <tt>rep:spellcheck()</tt>.</p>
<p>Clients wanting to obtain spellchecks could use the following JCR code:</p>
<p><tt>@until Oak 1.3.10, 1.2.13</tt> spellchecks are returned flat.</p>

<div class="source">
<div class="source"><pre class="prettyprint">QueryManager qm = ...;
String xpath = &quot;/jcr:root[rep:spellcheck('helo')]/(rep:spellcheck())&quot;;
QueryResult result = qm.createQuery(xpath, Query.XPATH).execute();
RowIterator it = result.getRows();
String spellchecks = &quot;&quot;;
if (it.hasNext()) {
    spellchecks = row.getValue(&quot;rep:spellcheck()&quot;).getString()        
}
</pre></div></div>
<p>The <tt>spellchecks</tt> String would be have the following pattern <tt>\[[\w|\W]+(\,\s[\w|\W]+)*\]</tt>, e.g.:</p>

<div class="source">
<div class="source"><pre class="prettyprint">[hello, hold]
</pre></div></div>
<p><tt>@since Oak 1.3.11, 1.2.14</tt> each spellcheck would be returned per row.</p>

<div class="source">
<div class="source"><pre class="prettyprint">QueryManager qm = ...;
String xpath = &quot;/jcr:root[rep:spellcheck('helo')]/(rep:spellcheck())&quot;;
QueryResult result = qm.createQuery(xpath, Query.XPATH).execute();
RowIterator it = result.getRows();
List&lt;String&gt; spellchecks = new LinkedList&lt;String&gt;();
while (it.hasNext()) {
    spellchecks.add(row.getValue(&quot;rep:spellcheck()&quot;).getString());        
}
</pre></div></div>
<p>If either Lucene or Solr were configured to provide the spellcheck feature, see <a href="lucene.html#Spellchecking">Enable spellchecking in Lucene</a> and <a href="solr.html#Spellchecking">Enable spellchecking in Solr</a></p>
<p>Note that spellcheck terms come already filtered according to calling user privileges, so that users could see spellcheck corrections only coming from indexed content they are allowed to read.</p></div>
<div class="section">
<h3><a name="Suggestions"></a>Suggestions</h3>
<p><tt>@since Oak 1.1.17, 1.0.15</tt></p>
<p>Oak supports search suggestions when using the Lucene or Solr indexes. Unlike most queries, suggest queries won&#x2019;t return a JCR <tt>Node</tt> as the outcome of such queries will be text terms that come from content as written into JCR <tt>properties</tt>. For example, the following query will return search suggestions for the (e.g. user entered) term <tt>in</tt>:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/jcr:root[rep:suggest('in ')]/(rep:suggest())
</pre></div></div>
<p>The result of such a query will be a JCR <tt>Row</tt> which will contain the suggested terms, together with their score, as suggested and scored by the used underlying index, in a special property named <tt>rep:suggest()</tt>.</p>
<p>Clients wanting to obtain suggestions could use the following JCR code:</p>
<p><tt>@until Oak 1.3.10, 1.2.13</tt> suggestions are returned flat.</p>

<div class="source">
<div class="source"><pre class="prettyprint">QueryManager qm = ...;
String xpath = &quot;/jcr:root[rep:suggest('in ')]/(rep:suggest())&quot;;
QueryResult result = qm.createQuery(xpath, Query.XPATH).execute();
RowIterator it = result.getRows();
String suggestions = &quot;&quot;;
if (it.hasNext()) {
    suggestions = row.getValue(&quot;rep:suggest()&quot;).getString()        
}
</pre></div></div>
<p>The <tt>suggestions</tt> String would be have the following pattern <tt>\[\{(term\=)[\w|\W]+(\,weight\=)\d+\}(\,\{(term\=)[\w|\W]+(\,weight\=)\d+\})*\]</tt>, e.g.:</p>

<div class="source">
<div class="source"><pre class="prettyprint">[{term=in 2015 a red fox is still a fox,weight=1.5}, {term=in 2015 my fox is red, 
like mike's fox and john's fox,weight=0.7}]
</pre></div></div>
<p><tt>@since Oak 1.3.11, 1.2.14</tt> each suggestion would be returned per row.</p>

<div class="source">
<div class="source"><pre class="prettyprint">QueryManager qm = ...;
String xpath = &quot;/jcr:root[rep:suggest('in ')]/(rep:suggest())&quot;;
QueryResult result = qm.createQuery(xpath, Query.XPATH).execute();
RowIterator it = result.getRows();
List&lt;String&gt; suggestions = new LinkedList&lt;String&gt;();
while (it.hasNext()) {
    suggestions.add(row.getValue(&quot;rep:suggest()&quot;).getString());        
}
</pre></div></div>
<p>If either Lucene or Solr were configured to provide the suggestions feature, see <a href="lucene.html#Suggestions">Enable suggestions in Lucene</a> and <a href="solr.html#Suggestions">Enable suggestions in Solr</a>. Note that suggested terms come already filtered according to calling user privileges, so that users could see suggested terms only coming from indexed content they are allowed to read.</p></div>
<div class="section">
<h3><a name="Facets"></a>Facets</h3>
<p><tt>@since Oak 1.3.14</tt> Oak has support for <a class="externalLink" href="https://en.wikipedia.org/wiki/Faceted_search">facets</a>. Once enabled (see details for <a href="lucene.html#Facets">Lucene</a> and/or <a href="solr.html#Suggestions">Solr</a> indexes) facets can be retrieved on properties (backed by a proper field in Lucene / Solr) using the following snippet:</p>

<div class="source">
<div class="source"><pre class="prettyprint">String sql2 = &quot;select [jcr:path], [rep:facet(tags)] from [nt:base] &quot; +
                &quot;where contains([jcr:title], 'oak')&quot;);
Query q = qm.createQuery(sql2, Query.JCR_SQL2);
QueryResult result = q.execute();
FacetResult facetResult = new FacetResult(result);
Set&lt;String&gt; dimensions = facetResult.getDimensions(); // { &quot;tags&quot; }
List&lt;FacetResult.Facet&gt; facets = facetResult.getFacets(&quot;tags&quot;);
for (FacetResult.Facet facet : facets) {
    String label = facet.getLabel();
    int count = facet.getCount();
    ...
}
</pre></div></div>
<p>Nodes/Rows can still be retrieved from within the QueryResult object the usual way.</p></div>
<div class="section">
<h3><a name="XPath_to_SQL-2_Transformation"></a>XPath to SQL-2 Transformation</h3>
<p>To support the XPath query language, such queries are internally converted to SQL-2. </p>
<p>Every conversion is logged in <tt>debug</tt> level under the <tt>org.apache.jackrabbit.oak.query.QueryEngineImpl</tt> logger:</p>

<div class="source">
<div class="source"><pre class="prettyprint">org.apache.jackrabbit.oak.query.QueryEngineImpl Parsing xpath statement: 
    //element(*)[@sling:resourceType = 'slingevent:Lock')]
org.apache.jackrabbit.oak.query.QueryEngineImpl XPath &gt; SQL2: 
    select [jcr:path], [jcr:score], * from [nt:base] as a 
    where [sling:resourceType] = 'slingevent:Lock' 
    /* xpath: //element(*)[@sling:resourceType = 'slingevent:Lock' 
    and @lock.created &lt; xs:dateTime('2013-09-02T15:44:05.920+02:00')] */
</pre></div></div>
<p><i>Each transformed SQL-2 query contains the original XPath query as a comment.</i></p>
<p>When converting from XPath to SQL-2, <tt>or</tt> conditions are automatically converted to <tt>union</tt> queries, so that indexes can be used for conditions of the form <tt>a = 'x' or b = 'y'</tt>.</p></div>
<div class="section">
<h3><a name="The_Node_Type_Index"></a>The Node Type Index</h3>
<p>The <tt>NodeTypeIndex</tt> implements a <tt>QueryIndex</tt> using <tt>PropertyIndexLookup</tt>s on <tt>jcr:primaryType</tt> <tt>jcr:mixinTypes</tt> to evaluate a node type restriction on the filter. The cost for this index is the sum of the costs of the <tt>PropertyIndexLookup</tt> for queries on <tt>jcr:primaryType</tt> and <tt>jcr:mixinTypes</tt>.</p></div>
<div class="section">
<h3><a name="Temporarily_Disabling_an_Index"></a>Temporarily Disabling an Index</h3>
<p>To temporarily disable an index (for example for testing), set the index type to <tt>disabled</tt>. Please note that while the index type is not set, the index is not updated, so if you enable it again, it might not be correct. This is specially important for synchronous indexes.</p></div>
<div class="section">
<h3><a name="The_Deprecated_Ordered_Index"></a>The Deprecated Ordered Index</h3>
<p>This index has been deprecated in favour of Lucene Property index. Please refer to <a href="lucene.html">Lucene Index documentation</a> for details.</p>
<p>For help on migrating to a Lucece index please refer to: <a href="ordered-index-migrate.html">Migrate ordered index</a></p>
<p>For historical information around the index please refer to: <a href="ordered-index.html">Ordered Index</a>.</p></div>
<div class="section">
<h3><a name="Index_Storage_and_Manual_Inspection"></a>Index Storage and Manual Inspection</h3>
<p>Sometimes there is a need to inspect the index content for debugging (or pure curiosity). The index content is generally stored as content under the index definition as hidden nodes (this doesn&#x2019;t apply to the solr index). In order to be able to browse down into an index content you need a low level repository tool that allows NodeStore level access. There are currently 2 options: the oak-console (command line tool, works will all existing NodeStore implementations) and the oak-explorer (gui based on java swing, works only with the SegmentNodeStore), both available as run modes of the <a class="externalLink" href="https://github.com/apache/jackrabbit-oak/blob/trunk/oak-run/README.md">oak-run</a> module</p>
<p>The structure of the index is specific to each implementation and is subject to change. What is worth mentioning is that all the <i>*PropertyIndex</i> flavors store the content as unstructured nodes (clear readable text), the <i>Lucene</i> index is stored as binaries, so one would need to export the entire Lucene directory to the local file system and browse it using a dedicated tool.</p></div>
<div class="section">
<h3><a name="SQL-2_Optimisation"></a>SQL-2 Optimisation</h3>

<div class="source">
<div class="source"><pre class="prettyprint">@since 1.3.9 with -Doak.query.sql2optimisation
</pre></div></div>
<p>Enabled by default in 1.3.11 it will perform a round of optimisation on the <tt>Query</tt> object obtained after parsing a SQL-2 statement. It will for example attempt a conversion of OR conditions into UNION <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-1617">OAK-1617</a>.</p>
<p>To disable it provide <tt>-Doak.query.sql2optimisation=false</tt> at the start-up.</p></div>
<div class="section">
<h3><a name="Additional_XPath_and_SQL-2_Features"></a>Additional XPath and SQL-2 Features</h3>
<p>The Oak implementation supports some features that are not part of the JCR specification:</p>

<div class="source">
<div class="source"><pre class="prettyprint">@since 1.5.12
</pre></div></div>
<p>Union for XPath and SQL-2 queries. Examples:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/jcr:root/(content|lib)/*
/jcr:root/content//*[@a] | /jcr:root/lib//*[@b]) order by @c
select * from [nt:base] as a where issamenode(a, '/content') 
union select * from [nt:base] as a where issamenode(a, '/lib')
</pre></div></div>
<p>XPath functions &#x201c;fn:string-length&#x201d; and &#x201c;fn:local-name&#x201d;.</p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
