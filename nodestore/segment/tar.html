<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Structure of TAR files</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
      <script type="text/javascript" src="../../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../../"  title="Oak logo"><img src="../../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../../license.html" title="License">License</a></li>
            <li><a href="../../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../../security/overview.html" title="Security">Security</a></li>
            <li><a href="../../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../../migration.html" title="Migration">Migration</a></li>
            <li><a href="../../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../participating.html" title="Participating">Participating</a></li>
            <li><a href="../../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><h1>Structure of TAR files</h1>
<p>Here is described the physical layout of a TAR file as used by Apache Oak. First, a brief introduction of the TAR format is given. Next, more details are provided about the low level information that is written in TAR entries. Finally, it&#x2019;s described how Oak saves a graph data structure inside the TAR file and how this representation is optimized for fast retrieval.</p>
<div class="section">
<h2><a name="Organization_of_a_TAR_file"></a>Organization of a TAR file</h2>
<p>Physically speaking, a TAR file is a linear sequence of blocks. A TAR file is terminated by two blocks containing zero bytes. Every block has a size of 512 bytes.</p>
<p>Logically speaking, a TAR file is a linear sequence of entries. Every entry is represented by two or more blocks. The first block always contains the entry header. Subsequent blocks store the content of the file.</p>
<p><img src="tar.png" alt="Overview of a TAR file" /></p>
<p>The entry header is composed of the following fields:</p>

<ul>
  
<li>
<p>file name (100 bytes) - name of the file stored in this entry.</p></li>
  
<li>
<p>file mode (8 bytes) - string representation of the octal file mode.</p></li>
  
<li>
<p>owner&#x2019;s numeric ID (8 bytes) - string representation of the user ID of the  owner of the file.</p></li>
  
<li>
<p>group&#x2019;s numeric ID (8 bytes) - string representation of the group ID of the  owner of the file.</p></li>
  
<li>
<p>file size (12 bytes) - string representation of the octal size of the file.</p></li>
  
<li>
<p>last modification time (12 bytes) - string representation of the octal time  stamp when the file was last modified.</p></li>
  
<li>
<p>checksum (8 bytes) - checksum for the header data.</p></li>
  
<li>
<p>file type (1 byte) - type of the file stored in the entry. This field  specifies if the file is a regular file, a hard link or a symbolic link.</p></li>
  
<li>
<p>name of linked file (1 byte) - in case the file stored in the entry is a link,  this field stores the name of the file pointed to by the link.</p></li>
</ul></div>
<div class="section">
<h2><a name="The_TAR_file_as_used_by_Oak"></a>The TAR file as used by Oak</h2>
<p>Some fields are not used by Oak. In particular, Oak sets the file mode, the owner&#x2019;s numeric ID, the group&#x2019;s numeric ID, the checksum, and the name of linked file to uninteresting values. The only meaningful values assigned to the fields of the entry header are:</p>

<ul>
  
<li>
<p>file name: the name of the data file. There are different data files used by  Oak. They are described below.</p></li>
  
<li>
<p>file size: the size of the data file. The value assigned to this field is  trivially computed from the amount of information stored in the data file.</p></li>
  
<li>
<p>last modification time: the time stamp when the entry was written.</p></li>
</ul>
<p>There are four kinds of files stored in a TAR file:</p>

<ul>
  
<li>
<p>segments: this type of file contains data about a segment in the segment  store. This kind of file has a file name in the form <tt>UUID.CRC2</tt>, where <tt>UUID</tt>  is a 128 bit UUID represented as an hexadecimal string and <tt>CRC2</tt> is a zero-  padded numeric string representing the CRC2 checksum of the raw segment data.</p></li>
  
<li>
<p>binary references: this file has a name ending in <tt>.brf</tt> and represents a  catalog of blobs (i.e. value records) referenced by segments in this TAR file.  This catalog is indexed by the generation of the segments it contains.</p></li>
  
<li>
<p>graph: this file has a name ending in <tt>.gph</tt> and contains the segment graph  of all the segments in this tar file. The graph is represented as an adjacency  list of UUIDs.</p></li>
  
<li>
<p>index: this file has a name ending in <tt>.idx</tt> and contains a sorted list of  every segment contained in the TAR file.</p></li>
</ul></div>
<div class="section">
<h2><a name="Oak_TAR_file_layout"></a>Oak TAR file layout</h2>
<p>Before delving into further details, a few words on how Oak names TAR files. The convention is to always start with a <tt>data00000a.tar</tt> file. As data is written to the repository, new TAR files are added with increasing numbers, thus ending up with <tt>data00001a.tar</tt>, <tt>data00002a.tar</tt> and so on.</p>
<p>Each time a compaction cycle ends, there is a cleanup phase in which segments from an old generation are purged. Those tar files that shrink by at least 25% are rewritten to a new tar generation, skipping the reclaimed segments. A shrunk TAR file increases its tail generation character, e.g. from <tt>data00000a.tar</tt> to <tt>data00000b.tar</tt>.</p>
<p>The layout of the TAR file used by Oak is engineered for performance of read operations. In particular, the most important information is stored in the bottom entries. Reading the entries from the bottom of the file, you encounter first the index, then the graph, then the binary references and finally the segment files. The idea is that the index must be read first, because it provides a fast tool to locate segments in the rest of the file. Next comes the graph, that describes how segments relate to each other. Then the binary references index is stored. Last come the segments, whose relative order can be ignored.</p>
<p>At the same time, the layout of the TAR file allows fast append-only operations when writing. Since the relative order of segment files is not important, segment entries can be written in a first come, first served basis. The index at the end of the file will provide a fast way to access them even if they are scattered around the file.</p>
<p>The picture below presents the building blocks of a TAR file as used by Oak. For illustration purposes, an hypothetical TAR file called <tt>data00000a.tar</tt> is dissected.</p>
<p><img src="oaktar.png" alt="Overview of an Oak TAR file" /></p></div>
<div class="section">
<h2><a name="Segment_files"></a>Segment files</h2>
<p>Segment files contain raw data about a segment. Even if there are multiple kinds of segments, a TAR file only distinguishes between data and bulk segments. A bulk segment is always saved as-is in the TAR file, without further processing. A data segment, instead, is inspected to extract references to other segments or to binary content.</p>
<p>A data segment can contain references to other segments. These references are simply stored as a list of UUIDs. The referenced segments can be stored inside the current TAR file or outside of it. In the first case, the referenced segment can be found by inspecting the index. In the second case, an external agent is responsible to find the segment in another TAR file.</p>
<p>The list of segments referenced by a data segment will end up in the graph file. To speed up the process of locating a segment in the list of referenced segment, this list is maintained ordered.</p>
<p>The data segment file is divided in two parts. The first is the header and the second contains the actual records contained in this segment.</p>
<p>The data segment header is divided in three parts:</p>

<ul>
  
<li>
<p>a fixed part (32 bytes) containing:</p>
  
<ul>
    
<li>a magic number (3 bytes): identifies the beginning of a data segment.</li>
  </ul>
  
<ul>
    
<li>version (1 byte): the segment version.</li>
  </ul>
  
<ul>
    
<li>empty bytes (6 bytes): reserved for future use.</li>
  </ul>
  
<ul>
    
<li>generation (4 bytes): generation of the segment, serialized as a big endian  integer.</li>
  </ul>
  
<ul>
    
<li>number of references (4 bytes): number of references to external segments,  serialized as a big endian integer.</li>
  </ul>
  
<ul>
    
<li>number of records (4 bytes): number of records in this segment, serialized  as a big endian integer.</li>
  </ul>
  
<ul>
    
<li>empty bytes (10 bytes): reserved for future use.</li>
  </ul></li>
  
<li>
<p>second part of the header is a variable list of references to external segments.  Here there will be a list of UUIDs - one per referenced segment - matching the  number of references specified in the first part of the header.</p></li>
  
<li>
<p>the third and last part of the header consists of a list of record header  entries, matching the number of records specified in the first part of the  header. Each record header consists of:</p>
  
<ul>
    
<li>record number (4 bytes), serialized as a big endian integer.</li>
  </ul>
  
<ul>
    
<li>record type (1 byte): can be one of <i>LEAF</i>, <i>BRANCH</i>, <i>BUCKET</i>, <i>LIST</i>,  <i>VALUE</i>, <i>BLOCK</i>, <i>TEMPLATE</i>, <i>NODE</i> or <i>BLOB_ID</i>.</li>
  </ul>
  
<ul>
    
<li>record offset (4 bytes), serialized as a big endian integer: offset of the  record counting from the end of the segment. The actual position of the  record can be obtained by computing <tt>(segment size - offset)</tt>.</li>
  </ul></li>
</ul>
<p>After the segment header, the actual records are stored, at the offsets advertised in the corresponding record header stored in the last part of the segment header.</p>
<p>See <a href="records.html">Segments and records</a> for description of the various record types and their format.</p></div>
<div class="section">
<h2><a name="Binary_references_files"></a>Binary references files</h2>
<p>The binary references file represents an index of binary references (blobs) in a TAR file. This index groups the references by generation first and segment ID next.</p>
<p>The format of the binary references file is optimized for reading. The file is stored in reverse order to maintain the most important information at the end of the file. This strategy is inline with the overall layout of the entries in the TAR file.</p>
<p>The binary references file is divided in two parts. The first is a header and the second contains the real data in the catalog.</p>
<p>The binary references header contains the following fields:</p>

<ul>
  
<li>
<p>a magic number (4 bytes): identifies the beginning of a binary references file.</p></li>
  
<li>
<p>size of the whole binary references mapping (4 bytes): number of bytes occupied  by the entire structure holding binary references (per generation, per segment).</p></li>
  
<li>
<p>number of generations (4 bytes): number of different generations of the segments  which refer blobs.</p></li>
  
<li>
<p>checksum (4 bytes): a CRC2 checksum of the content of the binary references  file.</p></li>
</ul>
<p>Immediately after the graph header, the index data is stored. The storage scheme used is the following:</p>

<ul>
  
<li>
<p>generation of all the following segments.</p></li>
  
<li>
<p>number of segment to binary references mappings for the current generation.</p></li>
  
<li>
<p>for each mapping we have:</p>
  
<ul>
    
<li>UUID of the referencing segment.</li>
  </ul>
  
<ul>
    
<li>number of referenced blobs.</li>
  </ul>
  
<ul>
    
<li>an unordered enumeration of blob ids representing blobs referenced by the  current segment.</li>
  </ul></li>
</ul></div>
<div class="section">
<h2><a name="Graph_files"></a>Graph files</h2>
<p>The graph file represents the relationships between segments stored inside or outside the TAR file. The graph is stored as an adjacency list of UUIDs, where each UUID represents a segment. Like the binary references file, the graph file is also stored backwards.</p>
<p>The content of the graph file is divided in two parts: a graph header and a graph adjacency list.</p>
<p>The graph header contains the following fields:</p>

<ul>
  
<li>
<p>a magic number (4 bytes): identifies the beginning of a graph file.</p></li>
  
<li>
<p>size of the graph adjacency list (4 bytes): number of bytes occupied by the  graph adjacency list.</p></li>
  
<li>
<p>number of entries (4 bytes): how many adjacency lists are stored.</p></li>
  
<li>
<p>checksum (4 bytes): a CRC2 checksum of the content of the graph file.</p></li>
</ul>
<p>Immediately after the graph header, the graph adjacency list is stored. The storage scheme used is the following:</p>

<ul>
  
<li>
<p>UUID of the source segment.</p></li>
  
<li>
<p>size of the adjacency list of the source segment.</p></li>
  
<li>
<p>an unordered enumeration of UUIDs representing target segments referenced by  the source segment.</p></li>
</ul></div>
<div class="section">
<h2><a name="Index_files"></a>Index files</h2>
<p>The index file is an ordered list of references to the entries contained in the TAR file. The references are ordered by UUID and they point to the position in the file where the entry is stored. Like the graph file, the index file is also stored backwards.</p>
<p>The index file is divided in two parts. The first is an index header, the second contains the real data about the index.</p>
<p>The index header contains the following fields:</p>

<ul>
  
<li>
<p>a magic number (4 bytes): identifies the beginning of an index file.</p></li>
  
<li>
<p>size for the index (4 bytes): number of bytes occupied by the index data. This  size also contains padding bytes that are added to the index to make it align  with the TAR block boundary.</p></li>
  
<li>
<p>number of entries (4 bytes): how many entries the index contains.</p></li>
  
<li>
<p>checksum (4 bytes): a CRC32 checksum of the content of the index file.</p></li>
</ul>
<p>After the header, the content of the index starts. For every entry contained in the index, the following information is stored:</p>

<ul>
  
<li>
<p>the most significant bits of the UUID (8 bytes).</p></li>
  
<li>
<p>the least significant bits of the UUID (8 bytes).</p></li>
  
<li>
<p>the offset in the TAR file where the TAR entry containing the segment is  located.</p></li>
  
<li>
<p>the size of the entry in the TAR file.</p></li>
  
<li>
<p>the generation of the entry.</p></li>
</ul>
<p>Since the entries in the index are sorted by UUID, and since the UUIDs assigned to the entries are uniformly distributed, when searching an entry by its UUID an efficient algorithm called interpolation search can be used. This algorithm is a variation of binary search. While in binary search the search space (in this case, the array of entry) is halved at every iteration, interpolation search exploits the distribution of the keys to remove a portion of the search space that is potentially bigger than the half of it. Interpolation search is a more natural approximation of the way a person searches in a phone book. If the name to search begins with the letter T, in example, it makes no sense to open the phone book at the half. It is way more efficient, instead, to open the phone book close to the bottom quarter, since names starting with the letter T are more likely to be distributed in that part of the phone book.</p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
