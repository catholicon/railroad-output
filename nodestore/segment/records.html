<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Segments and records</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
      <script type="text/javascript" src="../../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../../"  title="Oak logo"><img src="../../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../../license.html" title="License">License</a></li>
            <li><a href="../../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../../security/overview.html" title="Security">Security</a></li>
            <li><a href="../../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../../migration.html" title="Migration">Migration</a></li>
            <li><a href="../../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../../participating.html" title="Participating">Participating</a></li>
            <li><a href="../../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/documentmk.html" title="Document NodeStore"><span class="icon-chevron-down"></span>Document NodeStore</a>
      <ul class="nav nav-list">
    <li><a href="../../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--><h1>Segments and records</h1>
<p>While <a href="tar.html">TAR files</a> and segments are a coarse-grained mechanism to divide the repository content in more manageable pieces, the real information is stored inside the segments as finer-grained records. This page details the structure of segments and show the binary representation of data stored by Oak.</p>
<div class="section">
<h2><a name="Segments"></a>Segments</h2>
<p>Segments are not created equal. Oak, in fact, distinguishes data and bulk segments, where the former is used to store structured data (e.g. information about node and properties), while the latter contains unstructured data (e.g. the value of binary properties or of very long strings).</p>
<p>It is possible to tell apart a bulk segment from a data segment by just looking at its identifier. A segment identifier is a randomly generated UUID. Segment identifiers are 16 bytes long, but Oak uses 4 bits to set apart bulk segments from data segments. The following bit patterns are used (each <tt>x</tt> represents four random bits):</p>

<ul>
  
<li><tt>xxxxxxxx-xxxx-4xxx-axxx-xxxxxxxxxxxx</tt> data segment UUID</li>
  
<li><tt>xxxxxxxx-xxxx-4xxx-bxxx-xxxxxxxxxxxx</tt> bulk segment UUID</li>
</ul>
<p>(This encoding makes segment UUIDs appear as syntactically valid version 4 random UUIDs specified in RFC 4122.)</p></div>
<div class="section">
<h2><a name="Bulk_segments"></a>Bulk segments</h2>
<p>Bulk segments contain raw binary data, interpreted simply as a sequence of block records with no headers or other extra metadata:</p>

<div class="source">
<div class="source"><pre class="prettyprint">[block 1] [block 2] ... [block N]
</pre></div></div>
<p>A bulk segment whose length is <tt>n</tt> bytes consists of <tt>n div 4096</tt> block records of 4KiB each followed possibly a block record of <tt>n mod 4096</tt> bytes, if there still are remaining bytes in the segment. The structure of a bulk segment can thus be determined based only on the segment length.</p></div>
<div class="section">
<h2><a name="Data_segments"></a>Data segments</h2>
<p>A data segment can be roughly divided in two parts, a header and a data section. The header contains management information about the segment itself, while the data section stores the actual repository data.</p>
<p>Repository data is split into records of different types. Every type is specialized for storing a specific piece of information: node records, template records, map records, list records, etc.</p>
<p>A record is a contiguous sequence of bytes stored at a specific offset inside a segment. A record can have references to other records, where the referenced records can be stored in the same segment or not. Since records can reference each other, a segment actually stores a graph of records.</p>
<p>The segment header also maintains a set of references to <i>root records</i>: those records that are not referenced from any other records in the segment.</p>
<p>The overall structure of a data segment is:</p>

<div class="source">
<div class="source"><pre class="prettyprint">[segment header] [record 1] [record 2] ... [record N]
</pre></div></div>
<p>The segment header and each record is zero-padded to make their size a multiple of four bytes and to align the next record at a four-byte boundary.</p>
<p>The segment header consists of the following fields. All integers are stored in big endian format.</p>

<div class="source">
<div class="source"><pre class="prettyprint">+---------+---------+---------+---------+---------+---------+---------+---------+
| magic bytes: &quot;0aK&quot;          | version | reserved                               
+---------+---------+---------+---------+---------+---------+---------+---------+
  reserved          | generation                            | segrefcount            
+---------+---------+---------+---------+---------+---------+---------+---------+
  segrefcount       | reccount                              | reserved           
+---------+---------+---------+---------+---------+---------+---------+---------+
  reserved                                                                      |
+---------+---------+---------+---------+---------+---------+---------+---------+
| Referenced segment identifiers  (segrefcount x 16 bytes)                      |
|                                                                               |
|                                ......                                         |
|                                                                               |
+---------+---------+---------+---------+---------+---------+---------+---------+
| Record headers  (reccount x 9 bytes)                                          |
|                                                                               |
|                                ......           +---------+---------+---------+
|                                                 | padding (set to 0)          |
+---------+---------+---------+---------+---------+---------+---------+---------+
</pre></div></div>
<p>The first three bytes of a segment always contain the ASCII string &#x201c;0aK&#x201d;, which is intended to make the binary segment data format easily detectable. The next byte indicates the version of the segment format and is currently set to 12.</p>
<p>The <tt>generation</tt> field indicates the segment&#x2019;s generation wrt. to garbage collection. This field is used by the garbage collector to determine whether a segment needs to be retained or can be collected.</p>
<p>The <tt>segrefcount</tt> field indicates how many other segments are referenced by records within this segment. The identifiers of those segments are listed starting at offset 32 of the segment header. This lookup table is used to optimize garbage collection and to avoid having to repeat the 16-byte UUIDs whenever references to records in other segments are made.</p>
<p>The <tt>reccount</tt> field indicates the number of records in this segment. Record headers for each record follow after the segment identifier lookup table. Each header consists of a record number (4 bytes), a record type (1 byte) and a record offset (4 bytes) from the end of the segment.</p></div>
<div class="section">
<h2><a name="Record_numbers_and_offsets"></a>Record numbers and offsets</h2>
<p>Records need a mechanism to reference each other, both from inside the same segment and across different segments. The mechanism used to reference a record is (unsurprisingly) a record identifier.</p>
<p>A record identifier is composed of a <i>segment field</i> and a <i>record number field</i>. The segment field is two-bytes short integer that identifies the segment where the referenced record is stored. The record number field is the number of the record inside the segment identified by the segment field. There are some peculiarities in both the segment and the position field that may not be immediately obvious. The picture below shows how a segment looks like.</p>
<p><img src="segment.png" alt="Overview of a segment" /></p>
<p>The segment field is two bytes long, but a segment identifier is 16 bytes long. To bridge the gap, the segment header contains an array of segment identifiers that is used as a look-up table. The array can store up to <tt>Integer.MAX_VALUE</tt> entries, but two bytes are enough to access every element in the array in practice. In fact, the segment field in a record identifier is just an index in the array of segment identifiers that is used as a look-up table. The segment field can have the special value of <tt>0</tt>. If the segment field is <tt>0</tt>, the referenced record is stored in the current segment.</p>
<p>The record number field is a logical identifier for the record. The logical identifier is used as a lookup key in the record references table in the segment identified by the segment field. Once the correct row in the record references table is found, the record offset can be used to locate the position of the record in the segment.</p>
<p>The offset is relative to the beginning of a theoretical segment which is defined to be 256 KiB. Since records are added from the bottom of a segment to the top (i.e. from higher to lower offsets), and since segments could be shrunk down to be smaller than 256 KiB, the offset has to be normalized with to the following formula.</p>

<div class="source">
<div class="source"><pre class="prettyprint">SIZE - 256 KiB + OFFSET
</pre></div></div>
<p><tt>SIZE</tt> is the actual size of the segment under inspection, and <tt>OFFSET</tt> is the offset looked up from the record references table. The normalized offset can be used to locate the position of the record in the current segment.</p></div>
<div class="section">
<h2><a name="Records"></a>Records</h2>
<p>The content inside a segment is divided in records of different types: blocks, lists, maps, values, templates and nodes. These record types and their internal structures are described in subsections below.</p>
<div class="section">
<h3><a name="Block_records"></a>Block records</h3>
<p>A block record is the simplest form of record, because it is just a plain sequence of bytes up to 4kB. It doesn&#x2019;t even contain a length: it is up to the writer of this record to store the length elsewhere. The only adjustment performed to the data is the alignment. The implementation makes sure that the written sequence of bytes is stored at a position that is a multiple of four.</p>
<p>Block records are used as building blocks of large binary and string values. They are the only record type that can&#x2019;t contain references to other records. Block records are typically stored in <i>bulk segments</i> that consist only of block records and are thus easily identifiable as containing zero references to other segments.</p></div>
<div class="section">
<h3><a name="Value_records"></a>Value records</h3>
<p>Value records have more structure than block records and store data with an additional length and optional references to other records.</p>
<p>The implementation represents value records in different ways depending on the length of the data to be written. If the data is short enough, the record can be written in the simplest way possible: a length field and the data inlined directly in the record.</p>
<p>When the data is too big, instead, it is split into block records written into block segments. The reference to these block records are stored into a list record (see next section), whose identifier is stored inside the value record.</p>
<p>This means that value record represent a good compromise when writing binary or string data. If the data is short enough, it is written in such a way that can be used straight away without further reads in the segment. If the data is too long, instead, it is stored separated from the repository content not to impact the performance of the readers of the segment.</p>
<p>Value records are used for storing names and values of the content tree. Since item names can be thought of as name values and since all JCR and Oak values can be expressed in binary form (strings encoded in UTF-8), it is easiest to simply use that form for storing all values. The size overhead of such a form for small value types like booleans or dates is amortized by the facts that those types are used only for a minority of values in typical content trees and that repeating copies of a value can be stored just once.</p>
<p>There are four types of value records: small, medium, long and external. The small- and medium-sized values are stored in inline form, prepended by one or two bytes that indicate the length of the value. Long values of up to two exabytes (2^61) are stored as a list of block records. Finally an external value record contains the length of the value and a string reference (up to 4kB in length) to some external storage location.</p>
<p>The type of a value record is encoded in the high-order bits of the first byte of the record. These bit patterns are:</p>

<ul>
  
<li><tt>0xxxxxxx</tt>: small value, length (0 - 127 bytes) encoded in 7 bits</li>
  
<li><tt>10xxxxxx</tt>: medium value length (128 - 16511 bytes) encoded in 6 + 8 bits</li>
  
<li><tt>110xxxxx</tt>: long value, length (up to 2^61 bytes) encoded in 5 + 7*8 bits</li>
  
<li><tt>1110xxxx</tt>: external value, reference string length encoded in 4 + 8 bits</li>
</ul></div>
<div class="section">
<h3><a name="List_records"></a>List records</h3>
<p>List records represent a general-purpose list of record identifiers. They are used as building blocks for other types of records, as we saw for value records and as we will see for template records and node records.</p>
<p>The list record is a logical record using two different types of physical records to represent itself:</p>

<ul>
  
<li>
<p>bucket record: this is a recursive record representing a list of at most 255  references. A bucket record can reference other bucket records,  hierarchically, or the record identifiers of the elements to be stored in the  list. A bucket record doesn&#x2019;t maintain any other information exception record  identifiers.</p></li>
  
<li>
<p>list record: this is a top-level record that maintains the size of the list in  an integer field and a record identifier pointing to a bucket.</p></li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">+--------+--------+--------+-----+
| sub-list ID 1            | ... |
+--------+--------+--------+-----+
  |
  v
+--------+--------+--------+-----+--------+--------+--------+
| record ID 1              | ... | record ID 255            |
+--------+--------+--------+-----+--------+--------+--------+
</pre></div></div>
<p>The result is a hierarchically stored immutable list where each element can be accessed in O(log N) time and the size overhead of updating or appending list elements (and thus creating a new immutable list) is also O(log N).</p>
<p>List records are useful to store a list of references to other records. If the list is too big, it is split into different bucket records that may be stored in the same segment or across segments. This guarantees good performance for small lists, without loosing the capability to store lists with a big number of elements.</p></div>
<div class="section">
<h3><a name="Map_records"></a>Map records</h3>
<p>Map records implement a general-purpose unordered map of strings to record identifiers. They are used for nodes with a large number of properties or child nodes. As lists they are represented using two types of physical record:</p>

<ul>
  
<li>
<p>leaf record: if the number of elements in the map is small, they are all  stored in a leaf record. This covers the simplest case for small maps.</p></li>
  
<li>
<p>branch record: if the number of elements in the map is too big, the original  map is split into smaller maps based on a hash function applied to the keys of  the map. A branch record is recursive, because it can reference other branch  records if the sub-maps are too big and need to be split again.</p></li>
</ul>
<p>Maps are stored using the hash array mapped trie (HAMT) data structure. The hash code of each key is split into pieces of 5 bits each and the keys are sorted into 32 (2^5) buckets based on the first 5 bits. If a bucket contains less than 32 entries, then it is stored directly as a list of key-value pairs. Otherwise the keys are split into sub-buckets based on the next 5 bits of their hash codes. When all buckets are stored, the list of top-level bucket references gets stored along with the total number of entries in the map.</p>
<p>The result is a hierarchically stored immutable map where each element can be accessed in O(log N) time and the size overhead of updating or inserting list elements is also O(log N).</p>
<p>Map records are also optimized for small changes. In example, if only one element of a previously stored map is modified, and the map is stored again, only a &#x201c;diff&#x201d; of the map is stored. This prevents the full storage of the modified map, which can save a considerable amount of space if the original map was big.</p></div>
<div class="section">
<h3><a name="Template_records"></a>Template records</h3>
<p>A template record stores metadata about nodes that, on average, don&#x2019;t change so often. A template record stores information like the primary type, the mixin types, the property names and the property types of a node. Having this information stored away from the node itself prevents to write them over and over again if they don&#x2019;t change when the node changes.</p>
<p>In example, on average, a node is created with a certain primary type and, optionally, with some mixin types. Usually, because of its primary type, a node is already created with a set of initial properties. After that, only the value of the properties change, but not the structure of the node itself.</p>
<p>The template record allows Oak to handle simple modifications to nodes in the most efficient way possible.</p>
<p>As such a template record describes the common structure of a family of related nodes. Since the structures of most nodes in a typical content tree fall into a small set of common templates, it makes sense to store such templates separately instead of repeating that information separately for each node. For example, the property names and types as well as child node names of all nt:file nodes are typically the same. The presence of mixins and different subtypes increases the number of different templates, but they&#x2019;re typically still far fewer than nodes in the repository.</p>
<p>A template record consists of a set of up to N (exact size TBD, N ~ 256) property name and type pairs. Additionally, since nodes that are empty or contain just a single child node are most common, a template record also contains information whether the node has zero, one or many child nodes. In case of a single child node, the template also contains the name of that node. For example, the template for typical mix:versionable nt:file nodes would be (using CND-like notation):</p>

<div class="source">
<div class="source"><pre class="prettyprint">- jcr:primaryType (NAME)
- jcr:mixinTypes (NAME) multiple
- jcr:created (DATE)
- jcr:uuid (STRING)
- jcr:versionHistory (REFERENCE)
- jcr:predecessors (REFERENCE) multiple
- jcr:baseVersion (REFERENCE)
+ jcr:content
</pre></div></div>
<p>The names used in a template are stored as separate value records and included by reference. This way multiple templates that for example all contain the &#x201c;jcr:primaryType&#x201d; property name don&#x2019;t need to repeatedly store it.</p></div>
<div class="section">
<h3><a name="Node_records"></a>Node records</h3>
<p>The node record is the single most important type of record, capable of storing both the data associated to the node and the structure of the content tree.</p>
<p>A node record always maintains a reference to a template record. As stated before, a template record defines the overall structure of the node, while the variable part of it is maintained in the node record itself.</p>
<p>The variable part of the node is represented by a list of property values and a map of child nodes.</p>
<p>The list of property values is implemented as a list of record identifiers. For each property in the node, its value is written in the segment. The record identifiers referencing the values of the properties are then packed together in a list record. The identifier of the list record is stored as part of the node record. If the value of some properties didn&#x2019;t change, the previous record identifier is just reused.</p>
<p>The map of child nodes is implemented as a map of record identifiers. For every child node, its node record identifier is stored in a map indexed by name. The map is persisted in a map record, and its identifier is stored in the node record. Thanks to the optimizations implemented by the map record, small changes to the map of children node don&#x2019;t create a lot of overhead in the segment.</p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
