<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2018-02-04 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180204" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Jackrabbit Oak &#x2013; Oak Document Storage</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                  <a href="https://github.com/apache/jackrabbit-oak">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
<a class="brand" href="../"  title="Oak logo"><img src="../oak_logo.png" alt="Oak logo" />
</a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../index.html" title="Jackrabbit Oak">Jackrabbit Oak</a></li>
            <li><a href="../license.html" title="License">License</a></li>
            <li><a href="../downloads.html" title="Downloads">Downloads</a></li>
            <li><a href="../articles.html" title="Articles">Articles</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Concepts and Architecture <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../architecture/overview.html" title="Overview">Overview</a></li>
            <li><a href="../architecture/nodestate.html" title="The Node State Model">The Node State Model</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Main APIs <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://www.day.com/specs/jcr/2.0/index.html" title="JCR API">JCR API</a></li>
            <li><a href="../oak_api/overview.html" title="Oak API">Oak API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features and Plugins <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="../nodestore/overview.html" title="Node Storage">Node Storage</a>
              <ul class="dropdown-menu">
                  <li><a href="../nodestore/documentmk.html" title="Document NodeStore">Document NodeStore</a></li>
                  <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore">Segment NodeStore</a></li>
                  <li><a href="../nodestore/compositens.html" title="Composite NodeStore">Composite NodeStore</a></li>
              </ul>
            </li>
            <li><a href="../plugins/blobstore.html" title="Blob Storage">Blob Storage</a></li>
            <li class="dropdown-submenu">
<a href="../query/query.html" title="Query">Query</a>
              <ul class="dropdown-menu">
                  <li><a href="../query/query-engine.html" title="Query Engine">Query Engine</a></li>
                  <li><a href="../query/grammar-xpath.html" title="XPath Grammar">XPath Grammar</a></li>
                  <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar">SQL-2 Grammar</a></li>
                  <li><a href="../query/query-troubleshooting.html" title="Troubleshooting">Troubleshooting</a></li>
                  <li><a href="../query/indexing.html" title="Indexing">Indexing</a></li>
                  <li><a href="../query/lucene.html" title="Lucene Index">Lucene Index</a></li>
                  <li><a href="../query/property-index.html" title="Property Index">Property Index</a></li>
                  <li><a href="../query/solr.html" title="Solr Index">Solr Index</a></li>
              </ul>
            </li>
            <li><a href="../security/overview.html" title="Security">Security</a></li>
            <li><a href="../features/atomic-counter.html" title="Atomic Counter">Atomic Counter</a></li>
            <li><a href="../features/observation.html" title="Observation">Observation</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Using Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../use_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../construct.html" title="Repository Construction">Repository Construction</a></li>
            <li><a href="../osgi_config.html" title="Configuring Oak">Configuring Oak</a></li>
            <li><a href="../command_line.html" title="Command Line Tools">Command Line Tools</a></li>
            <li><a href="../migration.html" title="Migration">Migration</a></li>
            <li><a href="../differences.html" title="Differences to Jackrabbit 2">Differences to Jackrabbit 2</a></li>
            <li><a href="../known_issues.html" title="Known Issues">Known Issues</a></li>
            <li><a href="../constraints.html" title="Constraints">Constraints</a></li>
            <li><a href="../dos_and_donts.html" title="Dos and Don'ts">Dos and Don'ts</a></li>
            <li><a href="../coldstandby/coldstandby.html" title="Cold Standby">Cold Standby</a></li>
            <li><a href="../FAQ.html" title="FAQ">FAQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developing Oak <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../dev_getting_started.html" title="Getting Started">Getting Started</a></li>
            <li><a href="../participating.html" title="Participating">Participating</a></li>
            <li><a href="../developing-with-git.html" title="Developing with Git">Developing with Git</a></li>
            <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds">Cutting diagnostic builds</a></li>
            <li><a href="../branching.html" title="Branching off a new stable">Branching off a new stable</a></li>
            <li><a href="../attribution.html" title="Attribution">Attribution</a></li>
            <li><a href="../release-schedule.html" title="Release Schedule">Release Schedule</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="http://jackrabbit.apache.org/oak" title="Apache Jackrabbit Oak">Apache Jackrabbit Oak</a></li>
            <li><a href="http://jackrabbit.apache.org/" title="Apache Jackrabbit">Apache Jackrabbit</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Oak Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2018-02-04<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.10-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Jackrabbit Oak"><span class="none"></span>Jackrabbit Oak</a>  </li>
    <li><a href="../license.html" title="License"><span class="none"></span>License</a>  </li>
    <li><a href="../downloads.html" title="Downloads"><span class="none"></span>Downloads</a>  </li>
    <li><a href="../articles.html" title="Articles"><span class="none"></span>Articles</a>  </li>
          <li class="nav-header">Concepts and Architecture</li>
    <li><a href="../architecture/overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="../architecture/nodestate.html" title="The Node State Model"><span class="none"></span>The Node State Model</a>  </li>
          <li class="nav-header">Main APIs</li>
    <li><a href="http://www.day.com/specs/jcr/2.0/index.html" class="externalLink" title="JCR API"><span class="none"></span>JCR API</a>  </li>
    <li><a href="../oak_api/overview.html" title="Oak API"><span class="none"></span>Oak API</a>  </li>
          <li class="nav-header">Features and Plugins</li>
    <li><a href="../nodestore/overview.html" title="Node Storage"><span class="icon-chevron-down"></span>Node Storage</a>
      <ul class="nav nav-list">
    <li class="active"><a href="#"><span class="icon-chevron-down"></span>Document NodeStore</a>

      <ul class="nav nav-list">
    <li><a href="../nodestore/document/node-bundling.html" title="Node Bundling"><span class="none"></span>Node Bundling</a>  </li>
    <li><a href="../nodestore/document/secondary-store.html" title="Secondary Store"><span class="none"></span>Secondary Store</a>  </li>
    <li><a href="../nodestore/persistent-cache.html" title="Persistent Cache"><span class="none"></span>Persistent Cache</a>  </li>
    <li><a href="../clustering.html" title="Clustering"><span class="none"></span>Clustering</a>  </li>
      </ul>
  </li>
    <li><a href="../nodestore/segment/overview.html" title="Segment NodeStore"><span class="none"></span>Segment NodeStore</a>  </li>
    <li><a href="../nodestore/compositens.html" title="Composite NodeStore"><span class="none"></span>Composite NodeStore</a>  </li>
      </ul>
  </li>
    <li><a href="../plugins/blobstore.html" title="Blob Storage"><span class="none"></span>Blob Storage</a>  </li>
    <li><a href="../query/query.html" title="Query"><span class="icon-chevron-down"></span>Query</a>
      <ul class="nav nav-list">
    <li><a href="../query/query-engine.html" title="Query Engine"><span class="none"></span>Query Engine</a>  </li>
    <li><a href="../query/grammar-xpath.html" title="XPath Grammar"><span class="none"></span>XPath Grammar</a>  </li>
    <li><a href="../query/grammar-sql2.html" title="SQL-2 Grammar"><span class="none"></span>SQL-2 Grammar</a>  </li>
    <li><a href="../query/query-troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
    <li><a href="../query/indexing.html" title="Indexing"><span class="none"></span>Indexing</a>  </li>
    <li><a href="../query/lucene.html" title="Lucene Index"><span class="none"></span>Lucene Index</a>  </li>
    <li><a href="../query/property-index.html" title="Property Index"><span class="none"></span>Property Index</a>  </li>
    <li><a href="../query/solr.html" title="Solr Index"><span class="none"></span>Solr Index</a>  </li>
      </ul>
  </li>
    <li><a href="../security/overview.html" title="Security"><span class="none"></span>Security</a>  </li>
    <li><a href="../features/atomic-counter.html" title="Atomic Counter"><span class="none"></span>Atomic Counter</a>  </li>
    <li><a href="../features/observation.html" title="Observation"><span class="none"></span>Observation</a>  </li>
          <li class="nav-header">Using Oak</li>
    <li><a href="../use_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../construct.html" title="Repository Construction"><span class="none"></span>Repository Construction</a>  </li>
    <li><a href="../osgi_config.html" title="Configuring Oak"><span class="none"></span>Configuring Oak</a>  </li>
    <li><a href="../command_line.html" title="Command Line Tools"><span class="none"></span>Command Line Tools</a>  </li>
    <li><a href="../migration.html" title="Migration"><span class="none"></span>Migration</a>  </li>
    <li><a href="../differences.html" title="Differences to Jackrabbit 2"><span class="none"></span>Differences to Jackrabbit 2</a>  </li>
    <li><a href="../known_issues.html" title="Known Issues"><span class="none"></span>Known Issues</a>  </li>
    <li><a href="../constraints.html" title="Constraints"><span class="none"></span>Constraints</a>  </li>
    <li><a href="../dos_and_donts.html" title="Dos and Don'ts"><span class="none"></span>Dos and Don'ts</a>  </li>
    <li><a href="../coldstandby/coldstandby.html" title="Cold Standby"><span class="none"></span>Cold Standby</a>  </li>
    <li><a href="../FAQ.html" title="FAQ"><span class="none"></span>FAQ</a>  </li>
          <li class="nav-header">Developing Oak</li>
    <li><a href="../dev_getting_started.html" title="Getting Started"><span class="none"></span>Getting Started</a>  </li>
    <li><a href="../participating.html" title="Participating"><span class="none"></span>Participating</a>  </li>
    <li><a href="../developing-with-git.html" title="Developing with Git"><span class="none"></span>Developing with Git</a>  </li>
    <li><a href="../diagnostic-builds.html" title="Cutting diagnostic builds"><span class="none"></span>Cutting diagnostic builds</a>  </li>
    <li><a href="../branching.html" title="Branching off a new stable"><span class="none"></span>Branching off a new stable</a>  </li>
    <li><a href="../attribution.html" title="Attribution"><span class="none"></span>Attribution</a>  </li>
    <li><a href="../release-schedule.html" title="Release Schedule"><span class="none"></span>Release Schedule</a>  </li>
          <li class="nav-header">Links</li>
    <li><a href="http://jackrabbit.apache.org/oak" class="externalLink" title="Apache Jackrabbit Oak"><span class="none"></span>Apache Jackrabbit Oak</a>  </li>
    <li><a href="http://jackrabbit.apache.org/" class="externalLink" title="Apache Jackrabbit"><span class="none"></span>Apache Jackrabbit</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
          <script type="text/javascript">asyncJs( 'https://apis.google.com/js/plusone.js' )</script>
        <div class="g-plusone" data-href="http://jackrabbit.apache.org/oak/docs/" data-size="tall" ></div>
                  <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--
   Licensed to the Apache Software Foundation (ASF) under one or more
   contributor license agreements.  See the NOTICE file distributed with
   this work for additional information regarding copyright ownership.
   The ASF licenses this file to You under the Apache License, Version 2.0
   (the "License"); you may not use this file except in compliance with
   the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
  --><h1>Oak Document Storage</h1>

<ul>
  
<li><a href="#oak-document-storage">Oak Document Storage</a>
  
<ul>
    
<li><a href="#new-1.6">New in 1.6</a></li>
    
<li><a href="#backend-implementations">Backend implementations</a></li>
    
<li><a href="#content-model">Content Model</a></li>
    
<li><a href="#node-content-model">Node Content Model</a></li>
    
<li><a href="#revisions">Revisions</a></li>
    
<li><a href="#clock-requirements">Clock requirements</a></li>
    
<li><a href="#branches">Branches</a></li>
    
<li><a href="#previous-documents">Previous Documents</a></li>
    
<li><a href="#sweep-revision">Sweep Revision</a></li>
    
<li><a href="#node-bundling">Node Bundling</a></li>
    
<li><a href="#background-operations">Background Operations</a>
    
<ul>
      
<li><a href="#renew-cluster-id-lease">Renew Cluster Id Lease</a></li>
      
<li><a href="#background-document-split">Background Document Split</a></li>
      
<li><a href="#background-writes">Background Writes</a></li>
      
<li><a href="#bg-read">Background Reads</a></li>
    </ul></li>
    
<li><a href="#pending-topics">Pending Topics</a>
    
<ul>
      
<li><a href="#conflict-detection-and-handling">Conflict Detection and Handling</a></li>
    </ul></li>
    
<li><a href="#cluster-node-metadata">Cluster Node Metadata</a>
    
<ul>
      
<li><a href="#rw-preference">Specifying the Read Preference and Write Concern</a>
      
<ul>
        
<li><a href="#via-configuration">Via Configuration</a></li>
        
<li><a href="#changing-at-runtime">Changing at Runtime</a></li>
      </ul></li>
    </ul></li>
    
<li><a href="#cache">Caching</a>
    
<ul>
      
<li><a href="#cache-invalidation">Cache Invalidation</a></li>
      
<li><a href="#cache-configuration">Cache Configuration</a></li>
    </ul></li>
    
<li><a href="#unlockUpgrade">Unlock upgrade</a></li>
    
<li><a href="#revision-gc">Revision Garbage Collection</a></li>
  </ul></li>
</ul>
<p>One of the plugins in Oak stores data in a document oriented format. The plugin implements the low level <tt>NodeStore</tt> interface.</p>
<p>The document storage optionally uses the <a href="persistent-cache.html">persistent cache</a> to reduce read operations on the backend storage.</p>
<div class="section">
<h2><a name="New_in_1.6"></a><a name="new-1.6"></a> New in 1.6</h2>

<ul>
  
<li><a href="#node-bundling">Node Bundling</a></li>
  
<li><a href="#secondary-store">Secondary Store</a></li>
</ul></div>
<div class="section">
<h2><a name="Backend_implementations"></a><a name="backend-implementations"></a> Backend implementations</h2>
<p>The DocumentNodeStore supports a number of backends, with a storage abstraction called <tt>DocumentStore</tt>:</p>

<ul>
  
<li><tt>MongoDocumentStore</tt>: stores documents in a MongoDB.</li>
  
<li><tt>RDBDocumentStore</tt>: stores documents in a relational data base.</li>
  
<li><tt>MemoryDocumentStore</tt>: keeps documents in memory. This implementation should only be used for testing purposes.</li>
</ul>
<p>The recommended MongoDB version depends on the Oak release. Below table lists the recommended MongoDB version for each Oak release. More recent MongoDB versions may also work, but are untested.</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Oak Release </th>
      
<th>MongoDB version</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>1.0.x </td>
      
<td>2.6.x</td>
    </tr>
    
<tr class="a">
      
<td>1.2.x </td>
      
<td>3.2.x</td>
    </tr>
    
<tr class="b">
      
<td>1.4.x </td>
      
<td>3.2.x</td>
    </tr>
    
<tr class="a">
      
<td>1.6.x </td>
      
<td>3.2.x</td>
    </tr>
    
<tr class="b">
      
<td>1.8.x </td>
      
<td>3.4.x</td>
    </tr>
  </tbody>
</table>
<p>The remaining part of the document will focus on the <tt>MongoDocumentStore</tt> to explain and illustrate concepts of the DocumentNodeStore.</p></div>
<div class="section">
<h2><a name="Content_Model"></a><a name="content-model"></a> Content Model</h2>
<p>The repository data is stored in two collections: the <tt>nodes</tt> collection for node data, and the <tt>blobs</tt> collection for binaries. The <tt>journal</tt> collection contains a log of changes applied to the repository. Entries older than 24 hours are automatically purged by the repository.</p>
<p>The <tt>clusterNodes</tt> collection contains a document for each DocumentNodeStore connected to MongoDB in read-write mode. A DocumentNodeStore uses the documents in this collection to discover all other instances.</p>
<p>Cluster wide information is stored in the <tt>settings</tt> collection. This includes checkpoints, journal and revision GC status, format version and the current cluster view.</p>
<p>The data can be viewed using the MongoDB shell:</p>

<div class="source">
<div class="source"><pre class="prettyprint">&gt; show collections
blobs
clusterNodes
journal
nodes
settings
</pre></div></div></div>
<div class="section">
<h2><a name="Node_Content_Model"></a><a name="node-content-model"></a> Node Content Model</h2>
<p>The <tt>DocumentNodeStore</tt> stores each node in a separate MongoDB document and updates to a node are stored by adding new revision/value pairs to the document. This way the previous state of a node is preserved and can still be retrieved by a session looking at a given snapshot (revision) of the repository.</p>
<p>The basic MongoDB document of a node in Oak looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_id&quot; : &quot;1:/node&quot;,
    &quot;_deleted&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;false&quot;
    },
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13f3875b5d1-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274208361),
    &quot;_modCount&quot; : NumberLong(1),
    &quot;_children&quot; : Boolean(true),
    &quot;_revisions&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;c&quot;
    }
}
</pre></div></div>
<p>All fields in the above document are metadata and are not exposed through the Oak API. The DocumentNodeStore has two types of fields. Simple fields are key/value pairs like the <tt>_id</tt> or <tt>_modified</tt> field. Versioned fields are kept in sub-documents where the key is a revision paired with the value at this revision.</p>
<p>The <tt>_id</tt> field is used as the primary key and consists of a combination of the depth of the path and the path itself. This is an optimization to align sibling keys in the index.</p>
<p>The <tt>_deleted</tt> sub-document contains the revision this node was created in. In the above example the root node was created in revision <tt>r13f3875b5d1-0-1</tt>. If the node is later deleted, the <tt>_deleted</tt> sub-document will get a new field with the revision the node was deleted in.</p>
<p>The sub-document <tt>_lastRev</tt> contains the last revision written to this node by each cluster node. In the above example the DocumentNodeStore cluster node with id <tt>1</tt> modified the node the last time in revision <tt>r13f3875b5d1-0-1</tt>, when it created the node. The revision key in the <tt>_lastRev</tt> sub-document is synthetic and the only information actually used by the DocumentNodeStore is the clusterId. The <tt>_lastRev</tt> sub-document is only updated for non-branch commits or on merge, when changes become visible to all readers. Starting with Oak 1.2 the <tt>_lastRev</tt> value for a cluster node is only updated when there is no corresponding entry in <tt>_revisions</tt> or <tt>_commitRoot</tt>. That is, when the node wasn&#x2019;t changed but a descendant node was added, removed or modified.</p>
<p>The <tt>_modified</tt> field contains an indexed low-resolution timestamp when the node was last modified. The time resolution is five seconds. This field is also updated when a branch commit modifies a node.</p>
<p>The <tt>_modCount</tt> field contains a modification counter, which is incremented with every change to the document. This field allows the DocumentNodeStore to perform conditional updates without requesting the whole document.</p>
<p>The <tt>_children</tt> field is a boolean flag to indicate if this node has child nodes. By default a node would not have this field. If any node gets added as child of this node then it would be set to true. It is used to optimize access to child nodes and allows the DocumentNodeStore to omit calls to fetch child nodes for leaf nodes.</p>
<p>Finally, the <tt>_revisions</tt> sub-document contains commit information about changes marked with a revision. E.g. the single entry in the above document tells us that everything marked with revision <tt>r13f3875b5d1-0-1</tt> is committed and therefore valid. In case the change is done in a branch then the value would be the base revision. It is only added for those nodes which happen to be the commit root for any given commit.</p>
<p>Adding a property <tt>prop</tt> with value <tt>foo</tt> to the node in a next step will result in the following document:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;false&quot;
    },
    &quot;_id&quot; : &quot;1:/node&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13f38818ab6-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274208516),
    &quot;_modCount&quot; : NumberLong(2),
    &quot;_revisions&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;c&quot;,
        &quot;r13f38818ab6-0-1&quot; : &quot;c&quot;
    },
    &quot;prop&quot; : {
        &quot;r13f38818ab6-0-1&quot; : &quot;\&quot;foo\&quot;&quot;
    }
}
</pre></div></div>
<p>Now the document contains a new sub-document with the name of the new property. The value of the property is annotated with the revision the property was set. With each successful commit to this node, a new field is added to the <tt>_revisions</tt> sub-document. Similarly the <tt>_lastRev</tt> sub-document and <tt>_modified</tt> field are updated.</p>
<p>After the node is deleted the document looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;false&quot;,
        &quot;r13f38835063-2-1&quot; : &quot;true&quot;
    },
    &quot;_id&quot; : &quot;1:/node&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13f38835063-2-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274208539),
    &quot;_modCount&quot; : NumberLong(3),
    &quot;_revisions&quot; : {
        &quot;r13f3875b5d1-0-1&quot; : &quot;c&quot;,
        &quot;r13f38818ab6-0-1&quot; : &quot;c&quot;,
        &quot;r13f38835063-2-1&quot; : &quot;c&quot;
    },
    &quot;prop&quot; : {
        &quot;r13f38818ab6-0-1&quot; : &quot;\&quot;foo\&quot;&quot;
        &quot;r13f38835063-2-1&quot; : null
    }
}
</pre></div></div>
<p>The <tt>_deleted</tt> sub-document now contains a <tt>r13f38835063-2-1</tt> field marking the node as deleted in this revision.</p>
<p>Reading the node in previous revisions is still possible, even if it is now marked as deleted as of revision <tt>r13f38835063-2-1</tt>.</p></div>
<div class="section">
<h2><a name="Revisions"></a><a name="revisions"></a> Revisions</h2>
<p>As seen in the examples above, a revision is a String and may look like this: <tt>r13f38835063-2-1</tt>. It consists of three parts:</p>

<ul>
  
<li>A timestamp derived from the system time of the machine it was generated on: <tt>13f38835063</tt></li>
  
<li>A counter to distinguish revisions created with the same timestamp: <tt>-2</tt></li>
  
<li>The cluster node id where this revision was created: <tt>-1</tt></li>
</ul></div>
<div class="section">
<h2><a name="Clock_requirements"></a><a name="clock-requirements"></a> Clock requirements</h2>
<p>Revisions are used by the DocumentNodeStore to identify the sequence of changes done on items in the repository. This is also done across cluster nodes for revisions with different cluster node ids. This requires the system clocks on the machines running Oak and the backend system to approximately in sync. It is recommended to run an NTP daemon or some similar service to keep the clock synchronized. Oak allows clock differences up to 2 seconds between the machine where Oak is running and the machine where the backend store (MongoDB or RDBMS) is running. Oak may refuse to start if it detects a larger clock difference. Clock differences between the machines running in an Oak cluster will result in delayed propagation of changes between cluster nodes and warnings in the log files.</p></div>
<div class="section">
<h2><a name="Branches"></a><a name="branches"></a> Branches</h2>
<p>The DocumentNodeStore implementation support branches, which allows a client to stage multiple commits and make them visible with a single merge call. A branch commit looks very similar to a regular commit, but instead of setting the value of an entry in <tt>_revisions</tt> to <tt>c</tt> (committed), it marks it with the base revision of the branch commit. In contrast to regular commits where the commit root is the common ancestor of all nodes modified in a commit, the commit root of a branch commit is always the root node. This is because a branch will likely have multiple commits and a commit root must already be known when the first commit happens on a branch. To make sure the following branch commits can use the same commit root, the DocumentNodeStore simply picks the root node, which always works in this case.</p>
<p>A root node may look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;false&quot;,
    },
    &quot;_id&quot; : &quot;0:/&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91720-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274708995),
    &quot;_modCount&quot; : NumberLong(2),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda91720-0-1&quot; : &quot;c&quot;
    },
    &quot;prop&quot; : {
        &quot;r13fcda91720-0-1&quot; : &quot;\&quot;foo\&quot;&quot;
    }
}
</pre></div></div>
<p>The root node was created in revision <tt>r13fcda88ac0-0-1</tt> and later in revision <tt>r13fcda91720-0-1</tt> property <tt>prop</tt> was set to <tt>foo</tt>. To keep the example simple, we now assume a branch is created based on the revision the root node was last modified and a branch commit is done to modify the existing property. After the branch commit the root node looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;false&quot;,
    },
    &quot;_id&quot; : &quot;0:/&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91720-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274708995),
    &quot;_modCount&quot; : NumberLong(3),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda91720-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;r13fcda91720-0-1&quot;
    },
    &quot;_bc&quot; : {
        &quot;r13fcda919eb-0-1&quot; : &quot;true&quot;
    },
    &quot;prop&quot; : {
        &quot;r13fcda91720-0-1&quot; : &quot;\&quot;foo\&quot;&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;\&quot;bar\&quot;&quot;,
    }
}
</pre></div></div>
<p>Note, the <tt>_bc</tt> sub-document was introduced with Oak 1.8 and is not present in older versions. The branch commit revision is added to <tt>_bc</tt> whenever a change is done on a document with a branch commit. This helps the DocumentNodeStore to more easily identify branch commit changes.</p>
<p>At this point the modified property is only visible to a reader when it reads with the branch revision <tt>r13fcda919eb-0-1</tt> because the revision is marked with the base version of this commit in the <tt>_revisions</tt> sub-document. Note, the <tt>_lastRev</tt> is not updated for branch commits but only when a branch is merged.</p>
<p>When the branch is later merged, the root node will look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;false&quot;,
    },
    &quot;_id&quot; : &quot;0:/&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91b12-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274708995),
    &quot;_modCount&quot; : NumberLong(4),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda91720-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;c-r13fcda91b12-0-1&quot;
    },
    &quot;_bc&quot; : {
        &quot;r13fcda919eb-0-1&quot; : &quot;true&quot;
    },
    &quot;prop&quot; : {
        &quot;r13fcda91720-0-1&quot; : &quot;\&quot;foo\&quot;&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;\&quot;bar\&quot;&quot;,
    }
}
</pre></div></div>
<p>Now, the changed property is visible to readers with a revision equal or newer than <tt>r13fcda91b12-0-1</tt>.</p>
<p>The same logic is used for changes to other nodes that belong to a branch commit. The DocumentNodeStore internally resolves the commit revision for a modification before it decides whether a reader is able to see a given change.</p></div>
<div class="section">
<h2><a name="Previous_Documents"></a><a name="previous-documents"></a> Previous Documents</h2>
<p>Over time the size of a document grows because the DocumentNodeStore adds data to the document with every modification, but never deletes anything to keep the history. Old data is moved when there are 100 commits to be moved or the document is bigger than 1 MB. A document with a reference to old data looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;false&quot;,
    },
    &quot;_id&quot; : &quot;0:/&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91b12-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274708995),
    &quot;_modCount&quot; : NumberLong(1004),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda91720-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;c-r13fcda91b12-0-1&quot;
    },
    &quot;_bc&quot; : {
        &quot;r13fcda919eb-0-1&quot; : &quot;true&quot;
    },
    &quot;_prev&quot; : {
        &quot;r13fcda88ae0-0-1&quot; : &quot;r13fcda91710-0-1&quot;
    },
    &quot;prop&quot; : {
        &quot;r13fcda91720-0-1&quot; : &quot;\&quot;foo\&quot;&quot;,
        &quot;r13fcda919eb-0-1&quot; : &quot;\&quot;bar\&quot;&quot;,
    }
}
</pre></div></div>
<p>The optional sub-document <tt>_prev</tt> contains a list of revision pairs, each indicating the range of commit revisions a previous document contains. In the above example there is one document with previous commits from <tt>r13fcda88ae0-0-1</tt> to <tt>r13fcda91710-0-1</tt>. The id of the previous document is derived from the upper bound of the range and the id/path of the current document. The id of the previous document for <tt>r13fcda88ae0-0-1</tt> and <tt>0:/</tt> is <tt>1:p/r13fcda88ae0-0-1</tt> and may looks like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_id&quot; : &quot;1:p/r13fcda88ae0-0-1&quot;,
    &quot;_modCount&quot; : NumberLong(1),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ae0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda88af0-0-1&quot; : &quot;c&quot;,
        ...  
        &quot;r13fcda91710-0-1&quot; : &quot;c&quot;
    },
    &quot;prop&quot; : {
        &quot;r13fcda88ae0-0-1&quot; : &quot;\&quot;foo\&quot;&quot;,
        &quot;r13fcda88af0-0-1&quot; : &quot;\&quot;bar\&quot;&quot;,
        ...
        &quot;r13fcda91710-0-1&quot; : &quot;\&quot;baz\&quot;&quot;
    }
}
</pre></div></div>
<p>Previous documents only contain immutable data, which means it only contains committed and merged <tt>_revisions</tt>. This also means the previous ranges of committed data may overlap because branch commits are not moved to previous documents until the branch is merged.</p></div>
<div class="section">
<h2><a name="Sweep_Revision"></a><a name="sweep-revision"></a> Sweep Revision</h2>
<p><tt>@since Oak 1.8</tt></p>
<p>With Oak 1.8 the concept of a sweep revision was introduced in the DocumentNodeStore. The sweep revision of a DocumentNodeStore indicates up to which revision non-branch changes are guaranteed to be committed. This allows to optimize read operations because a lookup of the commit root document can be avoided in most cases. It also means the Revision Garbage Collector can remove previous documents that contain <tt>_revisions</tt> entries if they are all older than the sweep revision.</p>
<p>The sweep revision is maintained per DocumentNodeStore instance on the root document. Below is the root document already presented above, amended with the sweep revision.</p>

<div class="source">
<div class="source"><pre class="prettyprint">{
    &quot;_deleted&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;false&quot;,
    },
    &quot;_id&quot; : &quot;0:/&quot;,
    &quot;_lastRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91720-0-1&quot;
    },
    &quot;_modified&quot; : NumberLong(274708995),
    &quot;_modCount&quot; : NumberLong(2),
    &quot;_revisions&quot; : {
        &quot;r13fcda88ac0-0-1&quot; : &quot;c&quot;,
        &quot;r13fcda91720-0-1&quot; : &quot;c&quot;
    },
    &quot;_sweepRev&quot; : {
        &quot;r0-0-1&quot; : &quot;r13fcda91720-0-1&quot;,
    },
    &quot;prop&quot; : {
        &quot;r13fcda91720-0-1&quot; : &quot;\&quot;foo\&quot;&quot;
    }
}
</pre></div></div></div>
<div class="section">
<h2><a name="node-bundling"></a> node-bundling</h2>
<p><tt>@since Oak 1.6</tt></p>
<p>Refer to <a href="document/node-bundling.html">Node Bundling</a></p></div>
<div class="section">
<h2><a name="Background_Operations"></a><a name="background-operations"></a> Background Operations</h2>
<p>Each DocumentNodeStore instance connecting to same database in Mongo server performs certain background task.</p>
<div class="section">
<h3><a name="Renew_Cluster_Id_Lease"></a><a name="renew-cluster-id-lease"></a> Renew Cluster Id Lease</h3>
<p>Each cluster node uses a unique cluster node id, which is the last part of the revision id. Each cluster node has a lease on the cluster node id, as described in the section <a href="#Cluster_Node_Metadata">Cluster Node Metadata</a>.</p></div>
<div class="section">
<h3><a name="Background_Document_Split"></a><a name="background-document-split"></a> Background Document Split</h3>
<p>The DocumentNodeStore periodically checks documents for their size and if necessary splits them up and moves old data to a previous document. This is done in the background by each DocumentNodeStore instance for the data it created.</p></div>
<div class="section">
<h3><a name="Background_Writes"></a><a name="background-writes"></a> Background Writes</h3>
<p>While performing commits there are certain nodes which are modified but do not become part of commit. For example when a node under /a/b/c is updated then the <tt>_lastRev</tt> property of all ancestors also need to be updated to the commit revision. Such changes are accumulated and flushed periodically through a asynchronous job.</p></div>
<div class="section">
<h3><a name="Background_Reads"></a><a name="bg-read"></a> Background Reads</h3>
<p>The DocumentNodeStore periodically picks up changes from other DocumentNodeStore instances by polling the root node for changes of <tt>_lastRev</tt>. This happens once every second.</p></div></div>
<div class="section">
<h2><a name="Pending_Topics"></a><a name="pending-topics"></a> Pending Topics</h2>
<div class="section">
<h3><a name="Conflict_Detection_and_Handling"></a><a name="conflict-detection-and-handling"></a> Conflict Detection and Handling</h3></div></div>
<div class="section">
<h2><a name="Cluster_Node_Metadata"></a><a name="cluster-node-metadata"></a> Cluster Node Metadata</h2>
<p>Cluster node metadata is stored in the <tt>clusterNodes</tt> collection. There is one entry for each cluster node that is running, and there are entries for cluster nodes that were ran. Old entries are kept so that if a cluster node is started again, it gets the same cluster node id as before (which is not strictly needed for consistency, but nice for support, if one would want to find out which change originated from which cluster node).</p>
<p>Each running cluster node updates the lease time of the cluster node id once every minute, to ensure each cluster node uses a different cluster node id.</p>

<div class="source">
<div class="source"><pre class="prettyprint">&gt; db.clusterNodes.find().pretty()

{
    &quot;_id&quot; : &quot;1&quot;,
    &quot;_modCount&quot; : NumberLong(2),
    &quot;leaseEnd&quot; : NumberLong(&quot;1390465250135&quot;),
    &quot;instance&quot; : &quot;/Users/test/jackrabbit/oak/trunk/oak-jcr&quot;,
    &quot;machine&quot; : &quot;mac:20c9d043f141&quot;,
    &quot;info&quot; : &quot;...pid: 11483, uuid: 6b6e8e4f-8322-4b19-a2b2-de0c573620b9 ...&quot;
}
{
    &quot;_id&quot; : &quot;2&quot;,
    &quot;_modCount&quot; : NumberLong(2),
    &quot;leaseEnd&quot; : NumberLong(&quot;1390465252206&quot;),
    &quot;instance&quot; : &quot;/Users/mueller/jackrabbit/oak/trunk/oak-jcr&quot;,
    &quot;machine&quot; : &quot;mac:20c9d043f141&quot;,
    &quot;info&quot; : &quot;...pid: 11483, uuid: 28ada13d-ec9c-4d48-aeb9-cef53aa4bb9e ...&quot;
}
</pre></div></div>
<p>The <tt>_id</tt> is the cluster node id of the node, which is the last part of the revision id. The <tt>leaseEnd</tt> is updated once per minute by running cluster nodes. It is the number of milliseconds since 1970. The <tt>instance</tt> is the current working directory. The <tt>machine</tt> is the lowest number of the network addresses, or a random uuid if this is not available. The <tt>info</tt> contains the same info as a string, plus additionally the process id and the uuid.</p>
<div class="section">
<h3><a name="Specifying_the_Read_Preference_and_Write_Concern"></a><a name="rw-preference"></a> Specifying the Read Preference and Write Concern</h3>
<p>With <tt>MongoDocumentStore</tt> you can specify the the <a class="externalLink" href="http://docs.mongodb.org/manual/core/read-preference/">read preference</a> and <a class="externalLink" href="http://docs.mongodb.org/manual/core/write-concern/">write concern</a>. This can be enabled in Oak via two modes. </p>
<p>Note that <tt>MongoDocumentStore</tt> might still use a pre defined read preference like primary where ever required. So if for some code path like reading latest <tt>_lastRev</tt> of root node its required that read is performed from primary (for consistency) then code would explicitly use the readPreference primary for that operation. For all other operation Mongo Java Driver would use default settings where read preference is set to <tt>Primary</tt> and write concern is set to <tt>Acknowledged</tt>. Via using one of the two modes below a user can tune the default settings as per its need</p>
<div class="section">
<h4><a name="Via_Configuration"></a><a name="via-configuration"></a> Via Configuration</h4>
<p>In this mode the config is specified as part of the Mongo URI (See <a href="../osgi_config.html#document-node-store">configuration</a>). So if a user wants that reads from secondaries should prefer secondary with tag <i>dc:ny,rack:1</i> otherwise they go to other secondary then he can specify that via following mongouri</p>

<div class="source">
<div class="source"><pre class="prettyprint">mongodb://example1.com,example2.com,example3.com/?readPreference=secondary&amp;readPreferenceTags=dc:ny,rack:1&amp;readPreferenceTags=dc:ny&amp;readPreferenceTags= 
</pre></div></div>
<p>Refer to <a class="externalLink" href="http://docs.mongodb.org/manual/reference/connection-string/#read-preference-options">Read Preference Options</a> and <a class="externalLink" href="http://docs.mongodb.org/manual/reference/connection-string/#write-concern-options">Write Concern Options</a> for more details. </p></div>
<div class="section">
<h4><a name="Changing_at_Runtime"></a><a name="changing-at-runtime"></a> Changing at Runtime</h4>
<p>The read preference and write concern of all cluster nodes can be changed at runtime without having to restart the instances, by setting the property <tt>readWriteMode</tt> of this collection. All cluster nodes will pick up the change within one minute (when they renew the lease of the cluster node id). This is a string property with the format <tt>'readPreference=&lt;preference&gt;&amp;w=&lt;writeConcern&gt;'</tt> similar to the way it is used in mongouri. Just that it does not include other option details. The following shell command will set the read preference to <tt>primary</tt> and the write concern to <tt>majority</tt> for all cluster nodes:</p>

<div class="source">
<div class="source"><pre class="prettyprint">&gt; db.clusterNodes.update({}, 
  {$set: {readWriteMode:'readPreference=primary&amp;w=majority'}}, 
  {multi: true})    
</pre></div></div></div></div></div>
<div class="section">
<h2><a name="Caching"></a><a name="cache"></a> Caching</h2>
<p><tt>DocumentNodeStore</tt> maintains multiple caches to provide an optimum performance. By default the cached instances are kept in heap memory but some of the caches can be backed by <a href="persistent-cache.html">persistent cache</a>.</p>

<ol style="list-style-type: decimal">
  
<li>
<p><tt>documentCache</tt> - Document cache is used for caching the <tt>NodeDocument</tt> instance. These are in memory representation of the persistent state. For example in case of Mongo it maps to the Mongo document in <tt>nodes</tt> collection and for RDB its maps to the row in <tt>NODES</tt> table. There is a class of <tt>NodeDocument</tt> (leaf level split documents) which, since <tt>1.3.15</tt> are cached under <tt>prevDocCache</tt> (see below)</p>
<p>Depending on the <tt>DocumentStore</tt> implementation different heuristics are applied for invalidating the cache entries based on changes in backend </p></li>
  
<li>
<p><tt>prevDocCache</tt> - Previous document cache is used for caching the <tt>NodeDocument</tt> instance representing leaf level split documents. Unlike other type of <tt>NodeDocument</tt>, these are immutable and hence don&#x2019;t require invalidation. If configured, this cache can exploit persistent cache as well. Similar to other <tt>NodeDocument</tt> these are also in memory representation of the persistent state. (since <tt>1.3.15</tt>)</p>
<p>Depending on the <tt>DocumentStore</tt> implementation different heuristics are applied for invalidating the cache entries based on changes in backend </p></li>
  
<li>
<p><tt>docChildrenCache</tt> - Document Children cache is used to cache the children state for a given parent node. This is invalidated completely upon every background read. This cache was removed in 1.5.6.</p></li>
  
<li>
<p><tt>nodeCache</tt> - Node cache is used to cache the <tt>DocumentNodeState</tt> instances. These are <b>immutable</b> view of <tt>NodeDocument</tt> as seen at a given revision hence no consistency checks are to be performed for them</p></li>
  
<li>
<p><tt>childrenCache</tt> - Children cache is used to cache the children for a given node. These are also <b>immutable</b> and represent the state of children for a given parent at certain revision</p></li>
  
<li>
<p><tt>diffCache</tt> - Caches the diff for the changes done between successive revision.  For local changes done the diff is add to the cache upon commit while for  external changes the diff entries are added upon computation of diff as part  of observation call</p></li>
</ol>
<p>All the above caches are managed on heap. For the last 3 <tt>nodeCache</tt>, <tt>childrenCache</tt> and <tt>diffCache</tt> Oak provides support for <a href="persistent-cache.html">persistent cache</a>. By enabling the persistent cache feature Oak can manage a much larger cache off heap and thus avoid freeing up heap memory for application usage.</p>
<div class="section">
<h3><a name="Cache_Invalidation"></a><a name="cache-invalidation"></a> Cache Invalidation</h3>
<p><tt>documentCache</tt> and <tt>docChildrenCache</tt> are containing mutable state which requires consistency checks to be performed to keep them in sync with the backend persisted state. Oak uses a MVCC model under which it maintains a consistent view of a given Node at a given revision. This allows using local cache instead of using a global clustered cache where changes made by any other cluster node need not be instantly reflected on all other nodes. </p>
<p>Each cluster node periodically performs <a href="#bg-read">background reads</a> to pickup changes done by other cluster nodes. At that time it performs <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-1156">consistency check</a> to ensure that cached instance state reflect the state in the backend persisted state. Performing the check would take some time would be proportional number of entries present in the cache. </p>
<p>For repository to work properly its important to ensure that such background reads do not consume much time and <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-2646">work is underway</a> to improve current approach. <i>To ensure that such background operation (which include the cache invalidation checks) perform quickly one should not set a large size for these caches</i>.</p>
<p>All other caches consist of immutable state and hence no cache invalidation needs to be performed for them. For that reason those caches can be backed by persistent cache and even having large number of entries in such caches would not be a matter of concern. </p></div>
<div class="section">
<h3><a name="Cache_Configuration"></a><a name="cache-configuration"></a> Cache Configuration</h3>
<p>In a default setup the <a href="../osgi_config.html#document-node-store">DocumentNodeStoreService</a> takes a single config for <tt>cache</tt> which is internally distributed among the various caches above in following way</p>

<ol style="list-style-type: decimal">
  
<li><tt>nodeCache</tt> - 35% (was 25% until 1.5.14)</li>
  
<li><tt>prevDocCache</tt> - 4%</li>
  
<li><tt>childrenCache</tt> - 15% (was 10% until 1.5.14)</li>
  
<li><tt>diffCache</tt> - 30% (was 4% until 1.5.14)</li>
  
<li><tt>documentCache</tt> - Is given the rest i.e. 16%</li>
  
<li><tt>docChildrenCache</tt> - 0% (removed in 1.5.6, default was 3%)</li>
</ol>
<p>Lately <a class="externalLink" href="https://issues.apache.org/jira/browse/OAK-2546">options are provided</a> to have a fine grained control over the distribution. See <a href="../osgi_config.html#cache-allocation">Cache Allocation</a></p>
<p>While distributing ensure that cache left for <tt>documentCache</tt> is not very large i.e. prefer to keep that ~500 MB max or lower. As a large <tt>documentCache</tt> can lead to increase in the time taken to perform cache invalidation.</p>
<p>Further make use of the persistent cache. This reduces pressure on GC by keeping instances off heap with slight decrease in performance compared to keeping them on heap.</p></div></div>
<div class="section">
<h2><a name="Unlock_upgrade"></a><a name="unlockUpgrade"></a> Unlock upgrade</h2>
<p>On startup the DocumentNodeStore checks if its version is compatible with the format version currently in use. A read-only DocumentNodeStore can read the current version as well as older versions. A read-write DocumentNodeStore on the other hand can only write to the DocumentStore when the format version matches its own version. The DocumentNodeStore maintains this format version in the <tt>settings</tt> collection accessible to all cluster nodes.</p>
<p>Upgrading to a newer Oak version may therefore first require an update of the format version before a newer version of a DocumentNodeStore can be started on existing data. The oak-run tools contains an <tt>unlockUpgrade</tt> mode to perform this operation. Use the oak-run tool with the version matching the target upgrade version to unlock an upgrade with the following command. The below example unlocks an upgrade to 1.8 with a DocumentNodeStore on MongoDB:</p>

<div class="source">
<div class="source"><pre class="prettyprint">&gt; java -jar oak-run-1.8.0.jar unlockUpgrade mongodb://example.com:27017/oak
</pre></div></div>
<p>Please note that unlocking an upgrade is only possible when all cluster nodes are inactive, otherwise the command will refuse to change the format version.</p>
<p>See also detailed instructions for various <a href="document/upgrade.html">upgrade</a> paths.</p></div>
<div class="section">
<h2><a name="Secondary_Store"></a><a name="secondary-store"></a> Secondary Store</h2>
<p><tt>@since Oak 1.6</tt></p>
<p>Refer to <a href="document/secondary-store.html">Secondary Store</a></p></div>
<div class="section">
<h2><a name="Revision_Garbage_Collection"></a><a name="revision-gc"></a> Revision Garbage Collection</h2>
<p>As described in the section <a href="#node-content-model">Node Content Model</a>, the DocumentNodeStore does not overwrite existing data but adds it to an existing document when a property is updated. Cleaning up old data, which is not needed anymore is done with a process called <tt>Revision Garbage Collection</tt>. Depending on deployment this process does not run automatically and must be triggered periodically by the application. The garbage collection process adds some pressure on the system, so the application should trigger it when it is most convenient. E.g. at night, when systems are usually not that busy. It is usually sufficient to run it once a day. There are several ways how the revision garbage collection can be triggered:</p>

<ul>
  
<li>Call <tt>startRevisionGC()</tt> on the <a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/api/jmx/RepositoryManagementMBean.html">RepositoryManagementMBean</a></li>
  
<li>Call <a class="externalLink" href="http://jackrabbit.apache.org/oak/docs/apidocs/org/apache/jackrabbit/oak/plugins/document/VersionGarbageCollector.html#gc-long-java.util.concurrent.TimeUnit-">gc()</a> on the <tt>VersionGarbageCollector</tt> obtained from the <tt>DocumentNodeStore</tt> instance</li>
  
<li>Use the oak-run runnable jar file with the <tt>revisions</tt> run mode (<tt>@since Oak 1.8</tt>).</li>
</ul>
<p>The first two options are not described in more detail, because both of them are simple method calls. The third option comes with some sub commands as described below when oak-run with the <tt>revisions</tt> run mode is invoked without parameters or options:</p>

<div class="source">
<div class="source"><pre class="prettyprint">revisions mongodb://host:port/database &lt;sub-command&gt; [options]
where sub-command is one of
  info     give information about the revisions state without performing
           any modifications
  collect  perform garbage collection
  reset    clear all persisted metadata
  sweep    clean up uncommitted changes

Option                 Description
------                 -----------
-?, -h, --help         show help
--cacheSize &lt;Integer&gt;  cache size (default: 0)
--clusterId &lt;Integer&gt;  MongoMK clusterId (default: 0)
--continuous           run continuously (collect only)
--delay &lt;Double&gt;       introduce delays to reduce impact on
                         system (default: 0.0)
--disableBranches      disable branches
--limit &lt;Integer&gt;      collect at most limit documents
                         (default: -1)
--olderThan &lt;Long&gt;     collect only docs older than n seconds
                         (default: 86400)
--once                 only 1 iteration
--rdbjdbcpasswd        RDB JDBC password (default: )
--rdbjdbcuser          RDB JDBC user (default: )
--timeLimit &lt;Long&gt;     cancel garbage collection after n
                         seconds (default: -1)
--verbose              print INFO messages to the console
</pre></div></div>
<p>A revision garbage collection can be invoked while the system is online and running. Using the oak-run runnable jar, a revision GC on a system using the MongoDB backend can be initiated with:</p>

<div class="source">
<div class="source"><pre class="prettyprint">java -jar oak-run-1.8.0.jar revisions mongodb://localhost:27017/oak collect
</pre></div></div>
<p>This will collect changes identified as garbage, which is older than 24 hours.</p>
<p>Starting with Oak 1.8 the DocumentNodeStoreService can trigger Revision Garbage Collection (RGC) automatically. The default schedule depends on the type of backend. On RDB the service will not schedule a RGC, which is the same behavior as in previous Oak versions. Whereas on MongoDB the RGC runs every five seconds. The latter is also known as <tt>Continuous Revision Garbage Collection</tt>. In this mode, the RGC will not log every run but only write an INFO message every hour summarizing the GC cycles for the past hour. For more details, see also the <a href="../osgi_config.html#document-node-store">OSGi configuration</a> page. </p></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2018
<a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.</p>
        </div>
                          <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/jackrabbit-oak/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
    </body>
</html>
